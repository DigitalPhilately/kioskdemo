<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kiosk Journey Prototype ‚Äì Prohibited ‚Üí Restricted ‚Üí Cover Limits</title>

  <!-- Google Material Symbols -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6fb;
      --surface:#ffffff;
      --panel:#eef2fb;
      --text:#1e2230;
      --muted:#5b6478;
      --accent:#5b4c8a;
      --accent2:#7a68b6;
      --border:#d7ddea;
      --danger:#c62828;
      --warn:#b15c00;
      --ok:#2e7d32;
      --shadow: 0 8px 18px rgba(19,33,68,.10);
      --radius: 14px;
      --tile-h: 104px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .app{max-width:1100px;margin:0 auto;padding:22px;}
    .chrome{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px;border-bottom:1px solid var(--border);background:#fff;
    }
    .left,.right{display:flex;gap:10px;align-items:center;}
    .btn{
      border:1px solid var(--border);
      background:#fff;color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;font-weight:700;
      display:inline-flex;align-items:center;gap:8px;user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;}
    .btn.ghost{background:transparent;border-color:transparent;color:var(--accent);}
    .btn.danger{background:#fff;border-color:#f0b8b8;color:var(--danger);}
    .btn.warn{background:#fff;border-color:#ffd6a5;color:var(--warn);}
    .material-symbols-outlined{
      font-variation-settings:"FILL" 0,"wght" 600,"GRAD" 0,"opsz" 24;
      font-size:20px;line-height:1;
    }
    .content{
      padding:20px;
      background:linear-gradient(#ffffff,#f6f7fd);
      min-height:640px;
      position:relative;
    }
    h1{margin:4px 0 4px;font-size:34px;letter-spacing:.2px;color:#2a2550;}
    .subtitle{color:var(--muted);margin:0 0 16px;font-size:16px;}
    .stepHeader{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:14px;}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 12px;border-radius:999px;border:1px solid var(--border);
      background:var(--panel);color:#2b2a44;font-weight:800;font-size:13px;
    }
    .gridWrap{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      position:relative;
    }
    .grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px;}
    .tile{
      min-height:var(--tile-h);
      height:auto;
      border:1px solid var(--border);
      background:#fff;border-radius:14px;
      display:flex;align-items:flex-start;gap:12px;
      padding:12px;cursor:pointer;
      box-shadow:0 2px 0 rgba(0,0,0,.02);
      text-align:left;
    }
    .tile:hover{border-color:#c8cfe2}
    .tile .icon{
      width:56px;height:56px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      background:#f1effa;color:var(--accent);flex:0 0 auto;
      overflow:hidden;
    }
    .tile .icon .material-symbols-outlined{
      font-size:30px;
      display:block;
      max-width:1em;
      overflow:hidden;
      white-space:nowrap;
    }
    .tile .label{font-weight:900;font-size:13px;line-height:1.2;overflow-wrap:anywhere;word-break:break-word;}
    .tile.selected{border-color:var(--accent2);box-shadow:0 0 0 3px rgba(122,104,182,.18);}
    .details{
      margin-top:0;border:1px solid var(--border);
      background:#fff;border-radius:16px;padding:14px;display:none;
      position:absolute;left:14px;right:14px;top:14px;z-index:30;
      box-shadow:var(--shadow);
    }
    .details.show{display:block;}
    .detailsTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;}
    .detailsTitle{display:flex;gap:10px;align-items:center;font-weight:900;color:#2a2550;}
    .detailsTitle .icon{
      width:36px;height:36px;border-radius:12px;background:#f1effa;
      display:flex;align-items:center;justify-content:center;color:var(--accent);
      overflow:hidden;
    }
    .detailsTitle .icon .material-symbols-outlined{
      font-size:22px;
      display:block;
      max-width:1em;
      overflow:hidden;
      white-space:nowrap;
    }
    .detailsText{margin-top:10px;color:#293047;line-height:1.35;}
    .banner{
      margin-top:10px;padding:10px 12px;border-radius:12px;
      font-weight:800;display:none;
    }
    .banner.show{display:block;}
    .banner.danger{border:1px solid #f0b8b8;background:#fff6f6;color:#8b1f1f;}
    .banner.warn{border:1px solid #ffd6a5;background:#fff8ee;color:#7a3f00;}
    .banner.ok{border:1px solid #c7e7cb;background:#f3fff5;color:#1f5f27;}

    .formRow{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px;}
    .card{border:1px solid var(--border);background:#fff;border-radius:16px;padding:14px;}
    .card h3{margin:0 0 6px;font-size:16px;color:#2a2550}
    .card p{margin:0 0 10px;color:var(--muted);font-size:13px}
    .choiceGroup{display:grid;gap:10px}
    .choiceRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .choiceRow3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .choiceBtn{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      border-radius:12px;
      padding:12px 10px;
      text-align:center;
      cursor:pointer;
      font-weight:900;
      min-height:62px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
    }
    .choiceBtn .sub{font-size:12px;color:var(--muted);font-weight:700}
    .choiceBtn span{overflow-wrap:anywhere;word-break:break-word;line-height:1.2}
    .choiceBtn.active{
      border-color:var(--accent2);
      box-shadow:0 0 0 3px rgba(122,104,182,.18);
      background:#fbf9ff;
    }
    input,select{
      width:100%;padding:10px 12px;border:1px solid var(--border);
      border-radius:12px;font-size:14px;outline:none;
    }
    input:focus,select:focus{border-color:#b7bfe0;box-shadow:0 0 0 3px rgba(122,104,182,.12)}
    .helpNote{
      margin-top:10px;padding:10px 12px;border-left:4px solid var(--accent2);
      background:#f7f6ff;border-radius:12px;color:#3a365a;
      font-size:13px;line-height:1.35;
    }
    .bottombar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:16px;border-top:1px solid var(--border);background:#fff;
    }
    .progress{color:var(--muted);font-weight:800;font-size:13px;}
    .tag{
      display:inline-flex;gap:6px;align-items:center;
      padding:7px 10px;border-radius:999px;border:1px solid var(--border);
      background:#fff;font-weight:800;color:#2a2550;margin-right:8px;margin-bottom:8px;
      font-size:13px;
    }
    .summary{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px;}
    @media (max-width: 980px){
      .grid{grid-template-columns:repeat(5,minmax(0,1fr));gap:8px;}
      .formRow{grid-template-columns:1fr;}
      .summary{grid-template-columns:1fr;}
      .choiceRow3{grid-template-columns:1fr;}
      .tile{padding:10px;}
      .tile .icon{width:46px;height:46px;border-radius:12px;}
      .tile .icon .material-symbols-outlined{font-size:24px;}
      .tile .label{font-size:12px;}
      :root{--tile-h: 90px;}
    }
  </style>
</head>

<body>
<div class="app">
  <div class="chrome">
    <div class="topbar">
      <div class="left">
        <button class="btn" id="backBtn"><span class="material-symbols-outlined">arrow_back</span>Go Back</button>
        <button class="btn ghost" id="resetBtn"><span class="material-symbols-outlined">restart_alt</span>Reset</button>
      </div>
      <div class="right">
        <span class="pill" id="destPill">
          <span class="material-symbols-outlined">public</span>
          Destination: <span id="destLabel">Not set</span>
        </span>
        <button class="btn" id="helpBtn">Help <span class="material-symbols-outlined">help</span></button>
      </div>
    </div>

    <div class="content" id="screen"></div>

    <div class="bottombar">
      <button class="btn danger" id="cancelBtn"><span class="material-symbols-outlined">close</span>Cancel</button>
      <div class="progress" id="progress">Step 1 of 8</div>
      <button class="btn primary" id="nextBtn">Continue <span class="material-symbols-outlined">arrow_forward</span></button>
    </div>
  </div>
</div>

<script>
/* ---------------------------
   State
---------------------------- */
const state = {
  step: 1,                // 1..8
  weightG: "",
  format: "",
  destination: "",
  productProfile: "evri_dpd",
  quickDemoMode: false,
  prohibitedKey: null,    // if set -> hard stop message
  prohibitedOtherSelected: false,
  rmSelectedKey: null,
  rmBlockedKey: null,
  rmOtherSelected: false,
  rmAdvisoryKeys: new Set(),
  restrictedKeys: new Set(),
  coverLossOnlyKeys: new Set(),
  coverNoCompKeys: new Set(),
  formatConfirmed: false,
  declaredValue: "",
  contentDescription: "",
  deliverySpeed: "balanced",
  recipientPostcode: "",
  recipientAddress: "",
  senderPostcode: "",
  senderAddress: "",
  niCustomsConfirmed: false,
  niCustomsReference: "",
  proofOfDelivery: false,
  selectedServiceId: "",
  basketAdded: false,
  paymentMethod: "",
  paymentComplete: false,
  labelsPrinted: false,
  transactionRef: "",
};

/* ---------------------------
   Data lists (your updated content)
   - Prohibited: hard stop
   - Restricted: allow with conditions (placeholder scaffold)
   - Cover limits: Loss-only + No-comp (as provided)
---------------------------- */

// PROHIBITED (hard stop)
const PROHIBITED = [
  { key:"animals", label:"Animals / organisms", icon:"pets",
    details:"Animals or organisms of any form cannot be carried on any service." },

  { key:"food_all", label:"Food (any type)", icon:"restaurant",
    details:"Food items of any type cannot be carried, including non-perishable food." },

  { key:"perishables", label:"Perishables", icon:"emoji_nature",
    details:"Any perishable goods or perishable food cannot be carried on any service." },

  { key:"batteries", label:"Batteries (incl. built-in)", icon:"battery_alert",
    details:"Batteries and items containing built-in batteries cannot be carried on any service." },

  { key:"bio_samples", label:"Biological samples", icon:"science",
    details:"Biological samples cannot be carried on any service." },

  { key:"cylinders", label:"Compressed air / cylinders", icon:"propane_tank",
    details:"Compressed air and empty cylinders cannot be carried on any service." },

  { key:"drugs_tobacco", label:"Drugs / meds / tobacco", icon:"medical_services",
    details:"Drugs, medication, prescriptions, tobacco, and tobacco products cannot be carried on any service." },

  { key:"hazardous", label:"Hazardous goods", icon:"warning",
    details:"Hazardous goods cannot be carried, including aerosol, asbestos, ashes, detergents, resin, explosives, filth, fire extinguishers, fireworks, gas, dry ice, items containing alcohol, and flammable or explosive substances." },

  { key:"illegal", label:"Illegal / counterfeit", icon:"gavel",
    details:"Illegal goods cannot be carried, including counterfeit goods, counterfeit currency, and any items considered illegal in either the exporting or importing country." },

  { key:"liquids_gels", label:"Liquids / creams / gels", icon:"water_drop",
    details:"Liquids, creams, oils, wax, or gels cannot be carried on any service." },

  { key:"medical_equipment", label:"Medical equipment", icon:"medical_information",
    details:"Medical equipment cannot be carried on any service." },

  { key:"money_docs", label:"Money / financial docs", icon:"payments",
    details:"Monetary and currency items cannot be carried, including cash, credit cards, debit cards, coins, cheques, vouchers, tickets, lottery tickets, stamps (unless franked), and financial documents." },

  { key:"poisons", label:"Poisons / pesticides", icon:"pest_control",
    details:"Poisonous or toxic liquids, solids, and gases cannot be carried, including pesticides." },

  { key:"radioactive", label:"Radioactive materials", icon:"dangerous",
    details:"Radioactive materials cannot be carried on any service." },

  { key:"vehicle_parts_large", label:"Vehicle parts (large)", icon:"directions_car",
    details:"Large vehicle parts cannot be carried, including vehicle panels, spoilers, doors, bonnets, bumpers, carbon fibre, engines, any car parts containing oil or liquids, airbags, steering wheels containing airbags, and seatbelt tensioners." },

  { key:"weapons", label:"Weapons / blades", icon:"dangerous",
    details:"Weapons cannot be carried, including replicas, ammunition, axes, blades, chainsaws, guns, and knives." },

  { key:"white_goods", label:"White goods", icon:"kitchen",
    details:"White goods cannot be carried, including fridges, ovens, freezers, cooker hoods, hobs, boilers, washing machines, and hot tubs." },

  { key:"geochron", label:"Geochron", icon:"public",
    details:"Geochron items cannot be carried on any service." },
];

// RESTRICTED (allowed with conditions) ‚Äî placeholders (swap with your real restricted catalogue)
const RESTRICTED = [
  { key:"lithium_in_device", label:"Device with built-in lithium battery", icon:"battery_alert",
    details:"Lithium batteries cannot be sent loose or spare. They are only accepted when installed in the device and packed to prevent damage or accidental activation." },

  { key:"aerosols_personal", label:"Personal aerosols", icon:"air",
    details:"Some aerosols may be allowable if within quantity limits and packed to prevent leakage/activation." },

  { key:"cosmetics", label:"Cosmetics", icon:"spa",
    details:"Some cosmetics may be allowable if non-flammable and packed to prevent leakage." },

  { key:"liquids_small", label:"Liquids (small volumes)", icon:"water_drop",
    details:"Some liquids may be allowable if under limits and packed with leak-proof inner packaging and absorbent material." },

  { key:"perfume_small", label:"Perfume / aftershave", icon:"sanitizer",
    details:"Perfume may be allowable only under specific limits and packaging rules. Check destination restrictions." },
];

// ROYAL MAIL DANGEROUS GOODS FILTER (from RM leaflet valid from May 2025)
const RM_FILTER = [
  { key:"rm_aerosol_toiletry", label:"Toiletry/medicinal aerosols", icon:"air", uk:true, intl:false,
    details:"Allowed UK only with restrictions: max 500ml per item, max two items per parcel, counter presentation, sender name and address visible." },
  { key:"rm_alcohol_24_70", label:"Alcohol 24% to 70% ABV", icon:"liquor", uk:true, intl:false,
    details:"Allowed UK only with restrictions: max 1 litre per item, max two items per parcel, wrapped and cushioned, counter presentation." },
  { key:"rm_alcohol_upto24", label:"Alcohol up to 24% ABV", icon:"wine_bar", uk:true, intl:true,
    details:"Allowed UK and International with restrictions: max 1 litre per item, wrapped and cushioned, mark FRAGILE when glass." },
  { key:"rm_perfume", label:"Perfume / aftershave", icon:"spa", uk:true, intl:false,
    details:"Allowed UK only with restrictions: max 150ml per item, max four items per parcel, original retail packaging, counter presentation." },
  { key:"rm_nail_varnish", label:"Nail varnish / polish / gel", icon:"brush", uk:true, intl:false,
    details:"Allowed UK only with restrictions: max 30ml per item, max four items per parcel, strong outer packaging, counter presentation." },
  { key:"rm_lithium_connected", label:"Device with connected lithium battery", icon:"battery_alert", uk:true, intl:true,
    details:"Allowed UK and International with restrictions. Battery limits apply and item must be packed to prevent accidental activation." },
  { key:"rm_lithium_not_connected", label:"Lithium batteries not connected", icon:"battery_unknown", uk:true, intl:false,
    details:"Allowed UK only with restrictions. Applies where batteries are sent with a device but not connected." },
  { key:"rm_sharp_pointed", label:"Sharp or pointed items", icon:"content_cut", uk:true, intl:true,
    details:"Allowed UK and International if safely packaged so points and edges cannot pierce packaging." },
  { key:"rm_prescription_non_toxic", label:"Prescription medicine (non-toxic/non-flammable)", icon:"medication", uk:true, intl:true,
    details:"Allowed UK and International with quantity and packaging limits." },
  { key:"rm_perishables", label:"Perishables", icon:"eco", uk:true, intl:false,
    details:"Royal Mail allows UK only. Additional prohibitions apply for certain NI movements." },
  { key:"rm_batteries_dangerous_used", label:"Dangerous/used batteries", icon:"battery_0_bar", uk:false, intl:false,
    details:"Not allowed UK or International (includes car batteries, solo lithium batteries, power banks, and damaged batteries)." },
  { key:"rm_flammables_explosives", label:"Flammables / explosives", icon:"local_fire_department", uk:false, intl:false,
    details:"Not allowed UK or International (includes flammable liquids/solids, spray paints, fireworks, matches, solvent paints)." },
  { key:"rm_weapons", label:"Weapons", icon:"gpp_bad", uk:false, intl:false,
    details:"Not allowed UK or International." },
  { key:"rm_gases", label:"Gases and cylinders", icon:"propane_tank", uk:false, intl:false,
    details:"Not allowed UK or International (includes gas canisters, refills, fire extinguishers, scuba tanks)." },
  { key:"rm_poisons_radioactive", label:"Poisons / radioactive", icon:"warning", uk:false, intl:false,
    details:"Not allowed UK or International." },
];

const RM_ADVISORY = [
  { key:"rmc_counter", label:"Counter presentation required", icon:"storefront",
    details:"Certain restricted items (for example aerosols, perfumes, and nail products) must be presented at the Post Office counter." },
  { key:"rmc_sender_details", label:"Sender details required", icon:"badge",
    details:"Sender name and return address must be clearly visible on parcels for certain restricted dangerous goods." },
  { key:"rmc_quantity_limits", label:"Quantity limits apply", icon:"rule",
    details:"Royal Mail applies per-item and per-parcel limits for many restricted items. Check limits before acceptance." },
  { key:"rmc_packaging", label:"Specific packaging required", icon:"inventory_2",
    details:"Restricted items must be tightly packed in strong outer packaging with leak/sift protection where applicable." },
  { key:"rmc_battery_limits", label:"Lithium battery limits", icon:"battery_charging_full",
    details:"Lithium cells and batteries must meet Wh/g limits, be protected from short-circuit, and be secured against movement." },
  { key:"rmc_country_rules", label:"Destination rules vary", icon:"public",
    details:"Some categories are UK-only. International acceptance depends on destination and current Royal Mail rules." },
];

// COVER LIMITS: Loss-only (refund if lost, not damage)
const LOSS_ONLY = [
  { key:"antiques", label:"Antiques (100+ yrs)", icon:"museum",
    details:"Not protected for damage. If lost in the carrier network, carriage and item value can be refunded when parcel protection is in place." },

  { key:"wood_flooring", label:"Wooden flooring", icon:"grid_on",
    details:"Any type of wooden flooring, including laminate, is not protected for damage. If lost, carriage and item value can be refunded when parcel protection is in place." },

  { key:"coffee_machines", label:"Coffee machines", icon:"coffee_maker",
    details:"Coffee machines, coffee grinders, and coffee roasters are not protected for damage. If lost, carriage and item value can be refunded when parcel protection is in place." },

  { key:"cycles", label:"Cycles", icon:"pedal_bike",
    details:"Cycles, bicycles, unicycles, and tricycles are not protected for damage. Maximum parcel protection value for loss is GBP 1,000." },

  { key:"electrical_appliances", label:"Electrical appliances", icon:"devices",
    details:"Electrical appliances that are not white goods are not protected for damage, including cameras, monitors, computers, all-in-one computers, drones, lamps, laptops, scanners, TVs, and projectors." },

  { key:"fishing_rods", label:"Fishing rods", icon:"sports_and_outdoors",
    details:"Fishing rods are not protected for damage. If lost, carriage and item value can be refunded when parcel protection is in place." },

  { key:"furniture", label:"Furniture", icon:"weekend",
    details:"Furniture is not protected for damage. If lost, carriage and item value can be refunded when parcel protection is in place." },

  { key:"sewing_knitting", label:"Sewing/knitting machines", icon:"precision_manufacturing",
    details:"Knitting machines and sewing machines are not protected for damage. If lost, carriage and item value can be refunded when parcel protection is in place." },

  { key:"models_kits", label:"Models / kits", icon:"view_in_ar",
    details:"Models and kits are not protected for damage. If lost, carriage and item value can be refunded when parcel protection is in place." },

  { key:"musical_instruments", label:"Musical instruments", icon:"music_note",
    details:"Musical instruments, including guitars, amplifiers, speakers, turntables, violins, and keyboards, are not protected for damage. Items must be sent in a hard case and boxed. Maximum parcel protection value for loss is GBP 1,000." },

  { key:"suitcase_packaging", label:"Suitcase as packaging", icon:"luggage",
    details:"A suitcase is not protected if it is used as packaging for internal items." },

  { key:"surfboard", label:"Surfboard", icon:"surfing",
    details:"Surfboards are not protected for damage. If lost, carriage and item value can be refunded when parcel protection is in place." },

  { key:"telescopes", label:"Telescopes/microscopes", icon:"biotech",
    details:"Telescopes and microscopes are not protected for damage. If lost, carriage and item value can be refunded when parcel protection is in place." },

  { key:"wall_decor", label:"Wall d√©cor / frames", icon:"photo_frame",
    details:"Wall decor items are not protected for damage, including canvas prints, clocks, framed pictures, pictures, posters, prints, and paintings." },
];

// COVER LIMITS: No compensation (sender‚Äôs risk)
const NO_COMP = [
  { key:"ceramics_stone", label:"Ceramics / stone", icon:"category",
    details:"No compensation: ceramics, porcelain, china, and stone items, including tiles, sinks, basins, toilets, baths, concrete, crockery, granite, marble, vases, pottery, and plates." },

  { key:"glass", label:"Glass items", icon:"wine_bar",
    details:"No compensation: glass items of any type, including glassware, crystal, bulbs, screens, fiberglass, fish tanks, mirrors, spectacles, windows, and perspex." },

  { key:"packaging", label:"Packaging", icon:"inventory_2",
    details:"No compensation: packaging items, including the box, media packaging, and suitcases used as packaging." },

  { key:"precious_metals", label:"Precious metals / gems", icon:"diamond",
    details:"No compensation: precious metals and stones, including gold, silver, gems, and diamonds, including in jewellery form." },

  { key:"small_vehicle_parts", label:"Small vehicle parts", icon:"build",
    details:"No compensation: small vehicle parts, including headlights, taillights, and gearboxes." },

  { key:"watches", label:"Watches", icon:"watch",
    details:"No compensation: watches are carried at sender risk." },
];

// SERVICE CATALOGUE (demo only)
const SERVICES = [
  { id:"evri_standard", profile:"evri_dpd", name:"EVRi Standard", speed:"balanced", tracked:true, intl:false, maxWeight:15000, basePrice:3.69 },
  { id:"dpd_next_day", profile:"evri_dpd", name:"DPD Next Day", speed:"fast", tracked:true, intl:false, maxWeight:20000, basePrice:6.99 },
  { id:"dpd_classic", profile:"evri_dpd", name:"DPD Classic", speed:"balanced", tracked:true, intl:false, maxWeight:30000, basePrice:5.49 },
  { id:"evri_international", profile:"evri_dpd", name:"EVRi International", speed:"balanced", tracked:true, intl:true, maxWeight:10000, basePrice:9.99 },
  { id:"rm_2nd_class", profile:"royal_mail", name:"Royal Mail 2nd Class", speed:"balanced", tracked:false, intl:false, maxWeight:20000, basePrice:3.39 },
  { id:"rm_1st_class", profile:"royal_mail", name:"Royal Mail 1st Class", speed:"fast", tracked:false, intl:false, maxWeight:20000, basePrice:4.59 },
  { id:"rm_tracked_48", profile:"royal_mail", name:"RM Tracked 48", speed:"balanced", tracked:true, intl:false, maxWeight:20000, basePrice:4.99 },
  { id:"rm_tracked_24", profile:"royal_mail", name:"RM Tracked 24", speed:"fast", tracked:true, intl:false, maxWeight:20000, basePrice:6.29 },
  { id:"rm_international_tracked", profile:"royal_mail", name:"RM International Tracked", speed:"balanced", tracked:true, intl:true, maxWeight:2000, basePrice:11.99 },
];

/* ---------------------------
   Helpers
---------------------------- */
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function padTo25(list){
  const out = [...list];
  while(out.length < 25){
    out.push({ key:`_blank_${out.length}`, label:"", icon:"block", details:"", blank:true });
  }
  return out.slice(0,25);
}
function setDestinationPill(){
  const destLabel = document.getElementById("destLabel");
  const pill = document.getElementById("destPill");
  if(!state.destination){
    destLabel.textContent = "Not set";
    pill.style.opacity = 0.75;
    return;
  }
  pill.style.opacity = 1;
  destLabel.textContent = state.destination === "uk" ? "UK" : "International";
}

function isBTPostcode(value){
  return /^BT/i.test((value || "").trim());
}

function numericValue(value){
  const parsed = Number.parseFloat(value);
  return Number.isFinite(parsed) ? parsed : 0;
}

function selectedService(){
  return SERVICES.find(s => s.id === state.selectedServiceId) || null;
}

function calculateServicePrice(service){
  const weight = Number.parseInt(state.weightG || "0", 10) || 0;
  const weightAdd = weight > 2000 ? Math.ceil((weight - 2000) / 1000) * 0.35 : 0;
  return Number((service.basePrice + weightAdd).toFixed(2));
}

function availableServices(){
  const weight = Number.parseInt(state.weightG || "0", 10) || 0;
  const isIntl = state.destination === "intl";
  const needsTracked = state.productProfile === "evri_dpd" && state.restrictedKeys.size > 0;

  let list = SERVICES.filter(s => s.profile === state.productProfile);
  list = list.filter(s => s.maxWeight >= weight);
  list = list.filter(s => isIntl ? s.intl : true);
  if(!isIntl) list = list.filter(s => s.intl ? false : true);

  if(state.deliverySpeed === "fast"){
    list = list.filter(s => s.speed === "fast");
  } else if(state.deliverySpeed === "tracked"){
    list = list.filter(s => s.tracked);
  }
  if(needsTracked){
    list = list.filter(s => s.tracked);
  }

  // Prioritise tracked services in display order (mirrors KIOSK-415 intent).
  return list.sort((a,b) => Number(b.tracked) - Number(a.tracked) || calculateServicePrice(a) - calculateServicePrice(b));
}

function basketTotal(){
  const service = selectedService();
  if(!service) return 0;
  const base = calculateServicePrice(service);
  const pod = state.proofOfDelivery ? 1.5 : 0;
  return Number((base + pod).toFixed(2));
}

function applyQuickDemoDefaults(){
  if(!state.quickDemoMode) return;

  if(!state.weightG) state.weightG = "850";
  if(!state.destination) state.destination = "uk";
  if(!state.format) state.format = "parcel";
  if(!state.productProfile) state.productProfile = "royal_mail";

  if(state.productProfile === "royal_mail"){
    if(!state.rmSelectedKey){
      state.rmSelectedKey = "rm_other_not_listed";
      state.rmOtherSelected = true;
      state.rmBlockedKey = null;
    }
  } else if(!state.prohibitedOtherSelected && !state.prohibitedKey){
    state.prohibitedOtherSelected = true;
  }

  if(state.format && !state.formatConfirmed) state.formatConfirmed = true;
  if(!state.declaredValue) state.declaredValue = "39.99";
  if(!state.contentDescription) state.contentDescription = "Books and stationery";
  if(!state.deliverySpeed) state.deliverySpeed = "balanced";
  if(!state.recipientPostcode) state.recipientPostcode = "BT1 5GS";
  if(!state.recipientAddress) state.recipientAddress = "1 Royal Avenue, Belfast";
  if(!state.senderPostcode) state.senderPostcode = "EC1A 1AA";
  if(!state.senderAddress) state.senderAddress = "185 Farringdon Road, London";
  if(state.destination === "uk" && isBTPostcode(state.recipientPostcode)){
    if(!state.niCustomsReference) state.niCustomsReference = "NI-EXAMPLE-001";
    state.niCustomsConfirmed = true;
  }
  state.proofOfDelivery = true;

  const options = availableServices();
  if(options.length && !options.some(s=>s.id===state.selectedServiceId)){
    state.selectedServiceId = options[0].id;
  }

  if(!state.paymentMethod) state.paymentMethod = "card";
  state.paymentComplete = true;
  if(!state.transactionRef){
    state.transactionRef = "TX-DEMO01";
  }
}

/* ---------------------------
   Rendering
---------------------------- */
const screen = document.getElementById("screen");
const progress = document.getElementById("progress");
const nextBtn = document.getElementById("nextBtn");
const backBtn = document.getElementById("backBtn");
const resetBtn = document.getElementById("resetBtn");
const cancelBtn = document.getElementById("cancelBtn");
const helpBtn = document.getElementById("helpBtn");

function stepCount(){ return 8; }

function updateProgress(){
  progress.textContent = `Step ${state.step} of ${stepCount()}`;
  backBtn.disabled = (state.step === 1);
}

function render(){
  applyQuickDemoDefaults();
  setDestinationPill();
  updateProgress();

  if(state.step === 1) renderWeigh();
  else if(state.step === 2) {
    if(state.productProfile === "royal_mail") renderRMDangerous();
    else renderProhibited();
  }
  else if(state.step === 3) {
    if(state.productProfile === "royal_mail") renderRMConditions();
    else renderPolicyChecks();
  }
  else if(state.step === 4) renderCaptureItemDetails();
  else if(state.step === 5) renderDeclareValueAndContent();
  else if(state.step === 6) renderFilterAndPresentOptions();
  else if(state.step === 7) renderBasketAndPay();
  else renderPrintAndConfirm();

  if(state.step === 8){
    nextBtn.innerHTML = `Start new transaction <span class="material-symbols-outlined">restart_alt</span>`;
  } else if(state.step === 7){
    nextBtn.innerHTML = `Proceed to print <span class="material-symbols-outlined">arrow_forward</span>`;
  } else if(state.step === 6){
    nextBtn.innerHTML = `Add to basket <span class="material-symbols-outlined">add_shopping_cart</span>`;
  } else if(state.step === 5){
    nextBtn.innerHTML = `Filter services <span class="material-symbols-outlined">filter_list</span>`;
  } else {
    nextBtn.innerHTML = `Continue <span class="material-symbols-outlined">arrow_forward</span>`;
  }
}

function renderWeigh(){
  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Launch Postage Journey (KIOSK-401)</h1>
        <p class="subtitle">Capture item-on-scales details and journey context before dangerous goods screening.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">scale</span> Item On Scales (KIOSK-404)</span>
    </div>

    <div class="formRow">
      <div class="card">
        <h3>Capture weight (KIOSK-404)</h3>
        <p>In production this is captured automatically from scales.</p>
        <input id="weightInput" inputmode="numeric" placeholder="e.g. 350" value="${escapeHtml(state.weightG)}" />
        <div class="helpNote">Next: screen for prohibited or restricted items (KIOSK-409).</div>
      </div>
      <div class="card">
        <h3>Journey setup</h3>
        <p>Set destination, format classification, and product family.</p>
        <div class="choiceGroup">
          <div class="choiceRow" id="destChoices">
            <button type="button" class="choiceBtn ${state.destination==="uk"?"active":""}" data-value="uk">
              <span>üá¨üáß UK</span>
              <span class="sub">Inland</span>
            </button>
            <button type="button" class="choiceBtn ${state.destination==="intl"?"active":""}" data-value="intl">
              <span>üåç International</span>
              <span class="sub">Overseas</span>
            </button>
          </div>
        </div>
        <p style="margin:10px 0 8px;color:var(--muted);font-size:13px;">What size is your item?</p>
        <div class="choiceRow3" id="formatChoices">
          <button type="button" class="choiceBtn ${state.format==="letter"?"active":""}" data-value="letter">
            <span>Letter</span>
          </button>
          <button type="button" class="choiceBtn ${state.format==="large_letter"?"active":""}" data-value="large_letter">
            <span>Large Letter</span>
          </button>
          <button type="button" class="choiceBtn ${state.format==="parcel"?"active":""}" data-value="parcel">
            <span>Parcel</span>
          </button>
        </div>
        <div class="helpNote">Destination determines restricted and prohibited rules.</div>
        <p style="margin:12px 0 8px;color:var(--muted);font-size:13px;">Which product family are you checking?</p>
        <div class="choiceRow" id="profileChoices">
          <button type="button" class="choiceBtn ${state.productProfile==="evri_dpd"?"active":""}" data-value="evri_dpd">
            <span>EVRi / DPD</span>
          </button>
          <button type="button" class="choiceBtn ${state.productProfile==="royal_mail"?"active":""}" data-value="royal_mail">
            <span>Royal Mail</span>
          </button>
        </div>
        <label style="display:flex;gap:8px;align-items:flex-start;margin-top:12px;font-weight:700;">
          <input type="checkbox" id="quickDemoToggle" ${state.quickDemoMode ? "checked" : ""}/>
          <span>Demo fast-track mode: auto-fill example values on every stage so the journey can be completed by clicking Continue only.</span>
        </label>
      </div>
    </div>
  `;
  document.getElementById("weightInput").addEventListener("input", (e)=> {
    state.weightG = e.target.value.replace(/[^\d]/g,"").slice(0,6);
    e.target.value = state.weightG;
    state.selectedServiceId = "";
  });
  document.querySelectorAll("#destChoices .choiceBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.destination = btn.dataset.value || "";
      state.selectedServiceId = "";
      state.niCustomsConfirmed = false;
      state.niCustomsReference = "";
      state.rmSelectedKey = null;
      state.rmBlockedKey = null;
      state.rmOtherSelected = false;
      document.querySelectorAll("#destChoices .choiceBtn").forEach(b=>b.classList.toggle("active", b===btn));
      setDestinationPill();
    });
  });
  document.querySelectorAll("#formatChoices .choiceBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.format = btn.dataset.value || "";
      state.formatConfirmed = false;
      state.selectedServiceId = "";
      document.querySelectorAll("#formatChoices .choiceBtn").forEach(b=>b.classList.toggle("active", b===btn));
    });
  });
  document.querySelectorAll("#profileChoices .choiceBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.productProfile = btn.dataset.value || "evri_dpd";
      state.prohibitedKey = null;
      state.prohibitedOtherSelected = false;
      state.rmSelectedKey = null;
      state.rmBlockedKey = null;
      state.rmOtherSelected = false;
      state.restrictedKeys = new Set();
      state.coverLossOnlyKeys = new Set();
      state.coverNoCompKeys = new Set();
      state.selectedServiceId = "";
      document.querySelectorAll("#profileChoices .choiceBtn").forEach(b=>b.classList.toggle("active", b===btn));
    });
  });
  document.getElementById("quickDemoToggle").addEventListener("change", (e)=>{
    state.quickDemoMode = !!e.target.checked;
    if(state.quickDemoMode){
      applyQuickDemoDefaults();
    }
    render();
  });
}

function renderProhibited(){
  // In this Option 2 prototype: Prohibited list is service-wide (as you supplied).
  // If later you need UK vs Intl variants, we can split here.
  const list = padTo25([
    ...PROHIBITED,
    {
      key:"other_not_listed",
      label:"Other / not listed",
      icon:"check_circle",
      details:"Select this if your item does not match any option above. You can then continue."
    }
  ]);

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Screen for prohibited or restricted items (KIOSK-409)</h1>
        <p class="subtitle"><strong>Check contents against prohibited categories.</strong> Select one option to continue.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">block</span> Prohibited check (KIOSK-410)</span>
    </div>

    <div class="gridWrap">
      <div class="grid" id="pGrid"></div>

      <div class="details" id="pDetails">
        <div class="detailsTop">
          <div class="detailsTitle" id="pDetailsTitle"></div>
          <button class="btn" id="pClose">
            <span class="material-symbols-outlined">close</span>Close
          </button>
        </div>
        <div class="detailsText" id="pDetailsText"></div>
        <div class="banner danger show" id="pStopBanner">
          Prohibited Items cannot be accepted
        </div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn danger" id="pStopBack">
            <span class="material-symbols-outlined">arrow_back</span>Go back
          </button>
          <button class="btn" id="pStopReset">
            <span class="material-symbols-outlined">restart_alt</span>Start over
          </button>
        </div>
      </div>

    </div>
  `;

  const grid = document.getElementById("pGrid");
  list.forEach(item => grid.appendChild(tileEl(item, "p")));

  wireProhibitedDetails(list);
}

function renderRMDangerous(){
  const list = padTo25([
    ...RM_FILTER,
    { key:"rm_other_not_listed", label:"Other / not listed", icon:"check_circle",
      details:"Select this if your item does not match any listed category." }
  ]);
  const isUK = state.destination === "uk";

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Screen for prohibited or restricted items (KIOSK-409)</h1>
        <p class="subtitle"><strong>Royal Mail dangerous goods filter.</strong> Rules shown are based on destination (${isUK ? "UK" : "International"}).</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">local_shipping</span> RM filter (KIOSK-410)</span>
    </div>

    <div class="gridWrap">
      <div class="grid" id="rmGrid"></div>

      <div class="details" id="rmDetails">
        <div class="detailsTop">
          <div class="detailsTitle" id="rmDetailsTitle"></div>
          <button class="btn" id="rmClose"><span class="material-symbols-outlined">close</span>Close</button>
        </div>
        <div class="detailsText" id="rmDetailsText"></div>
        <div class="banner" id="rmStatusBanner"></div>
      </div>
    </div>
  `;

  const grid = document.getElementById("rmGrid");
  list.forEach(item => grid.appendChild(tileEl(item, "rm")));
  wireRMDangerousDetails(list);
}

function wireRMDangerousDetails(list){
  const details = document.getElementById("rmDetails");
  const title = document.getElementById("rmDetailsTitle");
  const text = document.getElementById("rmDetailsText");
  const banner = document.getElementById("rmStatusBanner");
  const close = document.getElementById("rmClose");
  const isUK = state.destination === "uk";

  document.querySelectorAll('.tile[data-mode="rm"]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const key = btn.dataset.key;
      const item = list.find(x=>x.key===key);
      if(!item) return;

      document.querySelectorAll('.tile[data-mode="rm"]').forEach(b=>b.classList.remove("selected"));
      btn.classList.add("selected");

      if(key === "rm_other_not_listed"){
        state.rmSelectedKey = key;
        state.rmBlockedKey = null;
        state.rmOtherSelected = true;
        details.classList.remove("show");
        return;
      }

      state.rmSelectedKey = key;
      state.rmOtherSelected = false;
      const allowed = isUK ? item.uk : item.intl;
      state.rmBlockedKey = allowed ? null : key;

      title.innerHTML = `
        <div class="icon"><span class="material-symbols-outlined">${item.icon || "block"}</span></div>
        ${escapeHtml(item.label)}
      `;
      text.textContent = item.details || "";

      banner.className = "banner show";
      if(allowed){
        banner.classList.add((item.uk && item.intl) ? "ok" : "warn");
        banner.textContent = (item.uk && item.intl)
          ? "Allowed for this destination when Royal Mail packaging conditions are met."
          : "Restricted: allowed only on specific destinations/services with conditions.";
      } else {
        banner.classList.add("danger");
        banner.textContent = "Not allowed for this destination under Royal Mail dangerous goods rules.";
      }

      details.classList.add("show");
    });
  });

  close.addEventListener("click", ()=>{
    details.classList.remove("show");
    document.querySelectorAll('.tile[data-mode="rm"]').forEach(b=>b.classList.remove("selected"));
  });
}

function renderRMConditions(){
  const isUK = state.destination === "uk";
  const item = RM_FILTER.find(x => x.key === state.rmSelectedKey);
  const isOther = state.rmSelectedKey === "rm_other_not_listed";
  const allowed = isOther ? true : (item ? (isUK ? item.uk : item.intl) : true);
  const selectedLabel = isOther ? "Other / not listed" : (item ? item.label : "Other / not listed");
  const outcomeClass = allowed ? "ok" : "danger";
  const outcomeText = isOther
    ? "No dangerous goods conditions were triggered from the Royal Mail list."
    : (allowed
    ? "This category can be sent on the selected destination only when Royal Mail conditions are met."
    : "This category is not allowed for the selected destination under Royal Mail rules.");

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Handle restricted outcome (KIOSK-410)</h1>
        <p class="subtitle">Confirm handling decision before capture item details.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">gavel</span> RM handling</span>
    </div>

    <div class="formRow">
      <div class="card">
        <h3>Selected category</h3>
        <div class="helpNote"><strong>${escapeHtml(selectedLabel)}</strong></div>
        <div class="banner ${outcomeClass} show" style="display:block; margin-top:10px;">
          ${escapeHtml(outcomeText)}
        </div>
      </div>
      <div class="card">
        <h3>Before acceptance, confirm</h3>
        <div class="helpNote">${isOther
          ? "No additional dangerous goods conditions are required for this selection. Continue with normal product and service checks."
          : "1. Sender name and return address is visible.<br/>2. Item meets quantity limits for this category.<br/>3. Packaging meets Royal Mail requirements (leak/sift/impact protection as relevant).<br/>4. Counter presentation is used where required.<br/>5. Destination-specific rules are satisfied."}</div>
        <p style="margin-top:10px; color:var(--muted); font-size:12px;">Source: Royal Mail and Parcelforce prohibited/restricted items leaflet (valid from May 2025).</p>
      </div>
    </div>
  `;
}

function renderPolicyChecks(){
  const restrictedList = padTo25(RESTRICTED);
  const lossList = padTo25(LOSS_ONLY);
  const noCompList = padTo25(NO_COMP);

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Handle restricted outcome (KIOSK-410)</h1>
        <p class="subtitle">Confirm restricted and compensation context before item-detail capture.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">shield</span> Restricted handling</span>
    </div>

    <div class="card" style="margin-bottom:14px;">
      <h3>Restricted goods (allowed with conditions)</h3>
      <p>Some items are allowed only if specific conditions are met.</p>
      <div class="gridWrap">
        <div class="grid" id="rGrid"></div>
        <div class="details" id="rDetails">
          <div class="detailsTop">
            <div class="detailsTitle" id="rDetailsTitle"></div>
            <button class="btn" id="rClose"><span class="material-symbols-outlined">close</span>Close</button>
          </div>
          <div class="detailsText" id="rDetailsText"></div>
          <div class="banner warn show" style="display:block; margin-top:10px;">
            Restricted items may change service availability and packing requirements.
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-bottom:14px;">
      <h3>Items protected for loss only</h3>
      <p>The couriers can carry these items but do not protect for damage. If an item is lost in their network, carriage and item value can be refunded when parcel protection is in place.</p>
      <div class="gridWrap">
        <div class="grid" id="lossGrid"></div>
      </div>
    </div>

    <div class="card">
      <h3>No compensation items</h3>
      <p>The following items (or items similar in description or content) are carried on a no-protection basis on any service. Senders of these items do so at their own risk.</p>
      <div class="gridWrap">
        <div class="grid" id="ncGrid"></div>
      </div>
    </div>

    <div class="details" id="cDetails">
      <div class="detailsTop">
        <div class="detailsTitle" id="cDetailsTitle"></div>
        <button class="btn" id="cClose"><span class="material-symbols-outlined">close</span>Close</button>
      </div>
      <div class="detailsText" id="cDetailsText"></div>
      <div class="banner warn show" style="display:block; margin-top:10px;">
        This affects compensation eligibility. Protection may be limited or unavailable.
      </div>
    </div>
  `;

  const rGrid = document.getElementById("rGrid");
  restrictedList.forEach(item => rGrid.appendChild(tileEl(item, "r", true)));
  wireMultiSelectDetails("r", restrictedList, state.restrictedKeys);

  const lossGrid = document.getElementById("lossGrid");
  lossList.forEach(item => lossGrid.appendChild(tileEl(item, "loss", true)));
  wireMultiSelectDetails("loss", lossList, state.coverLossOnlyKeys, "c");

  const ncGrid = document.getElementById("ncGrid");
  noCompList.forEach(item => ncGrid.appendChild(tileEl(item, "nc", true)));
  wireMultiSelectDetails("nc", noCompList, state.coverNoCompKeys, "c");

  // Use the shared cover details panel (cDetails)
  document.getElementById("cClose").addEventListener("click", ()=> {
    document.getElementById("cDetails").classList.remove("show");
    document.querySelectorAll('.tile[data-mode="loss"], .tile[data-mode="nc"]').forEach(b=>b.classList.remove("selected"));
  });
  document.getElementById("rClose").addEventListener("click", ()=> {
    document.getElementById("rDetails").classList.remove("show");
    document.querySelectorAll('.tile[data-mode="r"]').forEach(b=>b.classList.remove("selected"));
  });
}

function renderCaptureItemDetails(){
  const fmt = ({letter:"Letter", large_letter:"Large letter", parcel:"Parcel"})[state.format] || "Not set";
  const dest = state.destination === "uk" ? "UK Inland" : "International";
  const profile = state.productProfile === "royal_mail" ? "Royal Mail" : "EVRi / DPD";

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Capture Item Details (KIOSK-403)</h1>
        <p class="subtitle">Confirm format classification from sidecar and lock item details before value declaration.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">inventory_2</span> Item details</span>
    </div>

    <div class="formRow">
      <div class="card">
        <h3>Item offered to format sidecar</h3>
        <div style="margin-top:10px;">
          <span class="tag"><span class="material-symbols-outlined">scale</span> ${escapeHtml(state.weightG || "‚Äî")} g</span>
          <span class="tag"><span class="material-symbols-outlined">straighten</span> ${fmt}</span>
          <span class="tag"><span class="material-symbols-outlined">public</span> ${dest}</span>
          <span class="tag"><span class="material-symbols-outlined">local_shipping</span> ${profile}</span>
        </div>
        <div class="helpNote">KIOSK-405 Confirm format classification before continuing.</div>
      </div>
      <div class="card">
        <h3>Confirm format classification</h3>
        <div class="choiceRow3" id="captureFormatChoices">
          <button type="button" class="choiceBtn ${state.format==="letter"?"active":""}" data-value="letter"><span>Letter</span></button>
          <button type="button" class="choiceBtn ${state.format==="large_letter"?"active":""}" data-value="large_letter"><span>Large Letter</span></button>
          <button type="button" class="choiceBtn ${state.format==="parcel"?"active":""}" data-value="parcel"><span>Parcel</span></button>
        </div>
        <label style="display:flex;gap:8px;align-items:flex-start;margin-top:14px;font-weight:700;">
          <input type="checkbox" id="formatConfirmed" ${state.formatConfirmed ? "checked" : ""}/>
          <span>I confirm the sidecar classification is correct.</span>
        </label>
      </div>
    </div>
  `;

  document.querySelectorAll("#captureFormatChoices .choiceBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.format = btn.dataset.value || state.format;
      state.formatConfirmed = false;
      document.querySelectorAll("#captureFormatChoices .choiceBtn").forEach(b=>b.classList.toggle("active", b===btn));
      document.getElementById("formatConfirmed").checked = false;
    });
  });
  document.getElementById("formatConfirmed").addEventListener("change", (e)=>{
    state.formatConfirmed = !!e.target.checked;
  });
}

function renderDeclareValueAndContent(){
  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Declare Item Value and Content (KIOSK-406)</h1>
        <p class="subtitle">Capture declared value and contents description before service filtering.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">payments</span> Value and content</span>
    </div>

    <div class="formRow">
      <div class="card">
        <h3>Declare item value (KIOSK-407)</h3>
        <p>Enter the replacement value in GBP.</p>
        <input id="declaredValueInput" inputmode="decimal" placeholder="e.g. 49.99" value="${escapeHtml(state.declaredValue)}" />
      </div>
      <div class="card">
        <h3>Declare contents (KIOSK-408)</h3>
        <p>Provide a plain-language description of the contents.</p>
        <input id="contentDescInput" placeholder="e.g. Two paperback books" value="${escapeHtml(state.contentDescription)}" />
        <div class="helpNote">This description is used for service filtering, customs support checks, and compensation messaging.</div>
      </div>
    </div>
  `;

  document.getElementById("declaredValueInput").addEventListener("input", (e)=>{
    let raw = (e.target.value || "").replace(/[^0-9.]/g, "");
    const firstDot = raw.indexOf(".");
    if(firstDot !== -1){
      raw = raw.slice(0, firstDot + 1) + raw.slice(firstDot + 1).replace(/\./g, "");
    }
    state.declaredValue = raw.slice(0, 10);
    e.target.value = state.declaredValue;
  });
  document.getElementById("contentDescInput").addEventListener("input", (e)=>{
    state.contentDescription = (e.target.value || "").slice(0, 120);
    e.target.value = state.contentDescription;
  });
}

function renderFilterAndPresentOptions(){
  const services = availableServices();
  const showNI = state.destination === "uk" && isBTPostcode(state.recipientPostcode);

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Filter and Present Postage Options (KIOSK-412)</h1>
        <p class="subtitle">Apply delivery preference, restrictions, and routing to present valid services.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">tune</span> Service filtering</span>
    </div>

    <div class="formRow">
      <div class="card">
        <h3>Delivery speed preference (KIOSK-427)</h3>
        <div class="choiceRow3" id="speedChoices">
          <button type="button" class="choiceBtn ${state.deliverySpeed==="balanced"?"active":""}" data-value="balanced"><span>Balanced</span></button>
          <button type="button" class="choiceBtn ${state.deliverySpeed==="fast"?"active":""}" data-value="fast"><span>Fastest</span></button>
          <button type="button" class="choiceBtn ${state.deliverySpeed==="tracked"?"active":""}" data-value="tracked"><span>Tracked only</span></button>
        </div>
        <div class="helpNote">KIOSK-413/KIOSK-415/KIOSK-428: services are pre-filtered by item data and restrictions, then tracked services are prioritised.</div>

        <h3 style="margin-top:14px;">Available services (KIOSK-414)</h3>
        <div class="choiceGroup" id="serviceChoices">
          ${services.length ? services.map(service => `
            <button type="button" class="choiceBtn ${state.selectedServiceId===service.id?"active":""}" data-service-id="${service.id}">
              <span>${escapeHtml(service.name)}</span>
              <span class="sub">${service.tracked ? "Tracked" : "Untracked"} ‚Ä¢ ¬£${calculateServicePrice(service).toFixed(2)}</span>
            </button>
          `).join("") : `
            <div class="banner danger show" style="display:block;">No services available for current filters. Adjust speed, details, or screening selections.</div>
          `}
        </div>
      </div>

      <div class="card">
        <h3>Enter address details (KIOSK-866)</h3>
        <p>Recipient details</p>
        <input id="recipientPostcodeInput" placeholder="Recipient postcode (e.g. SW1A 1AA)" value="${escapeHtml(state.recipientPostcode)}" />
        <input id="recipientAddressInput" placeholder="Recipient address line" value="${escapeHtml(state.recipientAddress)}" style="margin-top:8px;" />
        <p style="margin-top:10px;">Sender details</p>
        <input id="senderPostcodeInput" placeholder="Sender postcode" value="${escapeHtml(state.senderPostcode)}" />
        <input id="senderAddressInput" placeholder="Sender address line" value="${escapeHtml(state.senderAddress)}" style="margin-top:8px;" />

        ${showNI ? `
          <div class="helpNote" style="margin-top:12px;">
            <strong>Northern Ireland support (KIOSK-867):</strong><br/>
            BT postcode detected. Capture required customs/tariff support information before proceeding.
          </div>
          <input id="niReferenceInput" placeholder="NI contents reference" value="${escapeHtml(state.niCustomsReference)}" style="margin-top:8px;" />
          <label style="display:flex;gap:8px;align-items:flex-start;margin-top:10px;font-weight:700;">
            <input type="checkbox" id="niConfirmed" ${state.niCustomsConfirmed ? "checked" : ""}/>
            <span>I confirm NI support information has been captured.</span>
          </label>
        ` : ""}

        <label style="display:flex;gap:8px;align-items:flex-start;margin-top:12px;font-weight:700;">
          <input type="checkbox" id="proofDeliveryInput" ${state.proofOfDelivery ? "checked" : ""}/>
          <span>Offer proof of delivery optional add-on (KIOSK-416)</span>
        </label>

        ${state.productProfile === "evri_dpd" && state.coverNoCompKeys.size > 0 ? `
          <div class="banner danger show" style="display:block; margin-top:10px;">
            Compensation warning (KIOSK-795): no-compensation item category selected.
          </div>
        ` : ""}
        ${state.productProfile === "evri_dpd" && state.coverLossOnlyKeys.size > 0 ? `
          <div class="banner warn show" style="display:block; margin-top:10px;">
            Compensation warning (KIOSK-795): item protected for loss only.
          </div>
        ` : ""}
      </div>
    </div>
  `;

  document.querySelectorAll("#speedChoices .choiceBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.deliverySpeed = btn.dataset.value || "balanced";
      const validIds = new Set(availableServices().map(s => s.id));
      if(!validIds.has(state.selectedServiceId)){
        state.selectedServiceId = "";
      }
      render();
    });
  });

  document.querySelectorAll("#serviceChoices .choiceBtn[data-service-id]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.selectedServiceId = btn.dataset.serviceId || "";
      document.querySelectorAll("#serviceChoices .choiceBtn[data-service-id]").forEach(b=>b.classList.toggle("active", b===btn));
    });
  });

  const rp = document.getElementById("recipientPostcodeInput");
  const ra = document.getElementById("recipientAddressInput");
  const sp = document.getElementById("senderPostcodeInput");
  const sa = document.getElementById("senderAddressInput");
  const pod = document.getElementById("proofDeliveryInput");

  rp.addEventListener("input", (e)=>{
    const prevNI = isBTPostcode(state.recipientPostcode);
    state.recipientPostcode = (e.target.value || "").toUpperCase().slice(0, 10);
    e.target.value = state.recipientPostcode;
    const nowNI = isBTPostcode(state.recipientPostcode);
    if(prevNI !== nowNI){
      if(!nowNI){
        state.niCustomsReference = "";
        state.niCustomsConfirmed = false;
      }
      render();
    }
  });
  ra.addEventListener("input", (e)=>{ state.recipientAddress = (e.target.value || "").slice(0, 80); e.target.value = state.recipientAddress; });
  sp.addEventListener("input", (e)=>{ state.senderPostcode = (e.target.value || "").toUpperCase().slice(0, 10); e.target.value = state.senderPostcode; });
  sa.addEventListener("input", (e)=>{ state.senderAddress = (e.target.value || "").slice(0, 80); e.target.value = state.senderAddress; });
  pod.addEventListener("change", (e)=>{ state.proofOfDelivery = !!e.target.checked; });

  const niRef = document.getElementById("niReferenceInput");
  const niConfirm = document.getElementById("niConfirmed");
  if(niRef){
    niRef.addEventListener("input", (e)=>{ state.niCustomsReference = (e.target.value || "").slice(0, 40); e.target.value = state.niCustomsReference; });
  }
  if(niConfirm){
    niConfirm.addEventListener("change", (e)=>{ state.niCustomsConfirmed = !!e.target.checked; });
  }
}

function renderBasketAndPay(){
  const service = selectedService();
  const total = basketTotal();

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Add to Basket and Pay (KIOSK-417)</h1>
        <p class="subtitle">Review basket, then take payment and finalise transaction.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">shopping_cart</span> Basket and pay</span>
    </div>

    <div class="formRow">
      <div class="card">
        <h3>Review basket (KIOSK-419)</h3>
        ${service ? `
          <div class="helpNote">
            <strong>Service:</strong> ${escapeHtml(service.name)}<br/>
            <strong>Base price:</strong> ¬£${calculateServicePrice(service).toFixed(2)}<br/>
            <strong>Proof of delivery:</strong> ${state.proofOfDelivery ? "Yes (¬£1.50)" : "No"}<br/>
            <strong>Total:</strong> ¬£${total.toFixed(2)}
          </div>
        ` : `
          <div class="banner danger show" style="display:block;">No service selected.</div>
        `}
      </div>
      <div class="card">
        <h3>Take payment (KIOSK-420)</h3>
        <div class="choiceRow3" id="paymentChoices">
          <button type="button" class="choiceBtn ${state.paymentMethod==="card"?"active":""}" data-value="card"><span>Card</span></button>
          <button type="button" class="choiceBtn ${state.paymentMethod==="applepay"?"active":""}" data-value="applepay"><span>Apple Pay</span></button>
          <button type="button" class="choiceBtn ${state.paymentMethod==="googlepay"?"active":""}" data-value="googlepay"><span>Google Pay</span></button>
        </div>
        <button class="btn primary" id="capturePaymentBtn" style="margin-top:12px;">
          <span class="material-symbols-outlined">payments</span> Take payment and finalise
        </button>
        ${state.paymentComplete ? `
          <div class="banner ok show" style="display:block; margin-top:10px;">Payment captured successfully.</div>
        ` : ""}
      </div>
    </div>
  `;

  document.querySelectorAll("#paymentChoices .choiceBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.paymentMethod = btn.dataset.value || "";
      document.querySelectorAll("#paymentChoices .choiceBtn").forEach(b=>b.classList.toggle("active", b===btn));
    });
  });

  document.getElementById("capturePaymentBtn").addEventListener("click", ()=>{
    if(!state.paymentMethod){
      alert("Select a payment method first.");
      return;
    }
    state.paymentComplete = true;
    if(!state.transactionRef){
      state.transactionRef = `TX-${Math.random().toString(36).slice(2,8).toUpperCase()}`;
    }
    render();
  });
}

function renderPrintAndConfirm(){
  const service = selectedService();
  const total = basketTotal();
  const dest = state.destination === "uk" ? "UK Inland" : "International";

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Print and Confirm (KIOSK-421)</h1>
        <p class="subtitle">Print label(s) and show transaction summary/confirmation.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">print</span> Print and confirm</span>
    </div>

    <div class="formRow">
      <div class="card">
        <h3>Print postage label(s) (KIOSK-422)</h3>
        <button class="btn primary" id="printLabelsBtn">
          <span class="material-symbols-outlined">print</span> Print label now
        </button>
        ${state.labelsPrinted ? `
          <div class="banner ok show" style="display:block; margin-top:10px;">Labels printed successfully.</div>
        ` : ""}
      </div>
      <div class="card">
        <h3>Transaction summary / confirmation CoP (KIOSK-423)</h3>
        <div class="helpNote">
          <strong>Reference:</strong> ${escapeHtml(state.transactionRef || "Pending")}<br/>
          <strong>Service:</strong> ${escapeHtml(service ? service.name : "Not selected")}<br/>
          <strong>Destination:</strong> ${dest}<br/>
          <strong>Total paid:</strong> ¬£${total.toFixed(2)}<br/>
          <strong>Recipient postcode:</strong> ${escapeHtml(state.recipientPostcode || "‚Äî")}
        </div>
      </div>
    </div>
  `;

  document.getElementById("printLabelsBtn").addEventListener("click", ()=>{
    state.labelsPrinted = true;
    if(!state.transactionRef){
      state.transactionRef = `TX-${Math.random().toString(36).slice(2,8).toUpperCase()}`;
    }
    render();
  });
}

function renderSummary(){
  const dest = state.destination === "uk" ? "UK" : (state.destination === "intl" ? "International" : "Not set");
  const fmt = ({letter:"Letter", large_letter:"Large letter", parcel:"Parcel"})[state.format] || "Not set";
  const profile = state.productProfile === "royal_mail" ? "Royal Mail rules" : "EVRi/DPD rules";

  const restrictedLabels = [...state.restrictedKeys].map(k => RESTRICTED.find(x=>x.key===k)?.label).filter(Boolean);
  const lossLabels = [...state.coverLossOnlyKeys].map(k => LOSS_ONLY.find(x=>x.key===k)?.label).filter(Boolean);
  const ncLabels = [...state.coverNoCompKeys].map(k => NO_COMP.find(x=>x.key===k)?.label).filter(Boolean);
  const rmSelected = RM_FILTER.find(x=>x.key===state.rmSelectedKey)?.label || (state.rmOtherSelected ? "Other / not listed" : "None");

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Summary</h1>
        <p class="subtitle">Captured data and screening outcomes.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">fact_check</span> Prototype end</span>
    </div>

    <div class="summary">
      <div class="card">
        <h3>Item details</h3>
        <div style="margin-top:10px;">
          <span class="tag"><span class="material-symbols-outlined">scale</span> ${escapeHtml(state.weightG || "‚Äî")} g</span>
          <span class="tag"><span class="material-symbols-outlined">straighten</span> ${fmt}</span>
          <span class="tag"><span class="material-symbols-outlined">public</span> ${dest}</span>
          <span class="tag"><span class="material-symbols-outlined">inventory</span> ${profile}</span>
        </div>
        <div class="helpNote">Next in the real journey: product/service filtering & pricing.</div>
      </div>

      <div class="card">
        <h3>Screening flags</h3>

        ${state.productProfile === "royal_mail" ? `
          ${state.rmBlockedKey ? `
            <div class="banner danger show" style="display:block;">
              Royal Mail blocked selection: ${escapeHtml(RM_FILTER.find(x=>x.key===state.rmBlockedKey)?.label || state.rmBlockedKey)}.
            </div>
          ` : `
            <div class="banner ok show" style="display:block;">
              Royal Mail dangerous goods filter completed.
            </div>
          `}
        ` : `
          ${state.prohibitedKey ? `
            <div class="banner danger show" style="display:block;">
              Prohibited selection was made: ${escapeHtml(PROHIBITED.find(x=>x.key===state.prohibitedKey)?.label || state.prohibitedKey)} (journey would stop).
            </div>
          ` : `
            <div class="banner ok show" style="display:block;">
              No prohibited items selected.
            </div>
          `}
        `}

        <div style="margin-top:10px;">
          <div class="helpNote">
            ${state.productProfile === "royal_mail" ? `
              <strong>RM filter selection:</strong> ${escapeHtml(rmSelected)}<br/>
              <strong>RM conditions:</strong> Standard Royal Mail checks reviewed
            ` : `
              <strong>Restricted:</strong> ${restrictedLabels.length ? escapeHtml(restrictedLabels.join(", ")) : "None"}<br/>
              <strong>Loss-only:</strong> ${lossLabels.length ? escapeHtml(lossLabels.join(", ")) : "None"}<br/>
              <strong>No-comp:</strong> ${ncLabels.length ? escapeHtml(ncLabels.join(", ")) : "None"}
            `}
          </div>
        </div>
      </div>
    </div>
  `;
}

/* ---------------------------
   Tile creation + wiring
---------------------------- */
function tileEl(item, mode, multi=false){
  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "tile";
  btn.dataset.key = item.key;
  btn.dataset.mode = mode;
  btn.dataset.multi = multi ? "1" : "0";

  if(item.blank){
    btn.style.visibility = "hidden";
    btn.style.pointerEvents = "none";
    return btn;
  }
  btn.innerHTML = `
    <div class="icon"><span class="material-symbols-outlined">${item.icon || "block"}</span></div>
    <div>
      <div class="label">${escapeHtml(item.label)}</div>
    </div>
  `;
  return btn;
}

// Prohibited: tap = immediate hard-stop panel (still shows details)
function wireProhibitedDetails(list){
  const details = document.getElementById("pDetails");
  const title = document.getElementById("pDetailsTitle");
  const text = document.getElementById("pDetailsText");
  const close = document.getElementById("pClose");
  const back = document.getElementById("pStopBack");
  const reset = document.getElementById("pStopReset");

  document.querySelectorAll('.tile[data-mode="p"]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const key = btn.dataset.key;
      const item = list.find(x=>x.key===key);
      if(!item) return;

      // highlight single
      document.querySelectorAll('.tile[data-mode="p"]').forEach(b=>b.classList.remove("selected"));
      btn.classList.add("selected");

      if(key === "other_not_listed"){
        state.prohibitedKey = null;
        state.prohibitedOtherSelected = true;
        details.classList.remove("show");
        return;
      }

      state.prohibitedOtherSelected = false;
      state.prohibitedKey = key;

      title.innerHTML = `
        <div class="icon"><span class="material-symbols-outlined">${item.icon || "block"}</span></div>
        ${escapeHtml(item.label)}
      `;
      text.textContent = item.details || "";
      details.classList.add("show");
    });
  });

  close.addEventListener("click", ()=>{
    state.prohibitedKey = null;
    state.prohibitedOtherSelected = false;
    details.classList.remove("show");
    document.querySelectorAll('.tile[data-mode="p"]').forEach(b=>b.classList.remove("selected"));
  });
  back.addEventListener("click", ()=>{ state.step = 1; render(); });
  reset.addEventListener("click", ()=> resetAll());
}

// Multi-select tiles: tap toggles selection + opens details panel
function wireMultiSelectDetails(mode, list, setRef, detailsMode="r"){
  const details = document.getElementById(`${detailsMode}Details`) || document.getElementById("cDetails");
  const title = document.getElementById(`${detailsMode}DetailsTitle`) || document.getElementById("cDetailsTitle");
  const text = document.getElementById(`${detailsMode}DetailsText`) || document.getElementById("cDetailsText");
  const close = document.getElementById(`${detailsMode}Close`) || document.getElementById("cClose");

  document.querySelectorAll(`.tile[data-mode="${mode}"]`).forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const key = btn.dataset.key;
      const item = list.find(x=>x.key===key);
      if(!item) return;

      if(setRef.has(key)) setRef.delete(key);
      else setRef.add(key);

      btn.classList.toggle("selected", setRef.has(key));

      title.innerHTML = `
        <div class="icon"><span class="material-symbols-outlined">${item.icon || "block"}</span></div>
        ${escapeHtml(item.label)}
      `;
      text.textContent = item.details || "";
      details.classList.add("show");
    });
  });

  // Close handler is wired in renderRestricted / renderCoverLimits for shared panel cases
}

/* ---------------------------
   Navigation rules
---------------------------- */
function canContinue(){
  if(state.step === 1) return !!state.weightG && !!state.destination && !!state.format && !!state.productProfile;

  if(state.step === 2){
    if(state.productProfile === "royal_mail"){
      return (state.rmOtherSelected || !!state.rmSelectedKey) && !state.rmBlockedKey;
    }
    // EVRi/DPD step 2 requires explicit acknowledgement via "Other / not listed".
    return state.prohibitedOtherSelected && !state.prohibitedKey;
  }

  if(state.step === 4){
    return !!state.format && !!state.formatConfirmed;
  }

  if(state.step === 5){
    return numericValue(state.declaredValue) > 0 && (state.contentDescription || "").trim().length >= 3;
  }

  if(state.step === 6){
    const hasAddresses = !!state.recipientPostcode && !!state.recipientAddress && !!state.senderPostcode && !!state.senderAddress;
    const hasService = !!state.selectedServiceId;
    const needsNI = state.destination === "uk" && isBTPostcode(state.recipientPostcode);
    const niOk = !needsNI || (!!state.niCustomsReference && state.niCustomsConfirmed);
    return hasAddresses && hasService && niOk;
  }

  if(state.step === 7){
    return !!state.paymentComplete;
  }

  return true;
}

function next(){
  if(state.step === 8){
    resetAll();
    return;
  }

  if(!canContinue()){
    if(state.step === 2){
      if(state.productProfile === "royal_mail"){
        if(state.rmBlockedKey){
          alert("This item is not allowed for the selected destination under Royal Mail rules.");
          return;
        }
        alert("Please select a Royal Mail category or choose 'Other / not listed'.");
        return;
      }
      if(state.prohibitedKey){
        alert("A prohibited item has been selected. In the live journey this would stop here.");
        return;
      }
      alert("Please select 'Other / not listed' to confirm your item is not shown.");
      return;
    }
    if(state.step === 4){
      alert("Confirm the format classification before continuing.");
      return;
    }
    if(state.step === 5){
      alert("Declare item value and provide a contents description.");
      return;
    }
    if(state.step === 6){
      alert("Complete address details, NI checks (if applicable), and select a service.");
      return;
    }
    if(state.step === 7){
      alert("Take payment to finalise the transaction before continuing.");
      return;
    }
    alert("Please complete this step before continuing.");
    return;
  }

  if(state.step === 6){
    state.basketAdded = true;
  }

  if(state.step < stepCount()) state.step += 1;
  render();
}

function back(){
  if(state.step > 1) state.step -= 1;
  render();
}

function resetAll(){
  state.step = 1;
  state.weightG = "";
  state.format = "";
  state.destination = "";
  state.productProfile = "evri_dpd";
  state.prohibitedKey = null;
  state.prohibitedOtherSelected = false;
  state.rmSelectedKey = null;
  state.rmBlockedKey = null;
  state.rmOtherSelected = false;
  state.rmAdvisoryKeys = new Set();
  state.restrictedKeys = new Set();
  state.coverLossOnlyKeys = new Set();
  state.coverNoCompKeys = new Set();
  state.formatConfirmed = false;
  state.declaredValue = "";
  state.contentDescription = "";
  state.deliverySpeed = "balanced";
  state.recipientPostcode = "";
  state.recipientAddress = "";
  state.senderPostcode = "";
  state.senderAddress = "";
  state.niCustomsConfirmed = false;
  state.niCustomsReference = "";
  state.proofOfDelivery = false;
  state.selectedServiceId = "";
  state.basketAdded = false;
  state.paymentMethod = "";
  state.paymentComplete = false;
  state.labelsPrinted = false;
  state.transactionRef = "";
  render();
}

/* ---------------------------
   Hook up chrome buttons
---------------------------- */
document.getElementById("backBtn").addEventListener("click", back);
document.getElementById("nextBtn").addEventListener("click", next);
document.getElementById("resetBtn").addEventListener("click", resetAll);
document.getElementById("cancelBtn").addEventListener("click", ()=> alert("Cancel ‚Äì prototype action"));
document.getElementById("helpBtn").addEventListener("click", ()=> alert("Help ‚Äì prototype action"));

render();
</script>
</body>
</html>
