<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kiosk Journey Prototype – Prohibited → Restricted → Cover Limits</title>
  <link rel="icon" type="image/svg+xml" sizes="any" href="./favicon.svg?v=4" />
  <link rel="shortcut icon" href="./favicon.svg?v=4" />

  <!-- Google Material Symbols -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#edf2f8;
      --surface:#ffffff;
      --panel:#e9f0fb;
      --text:#1b2538;
      --muted:#4d5b73;
      --accent:#1f5d8f;
      --accent2:#2e7ab8;
      --border:#c7d4e6;
      --danger:#7d5200;
      --warn:#8a5f00;
      --ok:#21683a;
      --shadow: 0 12px 28px rgba(20,40,74,.12);
      --radius: 16px;
      --tile-h: 122px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Nunito Sans", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:linear-gradient(180deg, #f7f9fd 0%, var(--bg) 100%);
      color:var(--text);
    }
    .app{max-width:1220px;margin:0 auto;padding:18px;}
    .chrome{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:16px 18px;border-bottom:1px solid var(--border);background:#fff;
    }
    .left,.right{display:flex;gap:10px;align-items:center;}
    .btn{
      border:1px solid var(--border);
      background:#fff;color:var(--text);
      padding:12px 16px;border-radius:14px;
      cursor:pointer;font-weight:700;
      display:inline-flex;align-items:center;gap:8px;user-select:none;
      min-height:54px;
      font-size:18px;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;}
    .btn.ghost{background:transparent;border-color:transparent;color:var(--accent);}
    .btn.danger{background:#fff;border-color:#d0dae9;color:#3c4d68;}
    .btn.warn{background:#fff;border-color:#efd3a4;color:var(--warn);}
    .material-symbols-outlined{
      font-variation-settings:"FILL" 0,"wght" 600,"GRAD" 0,"opsz" 24;
      font-size:22px;line-height:1;
    }
    .content{
      padding:24px;
      background:linear-gradient(#ffffff,#f4f7fd);
      min-height:680px;
      position:relative;
    }
    h1{margin:4px 0 4px;font-size:36px;letter-spacing:.2px;color:#18324f;}
    .subtitle{color:var(--muted);margin:0 0 16px;font-size:18px;font-weight:700;}
    .stepHeader{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:14px;}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:10px 14px;border-radius:999px;border:1px solid var(--border);
      background:var(--panel);color:#1f3653;font-weight:800;font-size:14px;
    }
    .crumbBar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding:10px 18px;
      border-bottom:1px solid var(--border);
      background:#f3f7fd;
    }
    .crumbPill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:#2a2550;
      font-size:12px;
      font-weight:800;
      max-width:100%;
    }
    .crumbPill .material-symbols-outlined{
      font-size:16px;
      color:#6357a3;
    }
    .crumbLabel{
      color:var(--muted);
      font-weight:800;
      white-space:nowrap;
    }
    .crumbValue{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:220px;
    }
    .launchHeader{
      margin:0 0 14px;
      padding:16px 18px;
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      text-align:center;
      color:#1d3350;
      font-size:42px;
      font-weight:900;
    }
    .launchGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
    }
    .launchTile{
      border:1px solid var(--border);
      border-radius:20px;
      min-height:210px;
      background:#f6f9ff;
      color:#17344f;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:16px;
      padding:24px;
      cursor:pointer;
      font-size:38px;
      font-weight:900;
      line-height:1.1;
      text-align:left;
      box-shadow:0 4px 12px rgba(20,40,74,.08);
    }
    .launchTile:hover{border-color:#a9bfdc;}
    .launchTile:active{transform:translateY(1px);}
    .launchTile .material-symbols-outlined{
      font-size:68px;
      color:#2a6ea5;
      flex:0 0 auto;
    }
    .launchTile.active{
      background:linear-gradient(145deg, #dff0ff, #eff7ff);
      border-color:#7faed6;
      box-shadow:0 0 0 4px rgba(46,122,184,.15);
    }
    .launchTile.disabled{
      background:#f2f5fa;
      color:#6d7890;
      border-color:#d8e1ef;
    }
    .launchTile.disabled .material-symbols-outlined{
      color:#8fa1bb;
    }
    .launchTile .sub{
      display:block;
      margin-top:8px;
      font-size:19px;
      font-weight:700;
      color:var(--muted);
    }
    .launchControls{
      margin-top:16px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
    }
    .launchControlCard{
      border:1px solid var(--border);
      border-radius:18px;
      background:#fff;
      padding:14px;
    }
    .launchControlCard h3{
      margin:0 0 8px;
      color:#17344f;
      font-size:20px;
      font-weight:900;
    }
    .launchControlRow{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .launchControlBtn{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      border-radius:14px;
      min-height:72px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:8px;
      font-size:20px;
      font-weight:900;
      cursor:pointer;
      padding:8px 10px;
    }
    .launchControlBtn.active{
      border-color:var(--accent2);
      box-shadow:0 0 0 4px rgba(46,122,184,.15);
      background:#f2f9ff;
    }
    .launchControlBtn .sub{
      display:block;
      font-size:13px;
      color:var(--muted);
      font-weight:700;
    }
    .screenRefreshOverlay{
      position:absolute;
      inset:0;
      background:rgba(246,250,255,.96);
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      pointer-events:none;
      transition:opacity .14s ease;
      z-index:90;
    }
    .screenRefreshOverlay.show{opacity:1;}
    .screenRefreshCard{
      border:1px solid var(--border);
      border-radius:18px;
      background:#fff;
      padding:16px 22px;
      color:#1f3653;
      font-size:18px;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow:0 8px 24px rgba(20,40,74,.10);
    }
    .screenRefreshCard .material-symbols-outlined{
      font-size:24px;
      color:var(--accent);
    }
    .vkWrap{
      display:none;
      position:absolute;
      left:0;
      right:0;
      bottom:88px;
      z-index:80;
      background:#edf3fb;
      border-top:1px solid var(--border);
      padding:12px 16px 14px;
    }
    .vkWrap.show{display:block;}
    .vkHead{
      color:#1f3653;
      font-size:20px;
      font-weight:900;
      margin:0 0 8px;
    }
    .vkMirror{
      width:100%;
      min-height:58px;
      border:2px solid #d8c37a;
      border-radius:10px;
      background:#fff;
      padding:12px 14px;
      color:#233651;
      font-size:26px;
      font-weight:800;
      display:flex;
      align-items:center;
      margin-bottom:10px;
    }
    .vkRows{display:grid;gap:8px;}
    .vkRow{
      display:grid;
      gap:8px;
      grid-template-columns:repeat(var(--vk-cols, 10), minmax(0,1fr));
    }
    .vkKey{
      border:1px solid var(--border);
      border-radius:12px;
      min-height:54px;
      background:#fff;
      color:#1f3653;
      font-size:28px;
      font-weight:800;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .vkKey:active{transform:translateY(1px);}
    .vkKey.action{
      font-size:22px;
      background:#f7f9fd;
    }
    .vkFooter{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top:10px;
    }
    .chrome.keyboard-open .content{
      padding-bottom:360px;
    }
    .gridWrap{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:20px;
      padding:16px;
      position:relative;
    }
    .grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:14px;}
    .tile{
      min-height:var(--tile-h);
      height:auto;
      border:1px solid var(--border);
      background:#fff;border-radius:18px;
      display:flex;align-items:flex-start;gap:12px;
      padding:14px;cursor:pointer;
      box-shadow:0 2px 0 rgba(0,0,0,.02);
      text-align:left;
    }
    .tile:hover{border-color:#c8cfe2}
    .tile .icon{
      width:64px;height:64px;border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      background:#e6effa;color:var(--accent);flex:0 0 auto;
      overflow:hidden;
    }
    .tile .icon .material-symbols-outlined{
      font-size:34px;
      display:block;
      max-width:1em;
      overflow:hidden;
      white-space:nowrap;
    }
    .tile .label{font-weight:900;font-size:15px;line-height:1.2;overflow-wrap:anywhere;word-break:break-word;}
    .tile.selected{border-color:var(--accent2);box-shadow:0 0 0 4px rgba(46,122,184,.18);}
    .details{
      margin-top:0;border:1px solid var(--border);
      background:#fff;border-radius:18px;padding:16px;display:none;
      position:absolute;left:14px;right:14px;top:14px;z-index:30;
      box-shadow:var(--shadow);
      max-height:min(78vh, calc(100vh - 180px));
      overflow:auto;
    }
    .details.show{display:block;}
    .detailsTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;}
    .detailsTitle{display:flex;gap:10px;align-items:center;font-weight:900;color:#2a2550;}
    .detailsTitle .icon{
      width:40px;height:40px;border-radius:12px;background:#e6effa;
      display:flex;align-items:center;justify-content:center;color:var(--accent);
      overflow:hidden;
    }
    .detailsTitle .icon .material-symbols-outlined{
      font-size:22px;
      display:block;
      max-width:1em;
      overflow:hidden;
      white-space:nowrap;
    }
    .detailsText{margin-top:10px;color:#293047;line-height:1.35;}
    .banner{
      margin-top:10px;padding:10px 12px;border-radius:12px;
      font-weight:800;display:none;
    }
    .banner.show{display:block;}
    .banner.danger{border:1px solid #efcf9f;background:#fff7eb;color:#7d5200;}
    .banner.warn{border:1px solid #efcf9f;background:#fff8ee;color:#7a3f00;}
    .banner.ok{border:1px solid #c7e7cb;background:#f3fff5;color:#1f5f27;}
    .rmConditionGroup{margin-top:10px;display:grid;gap:8px;}
    .rmConditionCheck{
      display:flex;
      gap:8px;
      align-items:flex-start;
      font-weight:700;
      color:#273047;
    }
    .rmConditionLimit{
      display:grid;
      grid-template-columns:1fr 130px;
      gap:10px;
      align-items:center;
    }
    .rmConditionActions{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .formRow{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px;}
    .formRow.stack{grid-template-columns:1fr;}
    .card{border:1px solid var(--border);background:#fff;border-radius:18px;padding:18px;}
    .card h3{margin:0 0 8px;font-size:22px;color:#18324f}
    .card p{margin:0 0 12px;color:var(--muted);font-size:16px}
    .choiceGroup{display:grid;gap:10px}
    .choiceRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .choiceRow3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .choiceBtn{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      border-radius:16px;
      padding:16px 12px;
      text-align:center;
      cursor:pointer;
      font-weight:900;
      min-height:86px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      font-size:17px;
    }
    .choiceBtn .sub{font-size:13px;color:var(--muted);font-weight:700}
    .choiceBtn span{overflow-wrap:anywhere;word-break:break-word;line-height:1.2}
    .choiceBtn.active{
      border-color:var(--accent2);
      box-shadow:0 0 0 4px rgba(46,122,184,.18);
      background:#f2f9ff;
    }
    .demoToggleRow{
      margin-top:12px;
      display:flex;
      justify-content:flex-end;
    }
    .demoToggle{
      display:inline-flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:13px;
      font-weight:700;
      user-select:none;
    }
    .demoToggle input{display:none;}
    .demoToggle .track{
      width:48px;
      height:26px;
      border-radius:999px;
      background:#d9deeb;
      border:1px solid #c7cfe0;
      position:relative;
      transition:all .15s ease;
      flex:0 0 auto;
    }
    .demoToggle .thumb{
      width:20px;
      height:20px;
      border-radius:50%;
      background:#fff;
      position:absolute;
      top:2px;
      left:2px;
      box-shadow:0 1px 3px rgba(0,0,0,.25);
      transition:all .15s ease;
    }
    .demoToggle input:checked + .track{
      background:#c9f0d3;
      border-color:#9fd6ae;
    }
    .demoToggle input:checked + .track .thumb{
      left:24px;
    }
    input,select{
      width:100%;padding:14px 16px;border:1px solid var(--border);
      border-radius:14px;font-size:20px;outline:none;
      min-height:58px;
    }
    .kioskKeyboardInput{
      cursor:pointer;
      background:#fff;
    }
    input:focus,select:focus{border-color:#8eb9de;box-shadow:0 0 0 4px rgba(46,122,184,.12)}
    .helpNote{
      margin-top:10px;padding:12px 14px;border-left:4px solid var(--accent2);
      background:#f3f8ff;border-radius:14px;color:#2c4663;
      font-size:16px;line-height:1.35;
    }
    .flowShell{
      display:grid;
      grid-template-columns:minmax(0,1fr) 340px;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }
    .flowAside{display:grid;gap:14px;}
    .flowNarrative{
      background:#f8f9ff;
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      color:#2c4663;
      font-size:14px;
      line-height:1.35;
    }
    .flowNarrative h4{
      margin:0 0 8px;
      color:#2a2550;
      font-size:16px;
    }
    .flowNarrative p{margin:0 0 8px;}
    .flowNarrative p:last-child{margin-bottom:0;}
    .scalePromptPanel{
      border:1px solid var(--border);
      background:#fff;
      border-radius:20px;
      padding:26px 20px;
      text-align:center;
      box-shadow:0 6px 18px rgba(20,40,74,.08);
    }
    .scalePromptIcon{
      width:72px;
      height:72px;
      margin:0 auto 12px;
      border-radius:16px;
      background:#e6effa;
      color:var(--accent);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .scalePromptIcon .material-symbols-outlined{font-size:40px;}
    .scalePromptTitle{
      margin:0;
      color:#17334f;
      font-size:38px;
      line-height:1.12;
      font-weight:900;
      letter-spacing:.1px;
    }
    .scalePromptText{
      margin:10px 0 8px;
      color:var(--muted);
      font-size:21px;
      font-weight:700;
    }
    .scalePromptArrow{
      margin-top:8px;
      color:var(--accent);
      font-size:30px;
      line-height:1;
      font-weight:900;
    }
    .weightConfirmCard{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius:18px;
      background:#fff;
      padding:18px;
      display:grid;
      grid-template-columns:1.2fr .8fr;
      gap:16px;
      align-items:center;
    }
    .weightCopy{
      text-align:center;
    }
    .weightCopy .label{
      margin:0;
      color:var(--muted);
      font-size:20px;
      font-weight:700;
    }
    .weightCopy .value{
      margin:2px 0 0;
      color:#17334f;
      font-size:56px;
      font-weight:900;
      line-height:1;
    }
    .weightEditBtn{
      margin-top:10px;
      min-height:50px;
      font-size:18px;
      font-weight:800;
      justify-content:center;
    }
    .weightInline{
      display:none;
      margin-top:10px;
      text-align:left;
    }
    .weightInline.show{display:block;}
    .weightInline p{
      margin:0 0 8px;
      color:var(--muted);
      font-size:15px;
      font-weight:700;
    }
    .weightItemVisual{
      border:1px dashed #b8cbe3;
      border-radius:16px;
      min-height:160px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#f5f9ff;
      color:#2e7ab8;
      font-size:72px;
    }
    .weightActions{
      display:grid;
      grid-template-columns:1fr 1.4fr;
      gap:12px;
      margin-top:14px;
    }
    .weightActions .btn{
      min-height:64px;
      justify-content:center;
      font-size:20px;
      font-weight:900;
    }
    .btn.secondary{
      background:#fff;
      border-color:#cfd9e8;
      color:#445671;
    }
    .weighAssist{
      margin-top:14px;
      padding:16px;
      border:1px solid var(--border);
      border-radius:16px;
      background:#f7faff;
    }
    .weighAssist h3{
      margin:0 0 8px;
      font-size:19px;
      color:#18324f;
    }
    .weighAssist p{
      margin:0 0 10px;
      color:var(--muted);
      font-size:15px;
    }
    .weighAssist .demoToggleRow{
      margin-top:8px;
      justify-content:flex-start;
    }
    .bottombar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:16px 18px;border-top:1px solid var(--border);background:#fff;
    }
    .progress{
      color:var(--muted);
      font-weight:800;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:8px;
      text-align:center;
    }
    .progress .wireframeFlag{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #f1d6a8;
      background:#fff5df;
      color:#7b4f00;
      font-size:12px;
      font-weight:900;
      line-height:1;
    }
    .tag{
      display:inline-flex;gap:6px;align-items:center;
      padding:8px 12px;border-radius:999px;border:1px solid var(--border);
      background:#fff;font-weight:800;color:#2a2550;margin-right:8px;margin-bottom:8px;
      font-size:14px;
    }
    .summary{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px;}
    @media (max-width: 980px){
      .app{padding:10px;}
      .topbar{padding:10px 12px;}
      .btn{font-size:14px;min-height:46px;padding:10px 12px;}
      h1{font-size:32px;}
      .subtitle{font-size:18px;}
      .card h3{font-size:22px;}
      .card p{font-size:15px;}
      input,select{font-size:18px;min-height:52px;}
      .helpNote{font-size:14px;}
      .scalePromptPanel{padding:20px 14px;}
      .scalePromptTitle{font-size:30px;}
      .scalePromptText{font-size:18px;}
      .scalePromptArrow{font-size:24px;}
      .launchHeader{font-size:28px;padding:12px;}
      .launchGrid{grid-template-columns:1fr;gap:12px;}
      .launchTile{min-height:130px;font-size:24px;padding:16px;}
      .launchTile .material-symbols-outlined{font-size:44px;}
      .launchTile .sub{font-size:14px;}
      .launchControls{grid-template-columns:1fr;gap:12px;}
      .launchControlCard h3{font-size:17px;}
      .launchControlBtn{min-height:60px;font-size:16px;}
      .vkWrap{bottom:74px;padding:10px;}
      .vkHead{font-size:16px;}
      .vkMirror{font-size:20px;min-height:50px;}
      .vkKey{min-height:46px;font-size:20px;}
      .vkKey.action{font-size:16px;}
      .chrome.keyboard-open .content{padding-bottom:330px;}
      .weightConfirmCard{grid-template-columns:1fr;padding:14px;}
      .weightCopy .label{font-size:17px;}
      .weightCopy .value{font-size:42px;}
      .weightEditBtn{font-size:16px;min-height:46px;}
      .weightItemVisual{min-height:120px;font-size:56px;}
      .weightActions{grid-template-columns:1fr;}
      .weightActions .btn{font-size:18px;min-height:58px;}
      .grid{grid-template-columns:repeat(5,minmax(0,1fr));gap:8px;}
      .formRow{grid-template-columns:1fr;}
      .flowShell{grid-template-columns:1fr;}
      .summary{grid-template-columns:1fr;}
      .crumbBar{padding:8px 12px;}
      .crumbValue{max-width:150px;}
      .choiceRow3{grid-template-columns:1fr;}
      .choiceBtn{min-height:72px;font-size:16px;}
      .tile{padding:10px;}
      .tile .icon{width:46px;height:46px;border-radius:12px;}
      .tile .icon .material-symbols-outlined{font-size:24px;}
      .tile .label{font-size:12px;}
      :root{--tile-h: 90px;}
    }
  </style>
</head>

<body>
<div class="app">
  <div class="chrome">
    <div class="topbar">
      <div class="left">
        <button class="btn" id="backBtn"><span class="material-symbols-outlined">arrow_back</span>Go Back</button>
        <button class="btn ghost" id="resetBtn"><span class="material-symbols-outlined">restart_alt</span>Reset</button>
      </div>
      <div class="right">
        <span class="pill" id="destPill">
          <span class="material-symbols-outlined">public</span>
          Destination: <span id="destLabel">Not set</span>
        </span>
        <button class="btn" id="helpBtn">Help <span class="material-symbols-outlined">help</span></button>
      </div>
    </div>

    <div class="crumbBar" id="crumbBar"></div>

    <div class="content" id="screen"></div>

    <div class="vkWrap" id="vkWrap" aria-hidden="true">
      <p class="vkHead" id="vkHead">Enter details</p>
      <div class="vkMirror" id="vkMirror"></div>
      <div class="vkRows" id="vkRows"></div>
      <div class="vkFooter">
        <button type="button" class="btn secondary" id="vkCancelBtn">Cancel</button>
        <button type="button" class="btn primary" id="vkDoneBtn">Next</button>
      </div>
    </div>

    <div class="bottombar">
      <button class="btn danger" id="cancelBtn"><span class="material-symbols-outlined">close</span>Cancel</button>
      <div class="progress" id="progress">Step 1 of 6 <span class="wireframeFlag">Journey wireframe only</span></div>
      <button class="btn primary" id="nextBtn">Continue <span class="material-symbols-outlined">arrow_forward</span></button>
    </div>
  </div>
</div>

<script>
/* ---------------------------
   State
---------------------------- */
const state = {
  step: 0,                // 0 = launch screen, then 1..6
  weightG: "",
  format: "",
  destination: "",
  productProfile: "royal_mail",
  quickDemoMode: false,
  prohibitedKey: null,    // if set -> hard stop message
  prohibitedOtherSelected: false,
  rmSelectedKey: null,
  rmBlockedKey: null,
  rmOtherSelected: false,
  rmConditionChecks: {},
  rmConditionValues: {},
  rmConditionSatisfied: false,
  evriScreeningOpen: false,
  evriAdditionalSelection: "",
  evriSelectedProhibitedKey: null,
  evriAdditionalBlocked: false,
  evriScreeningComplete: false,
  evriLossOnlySelected: false,
  evriNoCompSelected: false,
  rmAdvisoryKeys: new Set(),
  restrictedKeys: new Set(),
  coverLossOnlyKeys: new Set(),
  coverNoCompKeys: new Set(),
  manualWeightEditOpen: false,
  declaredValue: "",
  contentDescription: "",
  deliverySpeed: "",
  recipientPostcode: "",
  recipientAddress: "",
  senderPostcode: "",
  senderAddress: "",
  niCustomsConfirmed: false,
  niCustomsReference: "",
  niSpsCategory: "",
  niPrivateIndividual: "",
  rmNiPerishableRoute: "",
  rmNiPlantCertRef: "",
  proofOfDelivery: false,
  selectedServiceId: "",
  basketAdded: false,
  paymentMethod: "",
  paymentComplete: false,
  labelsPrinted: false,
  transactionRef: "",
  auditEvents: [],
};

/* ---------------------------
   Data lists (your updated content)
   - Prohibited: hard stop
   - Restricted: allow with conditions (placeholder scaffold)
   - Cover limits: Loss-only + No-comp (as provided)
---------------------------- */

// PROHIBITED (hard stop)
const PROHIBITED = [
  { key:"animals", label:"Animals / organisms", icon:"pets",
    details:"Animals or organisms of any form cannot be carried on any service." },

  { key:"food_all", label:"Food (any type)", icon:"restaurant",
    details:"Food items of any type cannot be carried, including non-perishable food." },

  { key:"perishables", label:"Perishables", icon:"emoji_nature",
    details:"Any perishable goods or perishable food cannot be carried on any service." },

  { key:"batteries", label:"Batteries (incl. built-in)", icon:"battery_alert",
    details:"Batteries and items containing built-in batteries cannot be carried on any service." },

  { key:"bio_samples", label:"Biological samples", icon:"science",
    details:"Biological samples cannot be carried on any service." },

  { key:"cylinders", label:"Compressed air / cylinders", icon:"propane_tank",
    details:"Compressed air and empty cylinders cannot be carried on any service." },

  { key:"drugs_tobacco", label:"Drugs / meds / tobacco", icon:"medical_services",
    details:"Drugs, medication, prescriptions, tobacco, and tobacco products cannot be carried on any service." },

  { key:"hazardous", label:"Hazardous goods", icon:"warning",
    details:"Hazardous goods cannot be carried, including aerosol, asbestos, ashes, detergents, resin, explosives, filth, fire extinguishers, fireworks, gas, dry ice, items containing alcohol, and flammable or explosive substances." },

  { key:"illegal", label:"Illegal / counterfeit", icon:"gavel",
    details:"Illegal goods cannot be carried, including counterfeit goods, counterfeit currency, and any items considered illegal in either the exporting or importing country." },

  { key:"liquids_gels", label:"Liquids / creams / gels", icon:"water_drop",
    details:"Liquids, creams, oils, wax, or gels cannot be carried on any service." },

  { key:"medical_equipment", label:"Medical equipment", icon:"medical_information",
    details:"Medical equipment cannot be carried on any service." },

  { key:"money_docs", label:"Money / financial docs", icon:"payments",
    details:"Monetary and currency items cannot be carried, including cash, credit cards, debit cards, coins, cheques, vouchers, tickets, lottery tickets, stamps (unless franked), and financial documents." },

  { key:"poisons", label:"Poisons / pesticides", icon:"pest_control",
    details:"Poisonous or toxic liquids, solids, and gases cannot be carried, including pesticides." },

  { key:"radioactive", label:"Radioactive materials", icon:"dangerous",
    details:"Radioactive materials cannot be carried on any service." },

  { key:"vehicle_parts_large", label:"Vehicle parts (large)", icon:"directions_car",
    details:"Large vehicle parts cannot be carried, including vehicle panels, spoilers, doors, bonnets, bumpers, carbon fibre, engines, any car parts containing oil or liquids, airbags, steering wheels containing airbags, and seatbelt tensioners." },

  { key:"weapons", label:"Weapons / blades", icon:"dangerous",
    details:"Weapons cannot be carried, including replicas, ammunition, axes, blades, chainsaws, guns, and knives." },

  { key:"white_goods", label:"White goods", icon:"kitchen",
    details:"White goods cannot be carried, including fridges, ovens, freezers, cooker hoods, hobs, boilers, washing machines, and hot tubs." },

  { key:"geochron", label:"Geochron", icon:"public",
    details:"Geochron items cannot be carried on any service." },
];

// RESTRICTED (allowed with conditions) — placeholders (swap with your real restricted catalogue)
const RESTRICTED = [
  { key:"lithium_in_device", label:"Device with built-in lithium battery", icon:"battery_alert",
    details:"Lithium batteries cannot be sent loose or spare. They are only accepted when installed in the device and packed to prevent damage or accidental activation." },

  { key:"aerosols_personal", label:"Personal aerosols", icon:"air",
    details:"Some aerosols may be allowable if within quantity limits and packed to prevent leakage/activation." },

  { key:"cosmetics", label:"Cosmetics", icon:"spa",
    details:"Some cosmetics may be allowable if non-flammable and packed to prevent leakage." },

  { key:"liquids_small", label:"Liquids (small volumes)", icon:"water_drop",
    details:"Some liquids may be allowable if under limits and packed with leak-proof inner packaging and absorbent material." },

  { key:"perfume_small", label:"Perfume / aftershave", icon:"sanitizer",
    details:"Perfume may be allowable only under specific limits and packaging rules. Check destination restrictions." },
];

const RM_CHECK_LABELS = {
  counter_presentation: "Presented at a Post Office counter where required.",
  sender_details_visible: "Sender name and return address are clearly visible on the parcel.",
  valves_protected: "Valves are protected to prevent accidental release.",
  tightly_packed: "Items are tightly packed to prevent movement.",
  wrapped_polythene_taped: "Items are wrapped in polythene and sealed with tape.",
  absorbent_and_cushioned: "Absorbent material and cushioning are used as required.",
  fragile_if_glass: "Parcel is marked FRAGILE when glass is present.",
  original_retail_packaging: "Item is in original retail packaging where required.",
  strong_outer_packaging: "Strong outer packaging is used.",
  short_circuit_protected: "Battery terminals/cells are protected from short circuit.",
  un38_3_compliant: "Cells/batteries are UN 38.3 compliant.",
  batteries_not_damaged: "No defective or damaged cells/batteries are included.",
  secured_against_movement: "Contents are secured against movement in the outer packaging.",
  prevent_accidental_activation: "Equipment is packed to prevent accidental activation.",
  uk_firearms_compliance: "Item complies with UK firearms law and applicable controls.",
  not_post_office_counter: "Bladed item is not being posted over a Post Office counter.",
  sift_proof_container: "A sift-proof container is used where required.",
  leakproof_inner_and_outer: "Leakproof inner liner and leakproof outer packaging are used.",
  sample_kit_used: "Official sample return kit is used where required.",
  pi650_packaging: "Packaging Instruction 650 requirements are met.",
  exempt_specimen_marking: "Package carries required exempt specimen wording.",
  no_risk_to_handlers: "Sharp points/edges are fully protected and cannot pierce packaging.",
  unopened_retail_batteries: "Batteries are new and unopened in original retail packaging.",
  package_marked_spa67_sp238: "Package is marked NOT RESTRICTED and SPA67 / SP238.",
  no_leakage_or_tainting: "Packaging is sealed to prevent leakage or tainting.",
  perishable_label_applied: "Package is clearly labelled PERISHABLE.",
  live_species_permitted: "Species is permitted under Royal Mail live-creature guidance.",
  live_packaging_compliant: "Live-creature packaging requirements are met.",
  no_fish_or_fry: "Item does not include fish or fish fry.",
  toxic_medicine_packaging: "Inner packs and outer packaging meet medicine packaging rules.",
  non_toxic_medicine_packaging: "Inner packs and outer packaging meet non-toxic medicine rules.",
  soils_only_if_analysis: "Only analysis samples are sent where applicable."
};

// ROYAL MAIL DANGEROUS GOODS FILTER (from RM leaflet valid from May 2025)
const RM_FILTER = [
  { key:"rm_aerosols_toiletry_medicinal", label:"Aerosols (toiletry/medicinal)", icon:"air", uk:true, intl:false,
    details:"Allowed UK only. Max 500ml per item and 2 items per parcel. Counter presentation and sender details required.",
    checks:["valves_protected","tightly_packed","counter_presentation","sender_details_visible"],
    limits:[
      { id:"volume_per_item_ml", label:"Volume per item", max:500, min:0.1, unit:"ml" },
      { id:"items_per_parcel", label:"Items in parcel", max:2, min:1, unit:"items" }
    ] },
  { key:"rm_bladed_items", label:"Bladed items", icon:"content_cut", uk:true, intl:false,
    details:"Allowed UK only with restrictions. Cannot be sent via Post Office counter.",
    checks:["not_post_office_counter"], limits:[] },
  { key:"rm_flammable_liquids", label:"Flammable liquids", icon:"local_fire_department", uk:false, intl:false,
    details:"Not allowed UK or International.", checks:[], limits:[] },
  { key:"rm_flammable_solids", label:"Flammable solids", icon:"local_fire_department", uk:false, intl:false,
    details:"Not allowed UK or International.", checks:[], limits:[] },
  { key:"rm_aerosols_other", label:"Aerosols (other purpose)", icon:"block", uk:false, intl:false,
    details:"Not allowed UK or International (for example spray paints/air fresheners).", checks:[], limits:[] },
  { key:"rm_clinical_medical_waste", label:"Clinical/medical waste", icon:"warning", uk:false, intl:false,
    details:"Not allowed UK or International.", checks:[], limits:[] },
  { key:"rm_alcohol_over_70", label:"Alcohol over 70% ABV", icon:"local_bar", uk:false, intl:false,
    details:"Not allowed UK or International.", checks:[], limits:[] },
  { key:"rm_controlled_drugs", label:"Controlled drugs/narcotics", icon:"gavel", uk:false, intl:false,
    details:"Not allowed UK or International.", checks:[], limits:[] },
  { key:"rm_gases", label:"Gases/cylinders", icon:"warning", uk:false, intl:false,
    details:"Not allowed UK or International (includes refills, extinguishers, scuba tanks).", checks:[], limits:[] },
  { key:"rm_alcohol_24_to_70", label:"Alcohol 24% to 70% ABV", icon:"liquor", uk:true, intl:false,
    details:"Allowed UK only. Max 1L per item and 2 items per parcel with wrapping/cushioning. Counter presentation required.",
    checks:["wrapped_polythene_taped","absorbent_and_cushioned","fragile_if_glass","counter_presentation","sender_details_visible"],
    limits:[
      { id:"volume_per_item_l", label:"Volume per item", max:1, min:0.1, unit:"litres" },
      { id:"items_per_parcel", label:"Items in parcel", max:2, min:1, unit:"items" }
    ] },
  { key:"rm_corrosives", label:"Corrosives", icon:"warning", uk:false, intl:false,
    details:"Not allowed UK or International.", checks:[], limits:[] },
  { key:"rm_device_lithium_not_connected", label:"Device with lithium batteries (not connected)", icon:"battery_alert", uk:true, intl:false,
    details:"Allowed UK only with strict lithium limits and packaging controls.",
    checks:["counter_presentation","sender_details_visible","short_circuit_protected","un38_3_compliant","batteries_not_damaged","secured_against_movement","prevent_accidental_activation","strong_outer_packaging"],
    limits:[
      { id:"spare_batteries", label:"Spare batteries in parcel", max:2, min:0, unit:"spares" },
      { id:"wh_per_cell", label:"Watt-hour per cell", max:20, min:0, unit:"Wh" },
      { id:"wh_per_battery", label:"Watt-hour per battery", max:100, min:0, unit:"Wh" },
      { id:"lithium_g_per_cell", label:"Lithium content per cell", max:1, min:0, unit:"grams" },
      { id:"lithium_g_per_battery", label:"Lithium content per battery", max:2, min:0, unit:"grams" },
      { id:"net_battery_kg", label:"Net battery mass per parcel", max:5, min:0.01, unit:"kg" }
    ] },
  { key:"rm_guns_sporting_use", label:"Guns for sporting use", icon:"gpp_bad", uk:true, intl:false,
    details:"Allowed UK only in compliance with law and controls. Sender details required.",
    checks:["uk_firearms_compliance","sender_details_visible"], limits:[] },
  { key:"rm_alcohol_up_to_24", label:"Alcohol up to 24% ABV", icon:"wine_bar", uk:true, intl:true,
    details:"Allowed UK and International. Max 1L per item with protective packaging.",
    checks:["wrapped_polythene_taped","absorbent_and_cushioned","fragile_if_glass"],
    limits:[
      { id:"volume_per_item_l", label:"Volume per item", max:1, min:0.1, unit:"litres" }
    ] },
  { key:"rm_ammunition", label:"Ammunition", icon:"block", uk:false, intl:false,
    details:"Not allowed UK or International.", checks:[], limits:[] },
  { key:"rm_batteries_dangerous_used", label:"Dangerous/used batteries", icon:"battery_alert", uk:false, intl:false,
    details:"Not allowed UK or International (includes car batteries, damaged batteries, power banks).", checks:[], limits:[] },
  { key:"rm_human_animal_ashes", label:"Human/animal ashes", icon:"public", uk:true, intl:true,
    details:"Allowed on Royal Mail services with sift-proof containment and sender details.",
    checks:["sift_proof_container","strong_outer_packaging","sender_details_visible"],
    limits:[
      { id:"ashes_weight_g", label:"Ashes per item", max:50, min:0.1, unit:"grams" }
    ] },
  { key:"rm_lighters_refills", label:"Lighters/refills (flammable)", icon:"block", uk:false, intl:false,
    details:"Not allowed UK or International.", checks:[], limits:[] },
  { key:"rm_new_consumer_batteries", label:"New alkaline/NiMH/NiCd batteries", icon:"battery_charging_full", uk:true, intl:true,
    details:"Allowed UK and International when new/unopened in original retail packaging with cushioning.",
    checks:["unopened_retail_batteries","absorbent_and_cushioned"], limits:[] },
  { key:"rm_lithium_not_with_device", label:"Lithium batteries not with device", icon:"battery_alert", uk:false, intl:false,
    details:"Not allowed UK or International (includes power banks).", checks:[], limits:[] },
  { key:"rm_device_lithium_connected", label:"Device with connected lithium battery", icon:"battery_charging_full", uk:true, intl:true,
    details:"Allowed UK and International with strict lithium limits and protective packaging.",
    checks:["counter_presentation","sender_details_visible","un38_3_compliant","batteries_not_damaged","secured_against_movement","prevent_accidental_activation","strong_outer_packaging"],
    limits:[
      { id:"installed_cells", label:"Installed cells in parcel", max:4, min:0, unit:"cells" },
      { id:"installed_batteries", label:"Installed batteries in parcel", max:2, min:0, unit:"batteries" },
      { id:"wh_per_cell", label:"Watt-hour per cell", max:20, min:0, unit:"Wh" },
      { id:"wh_per_battery", label:"Watt-hour per battery", max:100, min:0, unit:"Wh" },
      { id:"lithium_g_per_cell", label:"Lithium content per cell", max:1, min:0, unit:"grams" },
      { id:"lithium_g_per_battery", label:"Lithium content per battery", max:2, min:0, unit:"grams" },
      { id:"net_battery_kg", label:"Net battery mass per parcel", max:5, min:0.01, unit:"kg" }
    ],
    limitAnyOf:["installed_cells","installed_batteries"],
    limitAnyOfLabel:"Enter either installed cells or installed batteries above zero." },
  { key:"rm_liquids_over_1l", label:"Liquids over 1 litre (non-DG)", icon:"water_drop", uk:true, intl:false,
    details:"Allowed UK only with leakproof inner/outer packaging and FRAGILE marking for glass.",
    checks:["leakproof_inner_and_outer","fragile_if_glass"],
    limits:[
      { id:"container_volume_l", label:"Volume per container", max:5, min:1.01, unit:"litres" }
    ] },
  { key:"rm_liquids_under_1l", label:"Liquids under 1 litre (non-DG)", icon:"water_drop", uk:true, intl:true,
    details:"Allowed UK and International with leakproof inner/outer packaging and FRAGILE marking for glass.",
    checks:["leakproof_inner_and_outer","fragile_if_glass"],
    limits:[
      { id:"container_volume_l", label:"Volume per container", max:1, min:0.01, unit:"litres" }
    ] },
  { key:"rm_wet_non_spillable_battery", label:"New wet non-spillable battery", icon:"battery_charging_full", uk:true, intl:false,
    details:"Allowed UK only. Max one battery per parcel and max 1.5kg.",
    checks:["short_circuit_protected","strong_outer_packaging","package_marked_spa67_sp238"],
    limits:[
      { id:"batteries_per_parcel", label:"Batteries per parcel", max:1, min:1, unit:"battery" },
      { id:"battery_weight_kg", label:"Battery weight", max:1.5, min:0.01, unit:"kg" }
    ] },
  { key:"rm_environmentally_hazardous", label:"Environmentally hazardous substances", icon:"science", uk:true, intl:false,
    details:"Allowed UK only with leakproof/sift-proof inner packaging and rigid outer protection.",
    checks:["leakproof_inner_and_outer","strong_outer_packaging"],
    limits:[
      { id:"sample_total_l_kg", label:"Total sample quantity", max:5, min:0.01, unit:"L/kg" }
    ] },
  { key:"rm_biological_substance_cat_b", label:"Biological substances (Category B)", icon:"science", uk:true, intl:false,
    details:"Allowed UK only. Max 50ml/50g total and PI650-compliant packaging.",
    checks:["pi650_packaging"],
    limits:[
      { id:"sample_total_ml_g", label:"Total sample quantity", max:50, min:0.01, unit:"ml/g" }
    ] },
  { key:"rm_environmental_waste", label:"Environmental waste", icon:"block", uk:false, intl:false,
    details:"Not allowed UK or International (for example used batteries/oil).", checks:[], limits:[] },
  { key:"rm_explosives", label:"Explosives/fireworks/flares", icon:"block", uk:false, intl:false,
    details:"Not allowed UK or International.", checks:[], limits:[] },
  { key:"rm_live_creatures", label:"Live creatures/insects/invertebrates", icon:"pets", uk:true, intl:false,
    details:"Allowed UK only with restrictions. Prohibited from Great Britain to Northern Ireland.",
    checks:["live_species_permitted","live_packaging_compliant","no_fish_or_fry"], limits:[],
    niRule:"live_creatures_forbidden" },
  { key:"rm_magnetised_material", label:"Magnetised material", icon:"warning", uk:false, intl:false,
    details:"Not allowed UK or International.", checks:[], limits:[] },
  { key:"rm_matches", label:"Matches", icon:"block", uk:false, intl:false,
    details:"Not allowed UK or International.", checks:[], limits:[] },
  { key:"rm_nail_varnish", label:"Nail varnish/polish/gel", icon:"brush", uk:true, intl:false,
    details:"Allowed UK only. Max 30ml per item and 4 items per parcel. Counter presentation and sender details required.",
    checks:["strong_outer_packaging","absorbent_and_cushioned","counter_presentation","sender_details_visible"],
    limits:[
      { id:"volume_per_item_ml", label:"Volume per item", max:30, min:0.1, unit:"ml" },
      { id:"items_per_parcel", label:"Items in parcel", max:4, min:1, unit:"items" }
    ] },
  { key:"rm_oxidising_peroxides", label:"Oxidising materials/peroxides", icon:"warning", uk:false, intl:false,
    details:"Not allowed UK or International.", checks:[], limits:[] },
  { key:"rm_patient_specimens", label:"Patient specimens", icon:"science", uk:true, intl:false,
    details:"Allowed UK only at medical/lab request with approved kit and required markings.",
    checks:["sample_kit_used","exempt_specimen_marking","strong_outer_packaging"],
    limits:[
      { id:"sample_total_ml_g", label:"Total sample quantity", max:250, min:0.01, unit:"ml/g" }
    ] },
  { key:"rm_perfume_aftershave", label:"Perfume/aftershave", icon:"spa", uk:true, intl:false,
    details:"Allowed UK only. Max 150ml per item and 4 items per parcel in original retail packaging.",
    checks:["original_retail_packaging","strong_outer_packaging","absorbent_and_cushioned","counter_presentation","sender_details_visible"],
    limits:[
      { id:"volume_per_item_ml", label:"Volume per item", max:150, min:0.1, unit:"ml" },
      { id:"items_per_parcel", label:"Items in parcel", max:4, min:1, unit:"items" }
    ] },
  { key:"rm_perishables", label:"Perishables", icon:"eco", uk:true, intl:false,
    details:"Allowed UK only with packaging controls. Additional prohibitions/requirements apply on Great Britain to Northern Ireland routes.",
    checks:["no_leakage_or_tainting","perishable_label_applied"], limits:[],
    niRule:"perishable_extra" },
  { key:"rm_pesticides", label:"Pesticides", icon:"pest_control", uk:false, intl:false,
    details:"Not allowed UK or International.", checks:[], limits:[] },
  { key:"rm_poisons_toxic", label:"Poisons/toxic substances", icon:"dangerous", uk:false, intl:false,
    details:"Not allowed UK or International.", checks:[], limits:[] },
  { key:"rm_prescription_toxic_flammable", label:"Prescription medicines (toxic/flammable)", icon:"medication", uk:true, intl:false,
    details:"Allowed UK only with strict packaging and max 500ml/500g net quantity per parcel.",
    checks:["toxic_medicine_packaging","sender_details_visible","strong_outer_packaging"],
    limits:[
      { id:"net_quantity_ml_g", label:"Net quantity per parcel", max:500, min:0.01, unit:"ml/g" }
    ] },
  { key:"rm_prescription_non_toxic", label:"Prescription medicines (non-toxic/non-flammable)", icon:"medication", uk:true, intl:true,
    details:"Allowed UK and International with strict packaging and max 1 litre/1kg net quantity per parcel.",
    checks:["non_toxic_medicine_packaging","sender_details_visible","strong_outer_packaging"],
    limits:[
      { id:"net_quantity_l_kg", label:"Net quantity per parcel", max:1, min:0.01, unit:"L/kg" }
    ] },
  { key:"rm_radioactive_materials", label:"Radioactive materials/samples", icon:"dangerous", uk:false, intl:false,
    details:"Not allowed UK or International.", checks:[], limits:[] },
  { key:"rm_sharp_pointed_items", label:"Sharp/pointed items", icon:"content_cut", uk:true, intl:true,
    details:"Allowed UK and International when points/edges are fully protected and cannot pierce packaging.",
    checks:["no_risk_to_handlers","strong_outer_packaging"], limits:[] },
  { key:"rm_solvent_paints_varnish", label:"Solvent paints/varnish/enamels", icon:"block", uk:false, intl:false,
    details:"Not allowed UK or International.", checks:[], limits:[] },
  { key:"rm_waste_dirt_filth", label:"Waste/dirt/filth/refuse", icon:"block", uk:false, intl:false,
    details:"Not allowed UK or International. Soil samples are only allowed for analysis when leaks are contained.",
    checks:["soils_only_if_analysis"], limits:[] },
  { key:"rm_weapons", label:"Weapons", icon:"gpp_bad", uk:false, intl:false,
    details:"Not allowed UK or International.", checks:[], limits:[] },
];

// Grouped RM category tiles for a cleaner first DG screen.
// Follow-up options are shown after selecting one of these groups.
const RM_GROUPS = [
  {
    key:"rmg_aerosol_perfume",
    label:"Aerosols / perfume / nail",
    icon:"air",
    prompt:"Select the best match for aerosol/perfume/nail products.",
    ruleKeys:[
      "rm_aerosols_toiletry_medicinal",
      "rm_aerosols_other",
      "rm_perfume_aftershave",
      "rm_nail_varnish"
    ]
  },
  {
    key:"rmg_alcohol",
    label:"Alcohol (all strengths)",
    icon:"liquor",
    prompt:"Select the alcohol strength band.",
    ruleKeys:[
      "rm_alcohol_up_to_24",
      "rm_alcohol_24_to_70",
      "rm_alcohol_over_70"
    ]
  },
  {
    key:"rmg_batteries_lithium",
    label:"Batteries / lithium",
    icon:"battery_alert",
    prompt:"Select how the batteries are being sent.",
    ruleKeys:[
      "rm_device_lithium_connected",
      "rm_device_lithium_not_connected",
      "rm_lithium_not_with_device",
      "rm_batteries_dangerous_used",
      "rm_new_consumer_batteries",
      "rm_wet_non_spillable_battery"
    ]
  },
  {
    key:"rmg_medicines_samples",
    label:"Medicines / specimens",
    icon:"medication",
    prompt:"Select the medicine or specimen type.",
    ruleKeys:[
      "rm_prescription_non_toxic",
      "rm_prescription_toxic_flammable",
      "rm_patient_specimens",
      "rm_biological_substance_cat_b",
      "rm_clinical_medical_waste"
    ]
  },
  {
    key:"rmg_chemicals_liquids",
    label:"Chemicals / liquids",
    icon:"science",
    prompt:"Select the chemical or liquid category.",
    ruleKeys:[
      "rm_liquids_under_1l",
      "rm_liquids_over_1l",
      "rm_flammable_liquids",
      "rm_flammable_solids",
      "rm_corrosives",
      "rm_oxidising_peroxides",
      "rm_environmentally_hazardous",
      "rm_pesticides",
      "rm_poisons_toxic",
      "rm_radioactive_materials",
      "rm_solvent_paints_varnish"
    ]
  },
  {
    key:"rmg_gas_explosives",
    label:"Gases / explosives",
    icon:"warning",
    prompt:"Select the gas or explosive type.",
    ruleKeys:[
      "rm_gases",
      "rm_lighters_refills",
      "rm_explosives",
      "rm_matches"
    ]
  },
  {
    key:"rmg_weapons_blades",
    label:"Weapons / blades / ammo",
    icon:"gpp_bad",
    prompt:"Select the weapon or blade type.",
    ruleKeys:[
      "rm_weapons",
      "rm_bladed_items",
      "rm_sharp_pointed_items",
      "rm_guns_sporting_use",
      "rm_ammunition"
    ]
  },
  {
    key:"rmg_perishable_live",
    label:"Perishables / live / ashes",
    icon:"eco",
    prompt:"Select the perishable or live-content category.",
    ruleKeys:[
      "rm_perishables",
      "rm_live_creatures",
      "rm_human_animal_ashes"
    ]
  },
  {
    key:"rmg_controlled_misc",
    label:"Controlled / waste / misc",
    icon:"gavel",
    prompt:"Select the best match for controlled, waste, or special material items.",
    ruleKeys:[
      "rm_controlled_drugs",
      "rm_environmental_waste",
      "rm_waste_dirt_filth",
      "rm_magnetised_material"
    ]
  }
];

// COVER LIMITS: Loss-only (refund if lost, not damage)
const LOSS_ONLY = [
  { key:"antiques", label:"Antiques (100+ yrs)", icon:"museum",
    details:"Not protected for damage. If lost in the carrier network, carriage and item value can be refunded when parcel protection is in place." },

  { key:"wood_flooring", label:"Wooden flooring", icon:"grid_on",
    details:"Any type of wooden flooring, including laminate, is not protected for damage. If lost, carriage and item value can be refunded when parcel protection is in place." },

  { key:"coffee_machines", label:"Coffee machines", icon:"coffee_maker",
    details:"Coffee machines, coffee grinders, and coffee roasters are not protected for damage. If lost, carriage and item value can be refunded when parcel protection is in place." },

  { key:"cycles", label:"Cycles", icon:"pedal_bike",
    details:"Cycles, bicycles, unicycles, and tricycles are not protected for damage. Maximum parcel protection value for loss is GBP 1,000." },

  { key:"electrical_appliances", label:"Electrical appliances", icon:"devices",
    details:"Electrical appliances that are not white goods are not protected for damage, including cameras, monitors, computers, all-in-one computers, drones, lamps, laptops, scanners, TVs, and projectors." },

  { key:"fishing_rods", label:"Fishing rods", icon:"sports_and_outdoors",
    details:"Fishing rods are not protected for damage. If lost, carriage and item value can be refunded when parcel protection is in place." },

  { key:"furniture", label:"Furniture", icon:"weekend",
    details:"Furniture is not protected for damage. If lost, carriage and item value can be refunded when parcel protection is in place." },

  { key:"sewing_knitting", label:"Sewing/knitting machines", icon:"precision_manufacturing",
    details:"Knitting machines and sewing machines are not protected for damage. If lost, carriage and item value can be refunded when parcel protection is in place." },

  { key:"models_kits", label:"Models / kits", icon:"view_in_ar",
    details:"Models and kits are not protected for damage. If lost, carriage and item value can be refunded when parcel protection is in place." },

  { key:"musical_instruments", label:"Musical instruments", icon:"music_note",
    details:"Musical instruments, including guitars, amplifiers, speakers, turntables, violins, and keyboards, are not protected for damage. Items must be sent in a hard case and boxed. Maximum parcel protection value for loss is GBP 1,000." },

  { key:"suitcase_packaging", label:"Suitcase as packaging", icon:"luggage",
    details:"A suitcase is not protected if it is used as packaging for internal items." },

  { key:"surfboard", label:"Surfboard", icon:"surfing",
    details:"Surfboards are not protected for damage. If lost, carriage and item value can be refunded when parcel protection is in place." },

  { key:"telescopes", label:"Telescopes/microscopes", icon:"biotech",
    details:"Telescopes and microscopes are not protected for damage. If lost, carriage and item value can be refunded when parcel protection is in place." },

  { key:"wall_decor", label:"Wall décor / frames", icon:"photo_frame",
    details:"Wall decor items are not protected for damage, including canvas prints, clocks, framed pictures, pictures, posters, prints, and paintings." },
];

// COVER LIMITS: No compensation (sender’s risk)
const NO_COMP = [
  { key:"ceramics_stone", label:"Ceramics / stone", icon:"category",
    details:"No compensation: ceramics, porcelain, china, and stone items, including tiles, sinks, basins, toilets, baths, concrete, crockery, granite, marble, vases, pottery, and plates." },

  { key:"glass", label:"Glass items", icon:"wine_bar",
    details:"No compensation: glass items of any type, including glassware, crystal, bulbs, screens, fiberglass, fish tanks, mirrors, spectacles, windows, and perspex." },

  { key:"packaging", label:"Packaging", icon:"inventory_2",
    details:"No compensation: packaging items, including the box, media packaging, and suitcases used as packaging." },

  { key:"precious_metals", label:"Precious metals / gems", icon:"diamond",
    details:"No compensation: precious metals and stones, including gold, silver, gems, and diamonds, including in jewellery form." },

  { key:"small_vehicle_parts", label:"Small vehicle parts", icon:"build",
    details:"No compensation: small vehicle parts, including headlights, taillights, and gearboxes." },

  { key:"watches", label:"Watches", icon:"watch",
    details:"No compensation: watches are carried at sender risk." },
];

// SERVICE CATALOGUE (demo only)
const SERVICES = [
  { id:"evri_standard", profile:"evri_dpd", name:"EVRi Standard", tracked:true, intl:false, maxWeight:15000, basePrice:3.69, deliveryPreference:"two_to_three_days" },
  { id:"dpd_next_day", profile:"evri_dpd", name:"DPD Next Day", tracked:true, intl:false, maxWeight:20000, basePrice:6.99, deliveryPreference:"guaranteed_next_day" },
  { id:"dpd_classic", profile:"evri_dpd", name:"DPD Classic", tracked:true, intl:false, maxWeight:30000, basePrice:5.49, deliveryPreference:"two_to_three_days" },
  { id:"evri_international", profile:"evri_dpd", name:"EVRi International", tracked:true, intl:true, maxWeight:10000, basePrice:9.99, deliveryPreference:"" },
  { id:"rm_2nd_class", profile:"royal_mail", name:"Royal Mail 2nd Class", tracked:false, intl:false, maxWeight:20000, basePrice:3.39, deliveryPreference:"two_to_three_days" },
  { id:"rm_1st_class", profile:"royal_mail", name:"Royal Mail 1st Class", tracked:false, intl:false, maxWeight:20000, basePrice:4.59, deliveryPreference:"aimed_next_day" },
  { id:"rm_tracked_48", profile:"royal_mail", name:"RM Tracked 48", tracked:true, intl:false, maxWeight:20000, basePrice:4.99, deliveryPreference:"two_to_three_days" },
  { id:"rm_tracked_24", profile:"royal_mail", name:"RM Tracked 24", tracked:true, intl:false, maxWeight:20000, basePrice:6.29, deliveryPreference:"aimed_next_day" },
  { id:"rm_special_next_day", profile:"royal_mail", name:"RM Special Guaranteed", tracked:true, intl:false, maxWeight:20000, basePrice:8.99, deliveryPreference:"guaranteed_next_day" },
  { id:"rm_international_tracked", profile:"royal_mail", name:"RM International Tracked", tracked:true, intl:true, maxWeight:2000, basePrice:11.99, deliveryPreference:"" },
];

// Reference-data model for domestic delivery preferences.
// Can be overridden at runtime via window.KIOSK_REFERENCE_DATA or localStorage key kiosk_reference_data.
const DEFAULT_REFERENCE_DATA = {
  domesticDeliveryPreferences: [
    { key:"guaranteed_next_day", label:"Guaranteed next day" },
    { key:"aimed_next_day", label:"Aimed to deliver next day" },
    { key:"two_to_three_days", label:"2-3 working days" }
  ],
  domesticDeliveryPreferenceServiceMap: {
    guaranteed_next_day: ["dpd_next_day", "rm_special_next_day"],
    aimed_next_day: ["rm_1st_class", "rm_tracked_24"],
    two_to_three_days: ["evri_standard", "dpd_classic", "rm_2nd_class", "rm_tracked_48"]
  }
};

function loadReferenceData(){
  const ref = JSON.parse(JSON.stringify(DEFAULT_REFERENCE_DATA));
  let override = null;
  if(typeof window !== "undefined"){
    if(window.KIOSK_REFERENCE_DATA && typeof window.KIOSK_REFERENCE_DATA === "object"){
      override = window.KIOSK_REFERENCE_DATA;
    } else {
      try{
        const raw = window.localStorage ? window.localStorage.getItem("kiosk_reference_data") : null;
        if(raw) override = JSON.parse(raw);
      } catch(_err){
        override = null;
      }
    }
  }
  if(!override || typeof override !== "object") return ref;

  if(Array.isArray(override.domesticDeliveryPreferences)){
    const options = override.domesticDeliveryPreferences
      .filter(opt => opt && typeof opt.key === "string" && typeof opt.label === "string")
      .map(opt => ({ key: String(opt.key), label: String(opt.label) }));
    if(options.length){
      ref.domesticDeliveryPreferences = options;
    }
  }
  if(override.domesticDeliveryPreferenceServiceMap && typeof override.domesticDeliveryPreferenceServiceMap === "object"){
    const map = {};
    Object.keys(override.domesticDeliveryPreferenceServiceMap).forEach(key => {
      const ids = override.domesticDeliveryPreferenceServiceMap[key];
      if(Array.isArray(ids)){
        map[key] = ids.map(id => String(id));
      }
    });
    if(Object.keys(map).length){
      ref.domesticDeliveryPreferenceServiceMap = map;
    }
  }
  return ref;
}

const REFERENCE_DATA = loadReferenceData();

/* ---------------------------
   Helpers
---------------------------- */
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function padTo25(list){
  const out = [...list];
  while(out.length < 25){
    out.push({ key:`_blank_${out.length}`, label:"", icon:"block", details:"", blank:true });
  }
  return out.slice(0,25);
}
function setDestinationPill(){
  const destLabel = document.getElementById("destLabel");
  const pill = document.getElementById("destPill");
  if(!state.destination){
    destLabel.textContent = "Not set";
    pill.style.opacity = 0.75;
    return;
  }
  pill.style.opacity = 1;
  destLabel.textContent = state.destination === "uk" ? "UK" : "International";
}

function applyDestinationSelection(value){
  state.destination = value || "";
  state.selectedServiceId = "";
  state.productProfile = "royal_mail";
  state.niCustomsConfirmed = false;
  state.niCustomsReference = "";
  state.niSpsCategory = "";
  state.niPrivateIndividual = "";
  state.rmNiPerishableRoute = "";
  state.rmNiPlantCertRef = "";
  state.rmSelectedKey = null;
  state.rmBlockedKey = null;
  state.rmOtherSelected = false;
  resetRMConditionCapture();
  if(state.destination === "uk"){
    if(!domesticDeliveryPreferences().some(opt => opt.key === state.deliverySpeed)){
      state.deliverySpeed = "";
    }
  } else {
    state.deliverySpeed = "";
  }
  state.evriScreeningOpen = false;
  state.evriAdditionalSelection = "";
  state.evriSelectedProhibitedKey = null;
  state.evriAdditionalBlocked = false;
  state.evriScreeningComplete = false;
  state.evriLossOnlySelected = false;
  state.evriNoCompSelected = false;
  setDestinationPill();
}

function isBTPostcode(value){
  return /^BT/i.test((value || "").trim());
}

function isGBToNIJourney(){
  return state.destination === "uk"
    && isBTPostcode(state.recipientPostcode)
    && !!state.senderPostcode
    && !isBTPostcode(state.senderPostcode);
}

function currentRMRule(){
  return RM_FILTER.find(x => x.key === state.rmSelectedKey) || null;
}

function rmRuleAllowed(rule){
  if(!rule) return false;
  return state.destination === "uk" ? !!rule.uk : !!rule.intl;
}

function rmRuleRequirements(rule){
  if(!rule) return { checks: [], limits: [], limitAnyOf: [], limitAnyOfLabel: "" };
  const checks = (rule.checks || []).map(id => ({
    id,
    label: RM_CHECK_LABELS[id] || id
  }));
  const limits = (rule.limits || []).map(limit => ({
    id: limit.id,
    label: limit.label,
    max: limit.max,
    min: limit.min ?? 0,
    unit: limit.unit || "",
    step: limit.step || "any"
  }));
  return {
    checks,
    limits,
    limitAnyOf: rule.limitAnyOf || [],
    limitAnyOfLabel: rule.limitAnyOfLabel || ""
  };
}

function rmRulesForGroup(groupKey){
  const group = RM_GROUPS.find(x => x.key === groupKey);
  if(!group) return [];
  return group.ruleKeys
    .map(key => RM_FILTER.find(rule => rule.key === key))
    .filter(Boolean);
}

function rmGroupForRule(ruleKey){
  if(!ruleKey) return null;
  return RM_GROUPS.find(group => group.ruleKeys.includes(ruleKey)) || null;
}

function resetRMConditionCapture(){
  state.rmConditionChecks = {};
  state.rmConditionValues = {};
  state.rmConditionSatisfied = false;
}

function applyQuickDemoRMConditionCapture(rule){
  const requirements = rmRuleRequirements(rule);
  requirements.checks.forEach(check => {
    state.rmConditionChecks[check.id] = true;
  });
  requirements.limits.forEach(limit => {
    const min = Number(limit.min ?? 0);
    const max = Number(limit.max ?? 1);
    let auto = min > 0 ? min : 1;
    if(auto > max) auto = max;
    state.rmConditionValues[limit.id] = String(auto);
  });
  if(requirements.limitAnyOf.length){
    const key = requirements.limitAnyOf[0];
    if(!state.rmConditionValues[key] || Number.parseFloat(state.rmConditionValues[key]) <= 0){
      state.rmConditionValues[key] = "1";
    }
  }
}

function validateRMConditionCapture(rule){
  const requirements = rmRuleRequirements(rule);
  const problems = [];

  requirements.checks.forEach(check => {
    if(!state.rmConditionChecks[check.id]){
      problems.push(`Confirm: ${check.label}`);
    }
  });

  requirements.limits.forEach(limit => {
    const raw = (state.rmConditionValues[limit.id] || "").trim();
    const value = Number.parseFloat(raw);
    if(raw === "" || !Number.isFinite(value)){
      problems.push(`Enter ${limit.label}`);
      return;
    }
    if(value < limit.min || value > limit.max){
      problems.push(`${limit.label} must be ${limit.min} to ${limit.max}${limit.unit ? ` ${limit.unit}` : ""}`);
    }
  });

  if(requirements.limitAnyOf.length){
    const anyOk = requirements.limitAnyOf.some(limitId => {
      const raw = (state.rmConditionValues[limitId] || "").trim();
      const value = Number.parseFloat(raw);
      return Number.isFinite(value) && value > 0;
    });
    if(!anyOk){
      problems.push(requirements.limitAnyOfLabel || "Complete at least one required quantity field.");
    }
  }

  return problems;
}

function rmNIStatus(){
  const rule = currentRMRule();
  if(!rule) return { ok: true, blocked: false, message: "" };
  if(!isGBToNIJourney()) return { ok: true, blocked: false, message: "" };

  if(rule.niRule === "live_creatures_forbidden"){
    return {
      ok: false,
      blocked: true,
      message: "Live creatures/insects are prohibited from Great Britain to Northern Ireland."
    };
  }

  if(rule.niRule === "perishable_extra"){
    if(state.niSpsCategory !== "yes" && state.niSpsCategory !== "no"){
      return { ok: false, blocked: false, message: "Select whether SPS goods are included for this GB to NI journey." };
    }
    if(state.niSpsCategory === "no"){
      return { ok: true, blocked: false, message: "" };
    }
    if(!state.rmNiPerishableRoute){
      return { ok: false, blocked: false, message: "Select the perishable content route for Great Britain to Northern Ireland." };
    }
    if(state.rmNiPerishableRoute === "contains_prohibited"){
      return {
        ok: false,
        blocked: true,
        message: "Perishables containing meat, dairy, or pet food are prohibited on this Great Britain to Northern Ireland route."
      };
    }
    if(state.rmNiPerishableRoute === "plants_certified" && !state.rmNiPlantCertRef.trim()){
      return { ok: false, blocked: false, message: "Enter the plant/flower certification reference." };
    }
  }

  return { ok: true, blocked: false, message: "" };
}

function numericValue(value){
  const parsed = Number.parseFloat(value);
  return Number.isFinite(parsed) ? parsed : 0;
}

function isDomesticJourney(){
  return state.destination === "uk";
}

function domesticDeliveryPreferences(){
  return Array.isArray(REFERENCE_DATA.domesticDeliveryPreferences)
    ? REFERENCE_DATA.domesticDeliveryPreferences
    : [];
}

function deliveryPreferenceLabel(code){
  const option = domesticDeliveryPreferences().find(x => x.key === code);
  return option ? option.label : "Not selected";
}

function isValidDomesticDeliveryPreference(code){
  return domesticDeliveryPreferences().some(option => option.key === code);
}

function deliveryPreferenceServiceIds(code){
  const map = REFERENCE_DATA.domesticDeliveryPreferenceServiceMap || {};
  const ids = map[code];
  return Array.isArray(ids) ? ids : [];
}

function serviceMatchesDeliveryPreference(service, code){
  const mappedIds = deliveryPreferenceServiceIds(code);
  if(mappedIds.length){
    return mappedIds.includes(service.id);
  }
  return service.deliveryPreference === code;
}

function deliveryPreferenceIndicativeFrom(code){
  const candidates = SERVICES.filter(service =>
    !service.intl && serviceMatchesDeliveryPreference(service, code)
  );
  if(!candidates.length) return null;
  const min = candidates.reduce((lowest, service) => Math.min(lowest, service.basePrice), Number.POSITIVE_INFINITY);
  return Number.isFinite(min) ? Number(min.toFixed(2)) : null;
}

function logAudit(eventType, payload = {}){
  const entry = {
    at: new Date().toISOString(),
    eventType,
    ...payload
  };
  state.auditEvents.push(entry);
  if(state.auditEvents.length > 100){
    state.auditEvents.splice(0, state.auditEvents.length - 100);
  }
  if(typeof console !== "undefined" && typeof console.info === "function"){
    console.info("[AUDIT]", entry);
  }
}

function selectedService(){
  return SERVICES.find(s => s.id === state.selectedServiceId) || null;
}

function calculateServicePrice(service){
  const weight = Number.parseInt(state.weightG || "0", 10) || 0;
  const weightAdd = weight > 2000 ? Math.ceil((weight - 2000) / 1000) * 0.35 : 0;
  return Number((service.basePrice + weightAdd).toFixed(2));
}

function availableServices(){
  const weight = Number.parseInt(state.weightG || "0", 10) || 0;
  const isIntl = state.destination === "intl";
  let list = [...SERVICES];
  list = list.filter(s => s.maxWeight >= weight);
  list = list.filter(s => isIntl ? s.intl : true);
  if(!isIntl) list = list.filter(s => s.intl ? false : true);

  if(!isIntl && isValidDomesticDeliveryPreference(state.deliverySpeed)){
    list = list.filter(service => serviceMatchesDeliveryPreference(service, state.deliverySpeed));
  }

  // Prioritise tracked services in display order (mirrors KIOSK-415 intent).
  return list.sort((a,b) => Number(b.tracked) - Number(a.tracked) || calculateServicePrice(a) - calculateServicePrice(b));
}

function basketTotal(){
  const service = selectedService();
  if(!service) return 0;
  const base = calculateServicePrice(service);
  const pod = state.proofOfDelivery ? 1.5 : 0;
  return Number((base + pod).toFixed(2));
}

function applyQuickDemoDefaults(){
  if(!state.quickDemoMode) return;

  if(!state.weightG) state.weightG = "850";
  if(state.weightG) state.manualWeightEditOpen = false;
  if(!state.destination) state.destination = "uk";
  if(!state.format) state.format = "parcel";
  if(!state.rmSelectedKey){
    state.rmSelectedKey = "rm_other_not_listed";
    state.rmOtherSelected = true;
    state.rmBlockedKey = null;
    state.rmConditionSatisfied = true;
  }
  if(state.rmSelectedKey && state.rmSelectedKey !== "rm_other_not_listed"){
    const rule = currentRMRule();
    if(rule && rmRuleAllowed(rule)){
      if(!state.rmConditionSatisfied){
        applyQuickDemoRMConditionCapture(rule);
        state.rmConditionSatisfied = validateRMConditionCapture(rule).length === 0;
      }
      state.rmBlockedKey = null;
      state.rmOtherSelected = false;
    }
  }

  if(!state.declaredValue) state.declaredValue = "39.99";
  if(!state.contentDescription) state.contentDescription = "Books and stationery";
  if(isDomesticJourney()){
    const prefs = domesticDeliveryPreferences();
    const valid = prefs.some(opt => opt.key === state.deliverySpeed);
    if(!valid){
      state.deliverySpeed = (prefs.find(opt => opt.key === "two_to_three_days") || prefs[0] || { key:"" }).key;
    }
  } else {
    state.deliverySpeed = "";
  }
  if(!state.recipientPostcode) state.recipientPostcode = "BT1 5GS";
  if(!state.recipientAddress) state.recipientAddress = "1 Royal Avenue, Belfast";
  if(!state.senderPostcode) state.senderPostcode = "EC1A 1AA";
  if(!state.senderAddress) state.senderAddress = "185 Farringdon Road, London";
  if(state.destination === "uk" && isBTPostcode(state.recipientPostcode)){
    if(!state.niCustomsReference) state.niCustomsReference = "NI-EXAMPLE-001";
    if(!state.niSpsCategory) state.niSpsCategory = "no";
    if(!state.niPrivateIndividual) state.niPrivateIndividual = "yes";
    if(!state.rmNiPerishableRoute) state.rmNiPerishableRoute = "confectionery_only";
    if(!state.rmNiPlantCertRef) state.rmNiPlantCertRef = "NI-CERT-001";
    state.niCustomsConfirmed = true;
  }
  state.proofOfDelivery = true;

  const options = availableServices();
  if(options.length && !options.some(s=>s.id===state.selectedServiceId)){
    const rmOption = options.find(s => s.profile === "royal_mail");
    state.selectedServiceId = rmOption ? rmOption.id : options[0].id;
  }
  const selected = selectedService();
  if(selected){
    state.productProfile = selected.profile;
  }
  if(selected && selected.profile === "evri_dpd"){
    state.evriScreeningOpen = false;
    state.evriAdditionalSelection = "clear";
    state.evriSelectedProhibitedKey = null;
    state.evriAdditionalBlocked = false;
    state.evriScreeningComplete = true;
  }

  if(!state.paymentMethod) state.paymentMethod = "card";
  state.paymentComplete = true;
  if(!state.transactionRef){
    state.transactionRef = "TX-DEMO01";
  }
}

/* ---------------------------
   Rendering
---------------------------- */
const screen = document.getElementById("screen");
const progress = document.getElementById("progress");
const crumbBar = document.getElementById("crumbBar");
const chromeEl = document.querySelector(".chrome");
const vkWrap = document.getElementById("vkWrap");
const vkHead = document.getElementById("vkHead");
const vkMirror = document.getElementById("vkMirror");
const vkRows = document.getElementById("vkRows");
const vkCancelBtn = document.getElementById("vkCancelBtn");
const vkDoneBtn = document.getElementById("vkDoneBtn");
const nextBtn = document.getElementById("nextBtn");
const backBtn = document.getElementById("backBtn");
const resetBtn = document.getElementById("resetBtn");
const cancelBtn = document.getElementById("cancelBtn");
const helpBtn = document.getElementById("helpBtn");

function stepCount(){ return 6; }

const VK_ROWS = [
  ["1","2","3","4","5","6","7","8","9","0","DELETE"],
  ["Q","W","E","R","T","Y","U","I","O","P"],
  ["A","S","D","F","G","H","J","K","L"],
  ["Z","X","C","V","B","N","M","SPACE"]
];

const vkState = {
  open: false,
  targetId: "",
  title: "",
  maxLen: 80,
  uppercase: false,
  value: ""
};

function syncVirtualKeyboardToTarget(){
  if(!vkState.targetId) return;
  const target = document.getElementById(vkState.targetId);
  if(!target) return;
  target.value = vkState.value;
  target.dispatchEvent(new Event("input", { bubbles: true }));
}

function renderVirtualKeyboard(){
  vkHead.textContent = vkState.title || "Enter details";
  vkMirror.textContent = vkState.value || " ";
  vkRows.innerHTML = "";

  VK_ROWS.forEach(row => {
    const rowEl = document.createElement("div");
    rowEl.className = "vkRow";
    rowEl.style.setProperty("--vk-cols", String(row.length));
    row.forEach(key => {
      const keyEl = document.createElement("button");
      keyEl.type = "button";
      keyEl.className = `vkKey ${key === "DELETE" || key === "SPACE" ? "action" : ""}`;
      keyEl.dataset.key = key;
      keyEl.textContent = key === "DELETE" ? "Delete" : (key === "SPACE" ? "Space" : key);
      rowEl.appendChild(keyEl);
    });
    vkRows.appendChild(rowEl);
  });
}

function closeVirtualKeyboard(){
  vkState.open = false;
  vkState.targetId = "";
  vkWrap.classList.remove("show");
  vkWrap.setAttribute("aria-hidden", "true");
  chromeEl.classList.remove("keyboard-open");
}

function openVirtualKeyboard(input, options = {}){
  if(!input || !input.id) return;
  vkState.open = true;
  vkState.targetId = input.id;
  vkState.title = options.title || "Enter details";
  vkState.maxLen = Number(options.maxLen || 80);
  vkState.uppercase = !!options.uppercase;
  vkState.value = String(input.value || "");

  renderVirtualKeyboard();
  vkWrap.classList.add("show");
  vkWrap.setAttribute("aria-hidden", "false");
  chromeEl.classList.add("keyboard-open");
}

function restoreVirtualKeyboard(){
  if(!vkState.open) return;
  if(state.step !== 4){
    closeVirtualKeyboard();
    return;
  }
  const target = document.getElementById(vkState.targetId);
  if(!target){
    closeVirtualKeyboard();
    return;
  }
  vkState.value = String(target.value || vkState.value || "");
  renderVirtualKeyboard();
  vkWrap.classList.add("show");
  vkWrap.setAttribute("aria-hidden", "false");
  chromeEl.classList.add("keyboard-open");
}

function bindKioskKeyboard(input, options = {}){
  if(!input || !input.id) return;
  input.readOnly = true;
  input.classList.add("kioskKeyboardInput");
  const open = () => openVirtualKeyboard(input, options);
  input.addEventListener("click", open);
  input.addEventListener("focus", open);
}

vkRows.addEventListener("click", (event)=>{
  const keyBtn = event.target.closest(".vkKey");
  if(!keyBtn) return;
  const key = keyBtn.dataset.key;
  if(!key || !vkState.open) return;

  if(key === "DELETE"){
    vkState.value = vkState.value.slice(0, -1);
  } else if(key === "SPACE"){
    vkState.value += " ";
  } else {
    vkState.value += key;
  }

  if(vkState.uppercase){
    vkState.value = vkState.value.toUpperCase();
  }
  if(Number.isFinite(vkState.maxLen) && vkState.maxLen > 0){
    vkState.value = vkState.value.slice(0, vkState.maxLen);
  }
  vkMirror.textContent = vkState.value || " ";
  syncVirtualKeyboardToTarget();
});

vkCancelBtn.addEventListener("click", ()=> closeVirtualKeyboard());
vkDoneBtn.addEventListener("click", ()=> closeVirtualKeyboard());

function updateProgress(){
  if(state.step === 0){
    progress.innerHTML = `Start <span class="wireframeFlag">Journey wireframe only</span>`;
  } else {
    progress.innerHTML = `Step ${state.step} of ${stepCount()} <span class="wireframeFlag">Journey wireframe only</span>`;
  }
  backBtn.disabled = (state.step <= 0);
}

let isScreenTransitioning = false;
function navigateToStep(targetStep){
  const target = Math.max(0, Math.min(stepCount(), targetStep));
  if(target === state.step){
    render();
    return;
  }
  if(isScreenTransitioning) return;
  closeVirtualKeyboard();
  isScreenTransitioning = true;

  const overlay = document.createElement("div");
  overlay.className = "screenRefreshOverlay";
  overlay.innerHTML = `
    <div class="screenRefreshCard">
      <span class="material-symbols-outlined">sync</span>
      Loading next screen...
    </div>
  `;
  const host = document.querySelector(".chrome");
  host.appendChild(overlay);
  requestAnimationFrame(()=> overlay.classList.add("show"));

  window.setTimeout(()=>{
    state.step = target;
    render();
    window.setTimeout(()=>{
      overlay.remove();
      isScreenTransitioning = false;
    }, 120);
  }, 180);
}

function renderLaunch(){
  if(!state.destination){
    applyDestinationSelection("uk");
  }

  screen.innerHTML = `
    <div class="launchHeader">What do you want to do today?</div>
    <div class="launchGrid">
      <button type="button" class="launchTile disabled" id="launchQrBtn">
        <span class="material-symbols-outlined">qr_code_scanner</span>
        <span>Scan QR code <span class="sub">Demo placeholder</span></span>
      </button>
      <button type="button" class="launchTile disabled" id="launchLabelBtn">
        <span class="material-symbols-outlined">local_post_office</span>
        <span>Scan pre-paid label <span class="sub">Demo placeholder</span></span>
      </button>
      <button type="button" class="launchTile active" id="launchPostBtn">
        <span class="material-symbols-outlined">inventory_2</span>
        <span>Post an item <span class="sub">Start postage journey</span></span>
      </button>
      <button type="button" class="launchTile disabled" id="launchStampsBtn">
        <span class="material-symbols-outlined">shopping_cart</span>
        <span>Purchase stamps <span class="sub">Demo placeholder</span></span>
      </button>
    </div>

    <div class="launchControls">
      <div class="launchControlCard">
        <h3>Destination</h3>
        <div class="launchControlRow">
          <button type="button" class="launchControlBtn ${state.destination === "uk" ? "active" : ""}" id="launchDestUkBtn">
            <span>UK (Inc NI)</span>
          </button>
          <button type="button" class="launchControlBtn ${state.destination === "intl" ? "active" : ""}" id="launchDestIntlBtn">
            <span>International</span>
          </button>
        </div>
      </div>
      <div class="launchControlCard">
        <h3>Demo Fast-Track</h3>
        <div class="launchControlRow">
          <button type="button" class="launchControlBtn ${!state.quickDemoMode ? "active" : ""}" id="launchDemoOffBtn">
            <span>Off</span>
          </button>
          <button type="button" class="launchControlBtn ${state.quickDemoMode ? "active" : ""}" id="launchDemoOnBtn">
            <span>On</span>
          </button>
        </div>
      </div>
    </div>
  `;

  document.getElementById("launchPostBtn").addEventListener("click", ()=>{
    navigateToStep(1);
  });
  ["launchQrBtn","launchLabelBtn","launchStampsBtn"].forEach(id => {
    const btn = document.getElementById(id);
    if(btn){
      btn.addEventListener("click", ()=>{
        alert("This option is not included in this wireframe. Use 'Post an item' to continue.");
      });
    }
  });

  document.getElementById("launchDestUkBtn").addEventListener("click", ()=>{
    applyDestinationSelection("uk");
    render();
  });
  document.getElementById("launchDestIntlBtn").addEventListener("click", ()=>{
    applyDestinationSelection("intl");
    render();
  });
  document.getElementById("launchDemoOffBtn").addEventListener("click", ()=>{
    state.quickDemoMode = false;
    render();
  });
  document.getElementById("launchDemoOnBtn").addEventListener("click", ()=>{
    state.quickDemoMode = true;
    applyQuickDemoDefaults();
    render();
  });
}

function updateBreadcrumb(){
  if(!crumbBar) return;
  if(state.step === 0){
    crumbBar.style.display = "none";
    return;
  }
  crumbBar.style.display = "flex";
  const service = selectedService();
  const fmt = ({ letter:"Letter", large_letter:"Large letter", parcel:"Parcel" })[state.format] || "Not set";
  const dest = state.destination === "uk" ? "UK (Inc NI)" : (state.destination === "intl" ? "International" : "Not set");
  const rmRule = currentRMRule();
  const rmDg = state.rmOtherSelected
    ? "Other / not listed"
    : (rmRule ? rmRule.label : "Not set");
  const value = numericValue(state.declaredValue) > 0
    ? `£${numericValue(state.declaredValue).toFixed(2)}`
    : "Not set";
  const speed = state.destination === "uk"
    ? deliveryPreferenceLabel(state.deliverySpeed || "")
    : "Skipped (Intl)";
  const niNeeded = state.destination === "uk" && isBTPostcode(state.recipientPostcode);
  const niStatus = niNeeded ? (state.niCustomsConfirmed ? "Captured" : "Pending") : "N/A";
  const carrierStatus = service && service.profile === "evri_dpd"
    ? (state.evriScreeningComplete ? "Screened" : "Pending")
    : "N/A";

  const allCrumbs = [
    { icon:"scale", label:"Weight", value: state.weightG ? `${state.weightG} g` : "Not set" },
    { icon:"public", label:"Destination", value: dest },
    { icon:"dangerous", label:"RM DG", value: rmDg },
    { icon:"straighten", label:"Format", value: fmt },
    { icon:"payments", label:"Value", value },
    { icon:"bolt", label:"Speed", value: speed },
    { icon:"local_shipping", label:"Service", value: service ? service.name : "Not set" },
    { icon:"location_on", label:"NI/Windsor", value: niStatus },
    { icon:"fact_check", label:"EVRi/DPD", value: carrierStatus }
  ];
  const crumbs = allCrumbs.filter(item =>
    item.value !== "Not set" && item.value !== "N/A" && item.value !== "Not selected"
  );

  if(!crumbs.length){
    crumbBar.innerHTML = `
      <span class="crumbPill">
        <span class="material-symbols-outlined">route</span>
        <span class="crumbLabel">Journey:</span>
        <span class="crumbValue">Capture details to build breadcrumb trail</span>
      </span>
    `;
    return;
  }

  crumbBar.innerHTML = crumbs.map(item => `
    <span class="crumbPill">
      <span class="material-symbols-outlined">${item.icon}</span>
      <span class="crumbLabel">${escapeHtml(item.label)}:</span>
      <span class="crumbValue">${escapeHtml(item.value)}</span>
    </span>
  `).join("");
}

function render(){
  applyQuickDemoDefaults();
  setDestinationPill();
  updateProgress();
  const destPill = document.getElementById("destPill");
  if(destPill){
    destPill.style.display = state.step === 0 ? "none" : "inline-flex";
  }

  if(state.step === 0) renderLaunch();
  else if(state.step === 1) renderWeigh();
  else if(state.step === 2) renderRMDangerous();
  else if(state.step === 3) renderCaptureItemDetails();
  else if(state.step === 4) renderFilterAndPresentOptions();
  else if(state.step === 5) renderBasketAndPay();
  else renderPrintAndConfirm();
  updateBreadcrumb();
  restoreVirtualKeyboard();

  // Hide primary footer action on in-screen tap flows.
  if(state.step === 0 || state.step === 1 || state.step === 2 || (state.step === 4 && state.evriScreeningOpen)){
    nextBtn.style.visibility = "hidden";
    nextBtn.style.pointerEvents = "none";
  } else {
    nextBtn.style.visibility = "visible";
    nextBtn.style.pointerEvents = "auto";
  }

  if(state.step === 6){
    nextBtn.innerHTML = `Start new transaction <span class="material-symbols-outlined">restart_alt</span>`;
  } else if(state.step === 5){
    nextBtn.innerHTML = `Proceed to print <span class="material-symbols-outlined">arrow_forward</span>`;
  } else if(state.step === 4){
    nextBtn.innerHTML = `Add to basket <span class="material-symbols-outlined">add_shopping_cart</span>`;
  } else if(state.step === 3){
    nextBtn.innerHTML = `Filter services <span class="material-symbols-outlined">filter_list</span>`;
  } else {
    nextBtn.innerHTML = `Continue <span class="material-symbols-outlined">arrow_forward</span>`;
  }
}

function renderWeigh(){
  if(!state.destination){
    applyDestinationSelection("uk");
  }
  setDestinationPill();
  const showManualWeightEditor = state.manualWeightEditOpen || !state.weightG;

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Confirm the weight of your item</h1>
        <p class="subtitle">Using the scales, please confirm the weight of the item being posted.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">scale</span> Item On Scales (KIOSK-404)</span>
    </div>

    <div class="flowShell">
      <div class="flowMain">
        <div class="card">
          <div class="scalePromptPanel">
            <div class="scalePromptIcon"><span class="material-symbols-outlined">scale</span></div>
            <h2 class="scalePromptTitle">Using the scales, please confirm the weight of the item being posted</h2>
            <p class="scalePromptText">Scales are just above the screen</p>
            <div class="scalePromptArrow">↑</div>
          </div>

          <div class="weightConfirmCard">
            <div class="weightCopy">
              <p class="label">Captured weight</p>
              <p class="value" id="weightReadout">${state.weightG ? `${escapeHtml(state.weightG)}g` : "--g"}</p>
              <button type="button" class="btn secondary weightEditBtn" id="weightEditBtn">
                <span class="material-symbols-outlined">edit</span>${showManualWeightEditor ? "Hide manual entry" : "Edit captured weight"}
              </button>
              <div class="weightInline ${showManualWeightEditor ? "show" : ""}" id="weightInlinePanel">
                <p>Using the keypad, enter weight manually (grams) if not auto-populated.</p>
                <input id="weightInlineInput" inputmode="numeric" placeholder="e.g. 850" value="${escapeHtml(state.weightG)}" />
              </div>
            </div>
            <div class="weightItemVisual">
              <span class="material-symbols-outlined">inventory_2</span>
            </div>
          </div>

          <div class="weightActions">
            <button type="button" class="btn secondary" id="weightRetryBtn">
              <span class="material-symbols-outlined">replay</span>Try again
            </button>
            <button type="button" class="btn primary" id="weightConfirmBtn">
              <span class="material-symbols-outlined">check_circle</span>Confirm weight
            </button>
          </div>
        </div>
      </div>
      <aside class="flowAside">
        <div class="flowNarrative">
          <h4>Journey Note</h4>
          <p>Customer selects "Post an Item" (KIOSK-402) to launch the flow. In R1.0 destination defaults to UK (Inc NI); in R1.1 customers must select destination before proceeding.</p>
          <p>Next step is Royal Mail dangerous goods screening (KIOSK-410).</p>
        </div>
      </aside>
    </div>
  `;
  const applyWeightInput = (rawValue) => {
    state.weightG = String(rawValue || "").replace(/[^\d]/g,"").slice(0,6);
    const inlineInput = document.getElementById("weightInlineInput");
    if(inlineInput && inlineInput.value !== state.weightG){
      inlineInput.value = state.weightG;
    }
    const readout = document.getElementById("weightReadout");
    if(readout){
      readout.textContent = state.weightG ? `${state.weightG}g` : "--g";
    }
    state.selectedServiceId = "";
    state.productProfile = "royal_mail";
    state.evriAdditionalSelection = "";
    state.evriAdditionalBlocked = false;
    state.evriScreeningComplete = false;
    state.evriLossOnlySelected = false;
    state.evriNoCompSelected = false;
  };

  const weightInlineInput = document.getElementById("weightInlineInput");
  if(weightInlineInput){
    weightInlineInput.addEventListener("input", (e)=> {
      applyWeightInput(e.target.value);
    });
  }

  document.getElementById("weightEditBtn").addEventListener("click", ()=>{
    state.manualWeightEditOpen = !showManualWeightEditor;
    render();
  });

  document.getElementById("weightRetryBtn").addEventListener("click", ()=>{
    state.manualWeightEditOpen = true;
    applyWeightInput("");
    render();
  });
  document.getElementById("weightConfirmBtn").addEventListener("click", ()=>{
    if(!state.weightG){
      alert("Please capture or enter item weight before continuing.");
      return;
    }
    state.manualWeightEditOpen = false;
    if(!state.destination){
      alert("Select a destination before continuing.");
      return;
    }
    next();
  });
}

function renderProhibited(){
  // In this Option 2 prototype: Prohibited list is service-wide (as you supplied).
  // If later you need UK vs Intl variants, we can split here.
  const list = padTo25([
    ...PROHIBITED,
    {
      key:"other_not_listed",
      label:"Other / not listed",
      icon:"check_circle",
      details:"Select this if your item does not match any option above. You can then continue."
    }
  ]);

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Screen for prohibited or restricted items (KIOSK-409)</h1>
        <p class="subtitle"><strong>Check contents against prohibited categories.</strong> Select one option to continue.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">block</span> Prohibited check (KIOSK-410)</span>
    </div>

    <div class="gridWrap">
      <div class="grid" id="pGrid"></div>

      <div class="details" id="pDetails">
        <div class="detailsTop">
          <div class="detailsTitle" id="pDetailsTitle"></div>
          <button class="btn" id="pClose">
            <span class="material-symbols-outlined">close</span>Close
          </button>
        </div>
        <div class="detailsText" id="pDetailsText"></div>
        <div class="banner danger show" id="pStopBanner">
          Prohibited Items cannot be accepted
        </div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn danger" id="pStopBack">
            <span class="material-symbols-outlined">arrow_back</span>Go back
          </button>
          <button class="btn" id="pStopReset">
            <span class="material-symbols-outlined">restart_alt</span>Start over
          </button>
        </div>
      </div>

    </div>
  `;

  const grid = document.getElementById("pGrid");
  list.forEach(item => grid.appendChild(tileEl(item, "p")));

  wireProhibitedDetails(list);
}

function renderRMDangerous(){
  const otherItem = {
    key:"rm_other_not_listed",
    label:"Other / not listed",
    icon:"check_circle",
    details:"Select this if your item does not match any listed category."
  };
  const groupTiles = [...RM_GROUPS];
  // Keep "Other / not listed" fixed at bottom-right of the active grouped category area.
  const activeSlots = Math.ceil((groupTiles.length + 1) / 5) * 5;
  while(groupTiles.length < activeSlots - 1){
    groupTiles.push({ key:`_rm_gap_${groupTiles.length}`, label:"", icon:"block", details:"", blank:true });
  }
  groupTiles.push(otherItem);
  const list = groupTiles;
  const isUK = state.destination === "uk";

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Screen for Dangerous Goods (KIOSK-410)</h1>
        <p class="subtitle"><strong>Does your item contain any of the following?</strong> Select a category, then confirm the exact item in a follow-up step.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">local_shipping</span> Dangerous goods screen</span>
    </div>

    <div class="gridWrap">
      <div class="grid" id="rmGrid"></div>

      <div class="details" id="rmDetails">
        <div class="detailsTop">
          <div class="detailsTitle" id="rmDetailsTitle"></div>
          <button class="btn" id="rmClose"><span class="material-symbols-outlined">close</span>Close</button>
        </div>
        <div class="detailsText" id="rmDetailsText"></div>
        <div id="rmConditionInputs"></div>
        <div class="banner" id="rmStatusBanner"></div>
        <div class="rmConditionActions" id="rmConditionActions"></div>
      </div>
    </div>
  `;

  const grid = document.getElementById("rmGrid");
  list.forEach(item => grid.appendChild(tileEl(item, "rm")));
  if(state.rmOtherSelected || state.rmSelectedKey === "rm_other_not_listed"){
    const selectedOther = document.querySelector('.tile[data-mode="rm"][data-key="rm_other_not_listed"]');
    if(selectedOther) selectedOther.classList.add("selected");
  } else if(state.rmSelectedKey){
    const selectedGroup = rmGroupForRule(state.rmSelectedKey);
    if(selectedGroup){
      const selected = document.querySelector(`.tile[data-mode="rm"][data-key="${selectedGroup.key}"]`);
      if(selected) selected.classList.add("selected");
    }
  }
  wireRMDangerousDetails(list);
}

function wireRMDangerousDetails(list){
  const details = document.getElementById("rmDetails");
  const title = document.getElementById("rmDetailsTitle");
  const text = document.getElementById("rmDetailsText");
  const inputs = document.getElementById("rmConditionInputs");
  const banner = document.getElementById("rmStatusBanner");
  const actions = document.getElementById("rmConditionActions");
  const close = document.getElementById("rmClose");

  function clearDetailsPanel(){
    details.classList.remove("show");
    text.textContent = "";
    inputs.innerHTML = "";
    actions.innerHTML = "";
    banner.className = "banner";
  }

  function showGroupClarifier(group){
    const rules = rmRulesForGroup(group.key);

    title.innerHTML = `
      <div class="icon"><span class="material-symbols-outlined">${group.icon || "block"}</span></div>
      ${escapeHtml(group.label)}
    `;
    text.textContent = group.prompt || "Select the best matching item to continue.";
    inputs.innerHTML = `
      <div class="rmConditionGroup">
        <strong>Tell us what is inside</strong>
        <div class="choiceGroup" id="rmGroupRuleChoices">
          ${rules.map(rule => `
            <button type="button" class="choiceBtn" data-rm-rule="${rule.key}">
              <span>${escapeHtml(rule.label)}</span>
              <span class="sub">${state.destination === "uk" ? (rule.uk ? "UK allowed with rules" : "Not allowed UK") : (rule.intl ? "International allowed with rules" : "Not allowed International")}</span>
            </button>
          `).join("")}
        </div>
      </div>
    `;
    actions.innerHTML = "";
    banner.className = "banner warn show";
    banner.textContent = "Choose the closest match so Royal Mail dangerous goods rules can be applied.";

    inputs.querySelectorAll("[data-rm-rule]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const key = btn.getAttribute("data-rm-rule");
        const selectedRule = RM_FILTER.find(rule => rule.key === key);
        if(selectedRule){
          handleRuleSelection(selectedRule);
        }
      });
    });

    details.classList.add("show");
  }

  function showBlocked(item){
    title.innerHTML = `
      <div class="icon"><span class="material-symbols-outlined">${item.icon || "block"}</span></div>
      ${escapeHtml(item.label)}
    `;
    text.textContent = item.details || "";
    inputs.innerHTML = "";
    actions.innerHTML = "";
    banner.className = "banner danger show";
    banner.textContent = "Not allowed for this destination under Royal Mail dangerous goods rules.";
    details.classList.add("show");
  }

  function handleRuleSelection(item){
    const changedSelection = state.rmSelectedKey !== item.key;
    state.rmSelectedKey = item.key;
    state.rmOtherSelected = false;
    if(changedSelection){
      resetRMConditionCapture();
    }

    const allowed = rmRuleAllowed(item);
    state.rmBlockedKey = allowed ? null : item.key;

    if(!allowed){
      state.rmConditionSatisfied = false;
      showBlocked(item);
      return;
    }

    const requirements = rmRuleRequirements(item);
    const hasRequirements = requirements.checks.length > 0 || requirements.limits.length > 0;
    if(!hasRequirements){
      state.rmConditionSatisfied = true;
      navigateToStep(3);
      return;
    }

    if(state.quickDemoMode){
      applyQuickDemoRMConditionCapture(item);
      const quickDemoErrors = validateRMConditionCapture(item);
      if(!quickDemoErrors.length){
        state.rmConditionSatisfied = true;
        navigateToStep(3);
        return;
      }
    }

    showConditionCapture(item);
  }

  function showConditionCapture(item){
    const requirements = rmRuleRequirements(item);
    requirements.checks.forEach(check => {
      if(typeof state.rmConditionChecks[check.id] !== "boolean"){
        state.rmConditionChecks[check.id] = false;
      }
    });
    requirements.limits.forEach(limit => {
      if(typeof state.rmConditionValues[limit.id] === "undefined"){
        state.rmConditionValues[limit.id] = "";
      }
    });

    title.innerHTML = `
      <div class="icon"><span class="material-symbols-outlined">${item.icon || "block"}</span></div>
      ${escapeHtml(item.label)}
    `;
    text.textContent = item.details || "";

    const checksHtml = requirements.checks.length ? `
      <div class="rmConditionGroup">
        <strong>Required checks</strong>
        ${requirements.checks.map(check => `
          <label class="rmConditionCheck">
            <input type="checkbox" data-rm-check="${check.id}" ${state.rmConditionChecks[check.id] ? "checked" : ""}/>
            <span>${escapeHtml(check.label)}</span>
          </label>
        `).join("")}
      </div>
    ` : "";

    const limitsHtml = requirements.limits.length ? `
      <div class="rmConditionGroup">
        <strong>Quantity and limit checks</strong>
        ${requirements.limits.map(limit => `
          <label class="rmConditionLimit">
            <span>${escapeHtml(limit.label)} (${escapeHtml(String(limit.min))} to ${escapeHtml(String(limit.max))}${limit.unit ? ` ${escapeHtml(limit.unit)}` : ""})</span>
            <input type="text" inputmode="decimal" data-rm-limit="${limit.id}" value="${escapeHtml(state.rmConditionValues[limit.id] || "")}" />
          </label>
        `).join("")}
      </div>
    ` : "";

    inputs.innerHTML = checksHtml + limitsHtml;

    banner.className = "banner warn show";
    banner.textContent = "Complete all mandatory checks/limits to continue with this restricted category.";

    actions.innerHTML = `
      <button class="btn primary" id="rmConfirmConditions">
        <span class="material-symbols-outlined">task_alt</span>Confirm conditions and continue
      </button>
    `;

    inputs.querySelectorAll("[data-rm-check]").forEach(input => {
      input.addEventListener("change", (e) => {
        const checkId = e.target.getAttribute("data-rm-check");
        state.rmConditionChecks[checkId] = !!e.target.checked;
        state.rmConditionSatisfied = false;
      });
    });

    inputs.querySelectorAll("[data-rm-limit]").forEach(input => {
      input.addEventListener("input", (e) => {
        const limitId = e.target.getAttribute("data-rm-limit");
        let raw = (e.target.value || "").replace(/[^0-9.]/g, "");
        const firstDot = raw.indexOf(".");
        if(firstDot !== -1){
          raw = raw.slice(0, firstDot + 1) + raw.slice(firstDot + 1).replace(/\./g, "");
        }
        state.rmConditionValues[limitId] = raw.slice(0, 10);
        e.target.value = state.rmConditionValues[limitId];
        state.rmConditionSatisfied = false;
      });
    });

    document.getElementById("rmConfirmConditions").addEventListener("click", ()=>{
      const errors = validateRMConditionCapture(item);
      if(errors.length){
        alert(errors.slice(0, 5).join("\n"));
        return;
      }
      state.rmConditionSatisfied = true;
      navigateToStep(3);
    });

    details.classList.add("show");
  }

  document.querySelectorAll('.tile[data-mode="rm"]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const key = btn.dataset.key;
      const tile = list.find(x=>x.key===key);
      if(!tile) return;

      document.querySelectorAll('.tile[data-mode="rm"]').forEach(b=>b.classList.remove("selected"));
      btn.classList.add("selected");

      if(key === "rm_other_not_listed"){
        resetRMConditionCapture();
        state.rmSelectedKey = key;
        state.rmBlockedKey = null;
        state.rmOtherSelected = true;
        state.rmConditionSatisfied = true;
        clearDetailsPanel();
        navigateToStep(3);
        return;
      }

      const group = RM_GROUPS.find(x => x.key === key);
      if(!group){
        return;
      }
      showGroupClarifier(group);
    });
  });

  close.addEventListener("click", ()=>{
    clearDetailsPanel();
    document.querySelectorAll('.tile[data-mode="rm"]').forEach(b=>b.classList.remove("selected"));
  });
}

function renderRMConditions(){
  const isUK = state.destination === "uk";
  const item = RM_FILTER.find(x => x.key === state.rmSelectedKey);
  const isOther = state.rmSelectedKey === "rm_other_not_listed";
  const allowed = isOther ? true : (item ? (isUK ? item.uk : item.intl) : true);
  const selectedLabel = isOther ? "Other / not listed" : (item ? item.label : "Other / not listed");
  const outcomeClass = allowed ? "ok" : "danger";
  const outcomeText = isOther
    ? "No dangerous goods conditions were triggered from the Royal Mail list."
    : (allowed
    ? "This category can be sent on the selected destination only when Royal Mail conditions are met."
    : "This category is not allowed for the selected destination under Royal Mail rules.");

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Handle restricted outcome (KIOSK-410)</h1>
        <p class="subtitle">Confirm handling decision before capture item details.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">gavel</span> RM handling</span>
    </div>

    <div class="formRow">
      <div class="card">
        <h3>Selected category</h3>
        <div class="helpNote"><strong>${escapeHtml(selectedLabel)}</strong></div>
        <div class="banner ${outcomeClass} show" style="display:block; margin-top:10px;">
          ${escapeHtml(outcomeText)}
        </div>
      </div>
      <div class="card">
        <h3>Before acceptance, confirm</h3>
        <div class="helpNote">${isOther
          ? "No additional dangerous goods conditions are required for this selection. Continue with normal product and service checks."
          : "1. Sender name and return address is visible.<br/>2. Item meets quantity limits for this category.<br/>3. Packaging meets Royal Mail requirements (leak/sift/impact protection as relevant).<br/>4. Counter presentation is used where required.<br/>5. Destination-specific rules are satisfied."}</div>
        <p style="margin-top:10px; color:var(--muted); font-size:12px;">Source: Royal Mail and Parcelforce prohibited/restricted items leaflet (valid from May 2025).</p>
      </div>
    </div>
  `;
}

function renderPolicyChecks(){
  const restrictedList = padTo25(RESTRICTED);
  const lossList = padTo25(LOSS_ONLY);
  const noCompList = padTo25(NO_COMP);

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Handle restricted outcome (KIOSK-410)</h1>
        <p class="subtitle">Confirm restricted and compensation context before item-detail capture.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">shield</span> Restricted handling</span>
    </div>

    <div class="card" style="margin-bottom:14px;">
      <h3>Restricted goods (allowed with conditions)</h3>
      <p>Some items are allowed only if specific conditions are met.</p>
      <div class="gridWrap">
        <div class="grid" id="rGrid"></div>
        <div class="details" id="rDetails">
          <div class="detailsTop">
            <div class="detailsTitle" id="rDetailsTitle"></div>
            <button class="btn" id="rClose"><span class="material-symbols-outlined">close</span>Close</button>
          </div>
          <div class="detailsText" id="rDetailsText"></div>
          <div class="banner warn show" style="display:block; margin-top:10px;">
            Restricted items may change service availability and packing requirements.
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-bottom:14px;">
      <h3>Items protected for loss only</h3>
      <p>The couriers can carry these items but do not protect for damage. If an item is lost in their network, carriage and item value can be refunded when parcel protection is in place.</p>
      <div class="gridWrap">
        <div class="grid" id="lossGrid"></div>
      </div>
    </div>

    <div class="card">
      <h3>No compensation items</h3>
      <p>The following items (or items similar in description or content) are carried on a no-protection basis on any service. Senders of these items do so at their own risk.</p>
      <div class="gridWrap">
        <div class="grid" id="ncGrid"></div>
      </div>
    </div>

    <div class="details" id="cDetails">
      <div class="detailsTop">
        <div class="detailsTitle" id="cDetailsTitle"></div>
        <button class="btn" id="cClose"><span class="material-symbols-outlined">close</span>Close</button>
      </div>
      <div class="detailsText" id="cDetailsText"></div>
      <div class="banner warn show" style="display:block; margin-top:10px;">
        This affects compensation eligibility. Protection may be limited or unavailable.
      </div>
    </div>
  `;

  const rGrid = document.getElementById("rGrid");
  restrictedList.forEach(item => rGrid.appendChild(tileEl(item, "r", true)));
  wireMultiSelectDetails("r", restrictedList, state.restrictedKeys);

  const lossGrid = document.getElementById("lossGrid");
  lossList.forEach(item => lossGrid.appendChild(tileEl(item, "loss", true)));
  wireMultiSelectDetails("loss", lossList, state.coverLossOnlyKeys, "c");

  const ncGrid = document.getElementById("ncGrid");
  noCompList.forEach(item => ncGrid.appendChild(tileEl(item, "nc", true)));
  wireMultiSelectDetails("nc", noCompList, state.coverNoCompKeys, "c");

  // Use the shared cover details panel (cDetails)
  document.getElementById("cClose").addEventListener("click", ()=> {
    document.getElementById("cDetails").classList.remove("show");
    document.querySelectorAll('.tile[data-mode="loss"], .tile[data-mode="nc"]').forEach(b=>b.classList.remove("selected"));
  });
  document.getElementById("rClose").addEventListener("click", ()=> {
    document.getElementById("rDetails").classList.remove("show");
    document.querySelectorAll('.tile[data-mode="r"]').forEach(b=>b.classList.remove("selected"));
  });
}

function renderCaptureItemDetails(){
  const fmt = ({letter:"Letter", large_letter:"Large letter", parcel:"Parcel"})[state.format] || "Not set";
  const dest = state.destination === "uk" ? "UK Inland" : "International";
  const isDomestic = isDomesticJourney();
  const speedOptions = domesticDeliveryPreferences();
  const speedSection = isDomestic ? `
        <h3 style="margin-top:14px;">Delivery speed preference (KIOSK-427)</h3>
        <div class="choiceRow3" id="captureSpeedChoices">
          ${speedOptions.map(option => {
            const from = deliveryPreferenceIndicativeFrom(option.key);
            const fromText = from === null ? "from --" : `from £${from.toFixed(2)}`;
            return `
              <button type="button" class="choiceBtn ${state.deliverySpeed===option.key?"active":""}" data-value="${escapeHtml(option.key)}">
                <span>${escapeHtml(option.label)}</span>
                <span class="sub">${escapeHtml(fromText)}</span>
              </button>
            `;
          }).join("")}
        </div>
  ` : `
        <h3 style="margin-top:14px;">Delivery speed preference (KIOSK-427)</h3>
        <div class="banner ok show" style="display:block;">International item: this step is skipped.</div>
  `;

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Item Offered to “Format Sidecar”</h1>
        <p class="subtitle">Using the measuring device, please confirm the format of the item being posted.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">inventory_2</span> Format sidecar</span>
    </div>

    <div class="card">
      <h3>Item details</h3>
      <div style="margin-top:10px;">
        <span class="tag"><span class="material-symbols-outlined">scale</span> ${escapeHtml(state.weightG || "—")} g</span>
        <span class="tag"><span class="material-symbols-outlined">public</span> ${dest}</span>
        <span class="tag"><span class="material-symbols-outlined">straighten</span> ${fmt}</span>
      </div>

      <h3 style="margin-top:14px;">Using the measuring device, please confirm the format of the item being posted (KIOSK-405)</h3>
      <div class="choiceRow3" id="captureFormatChoices">
        <button type="button" class="choiceBtn ${state.format==="letter"?"active":""}" data-value="letter"><span>Letter</span></button>
        <button type="button" class="choiceBtn ${state.format==="large_letter"?"active":""}" data-value="large_letter"><span>Large Letter</span></button>
        <button type="button" class="choiceBtn ${state.format==="parcel"?"active":""}" data-value="parcel"><span>Parcel</span></button>
      </div>

      <h3 style="margin-top:14px;">Using the keypad, please enter the value of the item being posted (KIOSK-407)</h3>
      <input id="declaredValueInput" inputmode="decimal" placeholder="e.g. 49.99" value="${escapeHtml(state.declaredValue)}" />

      ${speedSection}
    </div>
  `;

  document.querySelectorAll("#captureFormatChoices .choiceBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.format = btn.dataset.value || state.format;
      document.querySelectorAll("#captureFormatChoices .choiceBtn").forEach(b=>b.classList.toggle("active", b===btn));
    });
  });
  // Value and contents are captured on the same screen as sidecar confirmation.
  document.getElementById("declaredValueInput").addEventListener("input", (e)=>{
    let raw = (e.target.value || "").replace(/[^0-9.]/g, "");
    const firstDot = raw.indexOf(".");
    if(firstDot !== -1){
      raw = raw.slice(0, firstDot + 1) + raw.slice(firstDot + 1).replace(/\./g, "");
    }
    state.declaredValue = raw.slice(0, 10);
    e.target.value = state.declaredValue;
  });
  const speedChoices = document.querySelectorAll("#captureSpeedChoices .choiceBtn");
  speedChoices.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.deliverySpeed = btn.dataset.value || "";
      speedChoices.forEach(b=>b.classList.toggle("active", b===btn));
      const speedLabel = deliveryPreferenceLabel(state.deliverySpeed);
      const indicativeFrom = deliveryPreferenceIndicativeFrom(state.deliverySpeed);
      logAudit("delivery_speed_selected", {
        destination: state.destination || "unknown",
        deliverySpeed: state.deliverySpeed,
        deliverySpeedLabel: speedLabel,
        indicativeFrom: indicativeFrom === null ? null : Number(indicativeFrom.toFixed(2))
      });
    });
  });
}

function renderEvriAdditionalScreening(){
  const prohibitedList = padTo25([
    ...PROHIBITED,
    {
      key:"evri_other_not_listed",
      label:"Other / not listed",
      icon:"check_circle",
      details:"Select this if your item does not match any prohibited category."
    }
  ]);
  const lossList = padTo25(LOSS_ONLY);
  const noCompList = padTo25(NO_COMP);
  const prohibitedLabel = state.evriSelectedProhibitedKey
    ? (PROHIBITED.find(x => x.key === state.evriSelectedProhibitedKey)?.label || state.evriSelectedProhibitedKey)
    : "Other / not listed";

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>EVRi/DPD additional screening</h1>
        <p class="subtitle">Carrier-specific checks for EVRi/DPD products.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">policy</span> Additional carrier checks</span>
    </div>

    <div class="flowShell">
      <div class="flowMain">
        <div class="card" style="margin-bottom:14px;">
          <h3>Prohibited categories (EVRi/DPD)</h3>
          <div class="gridWrap">
            <div class="grid" id="evriProhibitedGrid"></div>
            <div class="details" id="evriProhibitedDetails">
              <div class="detailsTop">
                <div class="detailsTitle" id="evriProhibitedDetailsTitle"></div>
                <button class="btn" id="evriProhibitedClose"><span class="material-symbols-outlined">close</span>Close</button>
              </div>
              <div class="detailsText" id="evriProhibitedDetailsText"></div>
              <div class="banner" id="evriProhibitedBanner"></div>
            </div>
          </div>
        </div>

        <div class="formRow">
          <div class="card">
            <h3>Loss-only compensation categories</h3>
            <div class="gridWrap">
              <div class="grid" id="evriLossGrid"></div>
            </div>
          </div>
          <div class="card">
            <h3>No-compensation categories</h3>
            <div class="gridWrap">
              <div class="grid" id="evriNoCompGrid"></div>
            </div>
          </div>
        </div>

        <div class="details" id="evriCompDetails">
          <div class="detailsTop">
            <div class="detailsTitle" id="evriCompDetailsTitle"></div>
            <button class="btn" id="evriCompClose"><span class="material-symbols-outlined">close</span>Close</button>
          </div>
          <div class="detailsText" id="evriCompDetailsText"></div>
          <div class="banner warn show" style="display:block; margin-top:10px;">
            This affects compensation eligibility on EVRi/DPD services.
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <span class="tag"><span class="material-symbols-outlined">report</span>${escapeHtml(state.evriAdditionalSelection === "blocked" ? `Prohibited: ${prohibitedLabel}` : "Prohibited: Other / not listed")}</span>
            <span class="tag"><span class="material-symbols-outlined">package_2</span>Loss-only: ${state.coverLossOnlyKeys.size ? "Yes" : "No"}</span>
            <span class="tag"><span class="material-symbols-outlined">gpp_bad</span>No-comp: ${state.coverNoCompKeys.size ? "Yes" : "No"}</span>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
            <button class="btn" id="evriScreeningBack"><span class="material-symbols-outlined">arrow_back</span>Back to services</button>
            <button class="btn primary" id="evriScreeningConfirm"><span class="material-symbols-outlined">task_alt</span>Confirm EVRi/DPD screening</button>
          </div>
          ${state.evriAdditionalSelection === "blocked" ? `
            <div class="banner danger show" style="display:block; margin-top:10px;">EVRi/DPD prohibited item selected. Choose a different service or change selection.</div>
          ` : state.evriAdditionalSelection === "clear" ? `
            <div class="banner ok show" style="display:block; margin-top:10px;">EVRi/DPD additional screening currently clear.</div>
          ` : `
            <div class="banner warn show" style="display:block; margin-top:10px;">Select a prohibited outcome to complete screening.</div>
          `}
        </div>
      </div>
      <aside class="flowAside">
        <div class="flowNarrative">
          <h4>Journey Note</h4>
          <p>Select one prohibited outcome first. Use <strong>Other / not listed</strong> for clear items.</p>
          <p>Loss-only and no-compensation categories are optional multi-select flags for compensation handling.</p>
          <p>Confirm screening to return to service filtering.</p>
        </div>
      </aside>
    </div>
  `;

  const prohibitedGrid = document.getElementById("evriProhibitedGrid");
  prohibitedList.forEach(item => prohibitedGrid.appendChild(tileEl(item, "evriProhibited")));

  if(state.evriAdditionalSelection === "clear"){
    const otherTile = prohibitedGrid.querySelector('.tile[data-key="evri_other_not_listed"]');
    if(otherTile) otherTile.classList.add("selected");
  } else if(state.evriSelectedProhibitedKey){
    const selectedTile = prohibitedGrid.querySelector(`.tile[data-key="${state.evriSelectedProhibitedKey}"]`);
    if(selectedTile) selectedTile.classList.add("selected");
  }

  const pDetails = document.getElementById("evriProhibitedDetails");
  const pTitle = document.getElementById("evriProhibitedDetailsTitle");
  const pText = document.getElementById("evriProhibitedDetailsText");
  const pBanner = document.getElementById("evriProhibitedBanner");
  const pClose = document.getElementById("evriProhibitedClose");

  document.querySelectorAll('.tile[data-mode="evriProhibited"]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const key = btn.dataset.key;
      const item = prohibitedList.find(x=>x.key===key);
      if(!item) return;

      document.querySelectorAll('.tile[data-mode="evriProhibited"]').forEach(b=>b.classList.remove("selected"));
      btn.classList.add("selected");

      pTitle.innerHTML = `
        <div class="icon"><span class="material-symbols-outlined">${item.icon || "block"}</span></div>
        ${escapeHtml(item.label)}
      `;
      pText.textContent = item.details || "";
      pBanner.className = "banner show";

      if(key === "evri_other_not_listed"){
        state.evriAdditionalSelection = "clear";
        state.evriSelectedProhibitedKey = null;
        state.evriAdditionalBlocked = false;
        pBanner.classList.add("ok");
        pBanner.textContent = "No EVRi/DPD prohibited category selected.";
      } else {
        state.evriAdditionalSelection = "blocked";
        state.evriSelectedProhibitedKey = key;
        state.evriAdditionalBlocked = true;
        pBanner.classList.add("danger");
        pBanner.textContent = "This is treated as prohibited for EVRi/DPD screening.";
      }
      state.evriScreeningComplete = false;
      pDetails.classList.add("show");
    });
  });

  pClose.addEventListener("click", ()=>{
    pDetails.classList.remove("show");
  });

  const lossGrid = document.getElementById("evriLossGrid");
  lossList.forEach(item => lossGrid.appendChild(tileEl(item, "evriLoss", true)));
  wireMultiSelectDetails("evriLoss", lossList, state.coverLossOnlyKeys, "evriComp");

  const noCompGrid = document.getElementById("evriNoCompGrid");
  noCompList.forEach(item => noCompGrid.appendChild(tileEl(item, "evriNc", true)));
  wireMultiSelectDetails("evriNc", noCompList, state.coverNoCompKeys, "evriComp");

  state.coverLossOnlyKeys.forEach(key=>{
    const btn = document.querySelector(`.tile[data-mode="evriLoss"][data-key="${key}"]`);
    if(btn) btn.classList.add("selected");
  });
  state.coverNoCompKeys.forEach(key=>{
    const btn = document.querySelector(`.tile[data-mode="evriNc"][data-key="${key}"]`);
    if(btn) btn.classList.add("selected");
  });

  document.querySelectorAll('.tile[data-mode="evriLoss"], .tile[data-mode="evriNc"]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.evriLossOnlySelected = state.coverLossOnlyKeys.size > 0;
      state.evriNoCompSelected = state.coverNoCompKeys.size > 0;
      state.evriScreeningComplete = false;
    });
  });

  document.getElementById("evriCompClose").addEventListener("click", ()=>{
    document.getElementById("evriCompDetails").classList.remove("show");
    document.querySelectorAll('.tile[data-mode="evriLoss"], .tile[data-mode="evriNc"]').forEach(b=>b.classList.remove("selected"));
    state.coverLossOnlyKeys.forEach(key=>{
      const btn = document.querySelector(`.tile[data-mode="evriLoss"][data-key="${key}"]`);
      if(btn) btn.classList.add("selected");
    });
    state.coverNoCompKeys.forEach(key=>{
      const btn = document.querySelector(`.tile[data-mode="evriNc"][data-key="${key}"]`);
      if(btn) btn.classList.add("selected");
    });
  });

  document.getElementById("evriScreeningBack").addEventListener("click", ()=>{
    state.evriScreeningOpen = false;
    render();
  });

  document.getElementById("evriScreeningConfirm").addEventListener("click", ()=>{
    if(!state.evriAdditionalSelection){
      alert("Select the EVRi/DPD prohibited outcome before confirming screening.");
      return;
    }
    state.evriLossOnlySelected = state.coverLossOnlyKeys.size > 0;
    state.evriNoCompSelected = state.coverNoCompKeys.size > 0;
    state.evriScreeningComplete = true;
    state.evriScreeningOpen = false;
    render();
  });
}

function renderFilterAndPresentOptions(){
  const services = availableServices();
  const isDomestic = isDomesticJourney();
  const deliveryPreferenceText = isDomestic
    ? deliveryPreferenceLabel(state.deliverySpeed || "")
    : "Not required for international";
  const showNI = state.destination === "uk" && isBTPostcode(state.recipientPostcode);
  const showGBToNI = isGBToNIJourney();
  const selectedRMRule = currentRMRule();
  const niStatus = rmNIStatus();
  const showRMNISpecial = showGBToNI && selectedRMRule && !!selectedRMRule.niRule;
  const chosenService = selectedService();
  const needsEvriAdditional = !!(chosenService && chosenService.profile === "evri_dpd");
  if(!needsEvriAdditional && state.evriScreeningOpen){
    state.evriScreeningOpen = false;
  }
  if(needsEvriAdditional && state.evriScreeningOpen){
    renderEvriAdditionalScreening();
    return;
  }
  const evriProhibitedLabel = state.evriSelectedProhibitedKey
    ? (PROHIBITED.find(x => x.key === state.evriSelectedProhibitedKey)?.label || state.evriSelectedProhibitedKey)
    : "Other / not listed";
  const narrativeSpeed = isDomestic
    ? `Delivery preference: ${deliveryPreferenceText}.`
    : "International destination: delivery preference skipped.";
  const narrativeRM = selectedRMRule
    ? `RM DG selection: ${selectedRMRule.label}${state.rmConditionSatisfied ? " (conditions complete)." : " (conditions pending)."}` 
    : "RM DG selection: not set.";
  const narrativeCarrier = needsEvriAdditional
    ? `EVRi/DPD screening: ${state.evriScreeningComplete ? "complete" : "pending"}${state.evriAdditionalSelection === "blocked" ? ` (blocked by ${evriProhibitedLabel})` : ""}.`
    : "Carrier-specific EVRi/DPD screening not required for current service.";
  const narrativeNI = showNI
    ? `NI/Windsor checks: ${state.niCustomsConfirmed ? "complete" : "pending"}${state.niCustomsReference ? ` (${state.niCustomsReference})` : ""}.`
    : "NI/Windsor checks not required for current postcode.";
  const narrativeNIRule = showRMNISpecial && niStatus.message
    ? `NI route rule: ${niStatus.message}`
    : "";

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Filter and Present Postage Options (KIOSK-412)</h1>
        <p class="subtitle">Apply delivery preference, restrictions, and routing to present valid services.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">tune</span> Service filtering</span>
    </div>

    <div class="flowShell">
      <div class="flowMain">
        <div class="formRow stack">
          <div class="card">
            <h3>Service filtering (KIOSK-413 / KIOSK-415 / KIOSK-428)</h3>
            <h3 style="margin-top:14px;">Available services (KIOSK-414)</h3>
            <div class="choiceGroup" id="serviceChoices">
              ${services.length ? services.map(service => `
                <button type="button" class="choiceBtn ${state.selectedServiceId===service.id?"active":""}" data-service-id="${service.id}">
                  <span>${escapeHtml(service.name)}</span>
                  <span class="sub">${service.tracked ? "Tracked" : "Untracked"} • £${calculateServicePrice(service).toFixed(2)}</span>
                </button>
              `).join("") : `
                <div class="banner danger show" style="display:block;">No services available for current filters. Adjust speed or item details.</div>
              `}
            </div>
          </div>

          <div class="card">
            <h3>Enter address details (KIOSK-866)</h3>
            <p>Recipient details</p>
            <input id="recipientPostcodeInput" placeholder="Recipient postcode (e.g. SW1A 1AA)" value="${escapeHtml(state.recipientPostcode)}" />
            <input id="recipientAddressInput" placeholder="Recipient address line" value="${escapeHtml(state.recipientAddress)}" style="margin-top:8px;" />
            <p style="margin-top:10px;">Sender details</p>
            <input id="senderPostcodeInput" placeholder="Sender postcode" value="${escapeHtml(state.senderPostcode)}" />
            <input id="senderAddressInput" placeholder="Sender address line" value="${escapeHtml(state.senderAddress)}" style="margin-top:8px;" />

            ${showNI ? `
          <h3 style="margin-top:14px;">Northern Ireland / Windsor checks (KIOSK-867)</h3>
          <p style="margin-top:10px; margin-bottom:8px; color:var(--muted); font-size:13px;">Does parcel include sanitary/phytosanitary goods (e.g. meat, dairy, plants)?</p>
          <div class="choiceRow" id="niSpsChoices">
            <button type="button" class="choiceBtn ${state.niSpsCategory==="no"?"active":""}" data-value="no"><span>No</span></button>
            <button type="button" class="choiceBtn ${state.niSpsCategory==="yes"?"active":""}" data-value="yes"><span>Yes</span></button>
          </div>
          <p style="margin-top:10px; margin-bottom:8px; color:var(--muted); font-size:13px;">Is this being sent to a private individual?</p>
          <div class="choiceRow" id="niPrivateChoices">
            <button type="button" class="choiceBtn ${state.niPrivateIndividual==="yes"?"active":""}" data-value="yes"><span>Yes</span></button>
            <button type="button" class="choiceBtn ${state.niPrivateIndividual==="no"?"active":""}" data-value="no"><span>No</span></button>
          </div>
          <input id="niReferenceInput" placeholder="NI/Windsor declaration reference" value="${escapeHtml(state.niCustomsReference)}" style="margin-top:8px;" />
          <label style="display:flex;gap:8px;align-items:flex-start;margin-top:10px;font-weight:700;">
            <input type="checkbox" id="niConfirmed" ${state.niCustomsConfirmed ? "checked" : ""}/>
            <span>I confirm NI/Windsor information has been captured and validated.</span>
          </label>

          ${showRMNISpecial && selectedRMRule.niRule === "live_creatures_forbidden" ? `
            <div class="banner danger show" style="display:block; margin-top:10px;">
              ${escapeHtml(niStatus.message || "This selected Royal Mail category is blocked for Great Britain to Northern Ireland journeys.")}
            </div>
          ` : ""}

          ${showRMNISpecial && selectedRMRule.niRule === "perishable_extra" ? `
            <h3 style="margin-top:14px;">Additional RM perishable checks</h3>
            ${state.niSpsCategory === "yes" ? `
              <div class="choiceGroup" id="rmPerishableRouteChoices" style="margin-top:8px;">
                <button type="button" class="choiceBtn ${state.rmNiPerishableRoute==="confectionery_only"?"active":""}" data-value="confectionery_only">
                  <span>Confectionery only</span>
                  <span class="sub">No meat/dairy/pet food</span>
                </button>
                <button type="button" class="choiceBtn ${state.rmNiPerishableRoute==="plants_certified"?"active":""}" data-value="plants_certified">
                  <span>Flowers/plants with certification</span>
                  <span class="sub">Certification required</span>
                </button>
                <button type="button" class="choiceBtn ${state.rmNiPerishableRoute==="contains_prohibited"?"active":""}" data-value="contains_prohibited">
                  <span>Contains restricted meat/dairy/pet food</span>
                  <span class="sub">Blocked</span>
                </button>
              </div>
              ${state.rmNiPerishableRoute === "plants_certified" ? `
                <input id="rmNiPlantCertRefInput" placeholder="Plant/flower certification reference" value="${escapeHtml(state.rmNiPlantCertRef)}" style="margin-top:8px;" />
              ` : ""}
            ` : ""}
            ${niStatus.message ? `
              <div class="banner ${niStatus.blocked ? "danger" : "warn"} show" style="display:block; margin-top:10px;">
                ${escapeHtml(niStatus.message)}
              </div>
            ` : ""}
          ` : ""}
            ` : ""}

            <label style="display:flex;gap:8px;align-items:flex-start;margin-top:12px;font-weight:700;">
              <input type="checkbox" id="proofDeliveryInput" ${state.proofOfDelivery ? "checked" : ""}/>
              <span>Offer proof of delivery optional add-on (KIOSK-416)</span>
            </label>

            ${needsEvriAdditional ? `
          <h3 style="margin-top:14px;">EVRi/DPD additional screening</h3>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <button type="button" class="btn" id="openEvriScreeningBtn">
              <span class="material-symbols-outlined">fact_check</span>Open EVRi/DPD screening screens
            </button>
            <button type="button" class="btn ghost" id="resetEvriScreeningBtn">
              <span class="material-symbols-outlined">restart_alt</span>Reset screening
            </button>
          </div>
          ${state.evriAdditionalSelection==="blocked" ? `
            <div class="banner danger show" style="display:block; margin-top:10px;">EVRi/DPD prohibited item selected. Cannot proceed with this service.</div>
          ` : state.evriScreeningComplete ? `
            <div class="banner ok show" style="display:block; margin-top:10px;">EVRi/DPD additional screening passed.</div>
          ` : `
            <div class="banner warn show" style="display:block; margin-top:10px;">Complete EVRi/DPD screening screens before continuing.</div>
          `}
            ` : ""}
          </div>
        </div>
      </div>
      <aside class="flowAside">
        <div class="flowNarrative">
          <h4>Journey Note</h4>
          <p>${escapeHtml(narrativeSpeed)}</p>
          <p>${escapeHtml(narrativeRM)}</p>
          <p>${escapeHtml(narrativeNI)}</p>
          ${narrativeNIRule ? `<p>${escapeHtml(narrativeNIRule)}</p>` : ""}
          <p>${escapeHtml(narrativeCarrier)}</p>
        </div>
      </aside>
    </div>
  `;

  document.querySelectorAll("#serviceChoices .choiceBtn[data-service-id]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.selectedServiceId = btn.dataset.serviceId || "";
      const chosen = selectedService();
      state.productProfile = chosen ? chosen.profile : "royal_mail";
      if(state.productProfile !== "evri_dpd"){
        state.evriScreeningOpen = false;
        state.evriAdditionalSelection = "";
        state.evriSelectedProhibitedKey = null;
        state.evriAdditionalBlocked = false;
        state.evriScreeningComplete = false;
        state.evriLossOnlySelected = false;
        state.evriNoCompSelected = false;
        state.coverLossOnlyKeys = new Set();
        state.coverNoCompKeys = new Set();
      } else if(state.productProfile === "evri_dpd"){
        state.evriScreeningOpen = false;
      }
      render();
    });
  });

  const rp = document.getElementById("recipientPostcodeInput");
  const ra = document.getElementById("recipientAddressInput");
  const sp = document.getElementById("senderPostcodeInput");
  const sa = document.getElementById("senderAddressInput");
  const pod = document.getElementById("proofDeliveryInput");

  bindKioskKeyboard(rp, { title:"Enter recipient postcode", maxLen:10, uppercase:true });
  bindKioskKeyboard(ra, { title:"Enter recipient address", maxLen:80, uppercase:false });
  bindKioskKeyboard(sp, { title:"Enter sender postcode", maxLen:10, uppercase:true });
  bindKioskKeyboard(sa, { title:"Enter sender address", maxLen:80, uppercase:false });

  rp.addEventListener("input", (e)=>{
    const prevNI = isBTPostcode(state.recipientPostcode);
    const prevGBToNI = isGBToNIJourney();
    state.recipientPostcode = (e.target.value || "").toUpperCase().slice(0, 10);
    e.target.value = state.recipientPostcode;
    const nowNI = isBTPostcode(state.recipientPostcode);
    const nowGBToNI = isGBToNIJourney();
    if(prevNI !== nowNI){
      if(!nowNI){
        state.niCustomsReference = "";
        state.niCustomsConfirmed = false;
        state.niSpsCategory = "";
        state.niPrivateIndividual = "";
        state.rmNiPerishableRoute = "";
        state.rmNiPlantCertRef = "";
      }
      render();
      return;
    }
    if(prevGBToNI !== nowGBToNI){
      if(!nowGBToNI){
        state.rmNiPerishableRoute = "";
        state.rmNiPlantCertRef = "";
      }
      render();
    }
  });
  ra.addEventListener("input", (e)=>{ state.recipientAddress = (e.target.value || "").slice(0, 80); e.target.value = state.recipientAddress; });
  sp.addEventListener("input", (e)=>{
    const prevGBToNI = isGBToNIJourney();
    state.senderPostcode = (e.target.value || "").toUpperCase().slice(0, 10);
    e.target.value = state.senderPostcode;
    const nowGBToNI = isGBToNIJourney();
    if(prevGBToNI !== nowGBToNI){
      if(!nowGBToNI){
        state.rmNiPerishableRoute = "";
        state.rmNiPlantCertRef = "";
      }
      render();
    }
  });
  sa.addEventListener("input", (e)=>{ state.senderAddress = (e.target.value || "").slice(0, 80); e.target.value = state.senderAddress; });
  pod.addEventListener("change", (e)=>{ state.proofOfDelivery = !!e.target.checked; });

  const niRef = document.getElementById("niReferenceInput");
  const niConfirm = document.getElementById("niConfirmed");
  bindKioskKeyboard(niRef, { title:"Enter NI/Windsor reference", maxLen:40, uppercase:true });
  if(niRef){
    niRef.addEventListener("input", (e)=>{ state.niCustomsReference = (e.target.value || "").slice(0, 40); e.target.value = state.niCustomsReference; });
  }
  if(niConfirm){
    niConfirm.addEventListener("change", (e)=>{ state.niCustomsConfirmed = !!e.target.checked; });
  }
  const niSpsChoices = document.querySelectorAll("#niSpsChoices .choiceBtn");
  niSpsChoices.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.niSpsCategory = btn.dataset.value || "";
      if(state.niSpsCategory !== "yes"){
        state.rmNiPerishableRoute = "";
        state.rmNiPlantCertRef = "";
      }
      niSpsChoices.forEach(b=>b.classList.toggle("active", b===btn));
      render();
    });
  });
  const niPrivateChoices = document.querySelectorAll("#niPrivateChoices .choiceBtn");
  niPrivateChoices.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.niPrivateIndividual = btn.dataset.value || "";
      niPrivateChoices.forEach(b=>b.classList.toggle("active", b===btn));
    });
  });

  const rmPerishableRouteChoices = document.querySelectorAll("#rmPerishableRouteChoices .choiceBtn");
  rmPerishableRouteChoices.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.rmNiPerishableRoute = btn.dataset.value || "";
      if(state.rmNiPerishableRoute !== "plants_certified"){
        state.rmNiPlantCertRef = "";
      }
      render();
    });
  });

  const rmNiPlantCertRefInput = document.getElementById("rmNiPlantCertRefInput");
  bindKioskKeyboard(rmNiPlantCertRefInput, { title:"Enter plant/flower certificate reference", maxLen:40, uppercase:true });
  if(rmNiPlantCertRefInput){
    rmNiPlantCertRefInput.addEventListener("input", (e)=>{
      state.rmNiPlantCertRef = (e.target.value || "").slice(0, 40);
      e.target.value = state.rmNiPlantCertRef;
    });
  }

  const openEvriScreeningBtn = document.getElementById("openEvriScreeningBtn");
  if(openEvriScreeningBtn){
    openEvriScreeningBtn.addEventListener("click", ()=>{
      state.evriScreeningOpen = true;
      render();
    });
  }
  const resetEvriScreeningBtn = document.getElementById("resetEvriScreeningBtn");
  if(resetEvriScreeningBtn){
    resetEvriScreeningBtn.addEventListener("click", ()=>{
      state.evriScreeningOpen = false;
      state.evriAdditionalSelection = "";
      state.evriSelectedProhibitedKey = null;
      state.evriAdditionalBlocked = false;
      state.evriScreeningComplete = false;
      state.evriLossOnlySelected = false;
      state.evriNoCompSelected = false;
      state.coverLossOnlyKeys = new Set();
      state.coverNoCompKeys = new Set();
      render();
    });
  }
}

function renderBasketAndPay(){
  const service = selectedService();
  const total = basketTotal();

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Add to Basket and Pay (KIOSK-417)</h1>
        <p class="subtitle">Review basket, then take payment and finalise transaction.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">shopping_cart</span> Basket and pay</span>
    </div>

    <div class="formRow">
      <div class="card">
        <h3>Review basket (KIOSK-419)</h3>
        ${service ? `
          <div class="helpNote">
            <strong>Service:</strong> ${escapeHtml(service.name)}<br/>
            <strong>Base price:</strong> £${calculateServicePrice(service).toFixed(2)}<br/>
            <strong>Proof of delivery:</strong> ${state.proofOfDelivery ? "Yes (£1.50)" : "No"}<br/>
            <strong>Total:</strong> £${total.toFixed(2)}
          </div>
        ` : `
          <div class="banner danger show" style="display:block;">No service selected.</div>
        `}
      </div>
      <div class="card">
        <h3>Take payment (KIOSK-420)</h3>
        <div class="choiceRow3" id="paymentChoices">
          <button type="button" class="choiceBtn ${state.paymentMethod==="card"?"active":""}" data-value="card"><span>Card</span></button>
          <button type="button" class="choiceBtn ${state.paymentMethod==="applepay"?"active":""}" data-value="applepay"><span>Apple Pay</span></button>
          <button type="button" class="choiceBtn ${state.paymentMethod==="googlepay"?"active":""}" data-value="googlepay"><span>Google Pay</span></button>
        </div>
        <button class="btn primary" id="capturePaymentBtn" style="margin-top:12px;">
          <span class="material-symbols-outlined">payments</span> Take payment and finalise
        </button>
        ${state.paymentComplete ? `
          <div class="banner ok show" style="display:block; margin-top:10px;">Payment captured successfully.</div>
        ` : ""}
      </div>
    </div>
  `;

  document.querySelectorAll("#paymentChoices .choiceBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.paymentMethod = btn.dataset.value || "";
      document.querySelectorAll("#paymentChoices .choiceBtn").forEach(b=>b.classList.toggle("active", b===btn));
    });
  });

  document.getElementById("capturePaymentBtn").addEventListener("click", ()=>{
    if(!state.paymentMethod){
      alert("Select a payment method first.");
      return;
    }
    state.paymentComplete = true;
    if(!state.transactionRef){
      state.transactionRef = `TX-${Math.random().toString(36).slice(2,8).toUpperCase()}`;
    }
    render();
  });
}

function renderPrintAndConfirm(){
  const service = selectedService();
  const total = basketTotal();
  const dest = state.destination === "uk" ? "UK Inland" : "International";

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Print and Confirm (KIOSK-421)</h1>
        <p class="subtitle">Print label(s) and show transaction summary/confirmation.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">print</span> Print and confirm</span>
    </div>

    <div class="formRow">
      <div class="card">
        <h3>Print postage label(s) (KIOSK-422)</h3>
        <button class="btn primary" id="printLabelsBtn">
          <span class="material-symbols-outlined">print</span> Print label now
        </button>
        ${state.labelsPrinted ? `
          <div class="banner ok show" style="display:block; margin-top:10px;">Labels printed successfully.</div>
        ` : ""}
      </div>
      <div class="card">
        <h3>Transaction summary / confirmation CoP (KIOSK-423)</h3>
        <div class="helpNote">
          <strong>Reference:</strong> ${escapeHtml(state.transactionRef || "Pending")}<br/>
          <strong>Service:</strong> ${escapeHtml(service ? service.name : "Not selected")}<br/>
          <strong>Destination:</strong> ${dest}<br/>
          <strong>Total paid:</strong> £${total.toFixed(2)}<br/>
          <strong>Recipient postcode:</strong> ${escapeHtml(state.recipientPostcode || "—")}
        </div>
      </div>
    </div>
  `;

  document.getElementById("printLabelsBtn").addEventListener("click", ()=>{
    state.labelsPrinted = true;
    if(!state.transactionRef){
      state.transactionRef = `TX-${Math.random().toString(36).slice(2,8).toUpperCase()}`;
    }
    render();
  });
}

function renderSummary(){
  const dest = state.destination === "uk" ? "UK" : (state.destination === "intl" ? "International" : "Not set");
  const fmt = ({letter:"Letter", large_letter:"Large letter", parcel:"Parcel"})[state.format] || "Not set";
  const service = selectedService();
  const profile = service ? (service.profile === "royal_mail" ? "Royal Mail rules" : "EVRi/DPD rules") : "Not selected";

  const restrictedLabels = [...state.restrictedKeys].map(k => RESTRICTED.find(x=>x.key===k)?.label).filter(Boolean);
  const lossLabels = [...state.coverLossOnlyKeys].map(k => LOSS_ONLY.find(x=>x.key===k)?.label).filter(Boolean);
  const ncLabels = [...state.coverNoCompKeys].map(k => NO_COMP.find(x=>x.key===k)?.label).filter(Boolean);
  const rmSelected = RM_FILTER.find(x=>x.key===state.rmSelectedKey)?.label || (state.rmOtherSelected ? "Other / not listed" : "None");
  const rmNi = rmNIStatus();
  const speedDisplay = isDomesticJourney() ? deliveryPreferenceLabel(state.deliverySpeed || "") : "Skipped (International)";
  const lastSpeedAudit = [...state.auditEvents].reverse().find(entry => entry.eventType === "delivery_speed_selected");

  screen.innerHTML = `
    <div class="stepHeader">
      <div>
        <h1>Summary</h1>
        <p class="subtitle">Captured data and screening outcomes.</p>
      </div>
      <span class="pill"><span class="material-symbols-outlined">fact_check</span> Prototype end</span>
    </div>

    <div class="summary">
      <div class="card">
        <h3>Item details</h3>
        <div style="margin-top:10px;">
          <span class="tag"><span class="material-symbols-outlined">scale</span> ${escapeHtml(state.weightG || "—")} g</span>
          <span class="tag"><span class="material-symbols-outlined">straighten</span> ${fmt}</span>
          <span class="tag"><span class="material-symbols-outlined">public</span> ${dest}</span>
          <span class="tag"><span class="material-symbols-outlined">inventory</span> ${profile}</span>
        </div>
        <div class="helpNote">Next in the real journey: product/service filtering & pricing.</div>
      </div>

      <div class="card">
        <h3>Screening flags</h3>

        ${state.rmBlockedKey ? `
          <div class="banner danger show" style="display:block;">
            Royal Mail blocked selection: ${escapeHtml(RM_FILTER.find(x=>x.key===state.rmBlockedKey)?.label || state.rmBlockedKey)}.
          </div>
        ` : `
          <div class="banner ok show" style="display:block;">
            Royal Mail dangerous goods filter completed.
          </div>
        `}
        ${service && service.profile === "evri_dpd" ? `
          ${state.evriAdditionalBlocked ? `
            <div class="banner danger show" style="display:block; margin-top:8px;">
              EVRi/DPD additional screening: prohibited item selected.
            </div>
          ` : `
            <div class="banner ok show" style="display:block; margin-top:8px;">
              EVRi/DPD additional screening passed.
            </div>
          `}
        ` : ""}

        <div style="margin-top:10px;">
          <div class="helpNote">
            <strong>RM filter selection:</strong> ${escapeHtml(rmSelected)}<br/>
            <strong>RM condition checks:</strong> ${state.rmOtherSelected ? "Not required (Other selected)" : (state.rmConditionSatisfied ? "Completed" : "Not completed")}<br/>
            <strong>RM GB to NI status:</strong> ${rmNi.ok ? "Clear" : escapeHtml(rmNi.message || "Blocked or incomplete")}<br/>
            <strong>Delivery preference:</strong> ${escapeHtml(speedDisplay)}<br/>
            <strong>Delivery preference audit:</strong> ${lastSpeedAudit ? `${escapeHtml(lastSpeedAudit.at)} (${escapeHtml(lastSpeedAudit.deliverySpeedLabel || lastSpeedAudit.deliverySpeed || "Unknown")})` : "No speed event logged"}<br/>
            <strong>EVRi/DPD loss-only flag:</strong> ${state.evriLossOnlySelected ? "Yes" : "No"}<br/>
            <strong>EVRi/DPD no-comp flag:</strong> ${state.evriNoCompSelected ? "Yes" : "No"}<br/>
            <strong>Legacy restricted flags:</strong> ${restrictedLabels.length ? escapeHtml(restrictedLabels.join(", ")) : "None"} / ${lossLabels.length ? escapeHtml(lossLabels.join(", ")) : "None"} / ${ncLabels.length ? escapeHtml(ncLabels.join(", ")) : "None"}
          </div>
        </div>
      </div>
    </div>
  `;
}

/* ---------------------------
   Tile creation + wiring
---------------------------- */
function tileEl(item, mode, multi=false){
  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "tile";
  btn.dataset.key = item.key;
  btn.dataset.mode = mode;
  btn.dataset.multi = multi ? "1" : "0";

  if(item.blank){
    btn.style.visibility = "hidden";
    btn.style.pointerEvents = "none";
    return btn;
  }
  btn.innerHTML = `
    <div class="icon"><span class="material-symbols-outlined">${item.icon || "block"}</span></div>
    <div>
      <div class="label">${escapeHtml(item.label)}</div>
    </div>
  `;
  return btn;
}

// Prohibited: tap = immediate hard-stop panel (still shows details)
function wireProhibitedDetails(list){
  const details = document.getElementById("pDetails");
  const title = document.getElementById("pDetailsTitle");
  const text = document.getElementById("pDetailsText");
  const close = document.getElementById("pClose");
  const back = document.getElementById("pStopBack");
  const reset = document.getElementById("pStopReset");

  document.querySelectorAll('.tile[data-mode="p"]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const key = btn.dataset.key;
      const item = list.find(x=>x.key===key);
      if(!item) return;

      // highlight single
      document.querySelectorAll('.tile[data-mode="p"]').forEach(b=>b.classList.remove("selected"));
      btn.classList.add("selected");

      if(key === "other_not_listed"){
        state.prohibitedKey = null;
        state.prohibitedOtherSelected = true;
        details.classList.remove("show");
        return;
      }

      state.prohibitedOtherSelected = false;
      state.prohibitedKey = key;

      title.innerHTML = `
        <div class="icon"><span class="material-symbols-outlined">${item.icon || "block"}</span></div>
        ${escapeHtml(item.label)}
      `;
      text.textContent = item.details || "";
      details.classList.add("show");
    });
  });

  close.addEventListener("click", ()=>{
    state.prohibitedKey = null;
    state.prohibitedOtherSelected = false;
    details.classList.remove("show");
    document.querySelectorAll('.tile[data-mode="p"]').forEach(b=>b.classList.remove("selected"));
  });
  back.addEventListener("click", ()=> navigateToStep(1));
  reset.addEventListener("click", ()=> resetAll());
}

// Multi-select tiles: tap toggles selection + opens details panel
function wireMultiSelectDetails(mode, list, setRef, detailsMode="r"){
  const details = document.getElementById(`${detailsMode}Details`) || document.getElementById("cDetails");
  const title = document.getElementById(`${detailsMode}DetailsTitle`) || document.getElementById("cDetailsTitle");
  const text = document.getElementById(`${detailsMode}DetailsText`) || document.getElementById("cDetailsText");
  const close = document.getElementById(`${detailsMode}Close`) || document.getElementById("cClose");

  document.querySelectorAll(`.tile[data-mode="${mode}"]`).forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const key = btn.dataset.key;
      const item = list.find(x=>x.key===key);
      if(!item) return;

      if(setRef.has(key)) setRef.delete(key);
      else setRef.add(key);

      btn.classList.toggle("selected", setRef.has(key));

      title.innerHTML = `
        <div class="icon"><span class="material-symbols-outlined">${item.icon || "block"}</span></div>
        ${escapeHtml(item.label)}
      `;
      text.textContent = item.details || "";
      details.classList.add("show");
    });
  });

  // Close handler is wired in renderRestricted / renderCoverLimits for shared panel cases
}

/* ---------------------------
   Navigation rules
---------------------------- */
function canContinue(){
  if(state.step === 0) return false;
  if(state.step === 1) return !!state.weightG && !!state.destination;

  if(state.step === 2){
    if(state.rmBlockedKey) return false;
    if(state.rmOtherSelected) return true;
    if(!state.rmSelectedKey) return false;
    const rule = currentRMRule();
    if(!rule) return false;
    const requirements = rmRuleRequirements(rule);
    if(!requirements.checks.length && !requirements.limits.length){
      return true;
    }
    return !!state.rmConditionSatisfied;
  }

  if(state.step === 3){
    const speedOk = !isDomesticJourney() || isValidDomesticDeliveryPreference(state.deliverySpeed);
    return !!state.format && numericValue(state.declaredValue) > 0 && speedOk;
  }

  if(state.step === 4){
    if(state.evriScreeningOpen) return false;
    const hasAddresses = !!state.recipientPostcode && !!state.recipientAddress && !!state.senderPostcode && !!state.senderAddress;
    const hasService = !!state.selectedServiceId;
    const needsNI = state.destination === "uk" && isBTPostcode(state.recipientPostcode);
    const niOk = !needsNI || (!!state.niCustomsReference && !!state.niSpsCategory && !!state.niPrivateIndividual && state.niCustomsConfirmed);
    const rmNiOk = rmNIStatus().ok;
    const evriOk = state.productProfile !== "evri_dpd" || (state.evriScreeningComplete && !state.evriAdditionalBlocked);
    return hasAddresses && hasService && niOk && rmNiOk && evriOk;
  }

  if(state.step === 5){
    return !!state.paymentComplete;
  }

  return true;
}

function next(){
  if(state.step === 6){
    resetAll();
    return;
  }

  if(!canContinue()){
    if(state.step === 2){
      if(state.rmBlockedKey){
        alert("This item is not allowed for the selected destination under Royal Mail rules.");
        return;
      }
      const rule = currentRMRule();
      if(rule){
        const requirements = rmRuleRequirements(rule);
        if(requirements.checks.length || requirements.limits.length){
          alert("Complete the Royal Mail category conditions before continuing.");
          return;
        }
      }
      alert("Please select a Royal Mail category or choose 'Other / not listed'.");
      return;
    }
    if(state.step === 3){
      alert(isDomesticJourney()
        ? "Confirm format, enter item value, and choose delivery speed preference before continuing."
        : "Confirm format and enter item value before continuing.");
      return;
    }
    if(state.step === 4){
      if(state.evriScreeningOpen){
        alert("Complete or close the EVRi/DPD screening screens before continuing.");
        return;
      }
      if(state.productProfile === "evri_dpd" && state.evriAdditionalBlocked){
        alert("EVRi/DPD prohibited item selected. Choose a different service or clear the screening result.");
        return;
      }
      const niStatus = rmNIStatus();
      if(!niStatus.ok){
        alert(niStatus.message || "Complete Northern Ireland checks for the selected Royal Mail category.");
        return;
      }
      alert("Complete address details, NI/Windsor checks (if applicable), select a service, and finish carrier-specific screening.");
      return;
    }
    if(state.step === 5){
      alert("Take payment to finalise the transaction before continuing.");
      return;
    }
    alert("Please complete this step before continuing.");
    return;
  }

  if(state.step === 4){
    state.basketAdded = true;
  }

  if(state.step < stepCount()) navigateToStep(state.step + 1);
}

function back(){
  if(state.step > 0) navigateToStep(state.step - 1);
}

function resetAll(){
  state.step = 0;
  state.weightG = "";
  state.format = "";
  state.destination = "";
  state.productProfile = "royal_mail";
  state.quickDemoMode = false;
  state.prohibitedKey = null;
  state.prohibitedOtherSelected = false;
  state.rmSelectedKey = null;
  state.rmBlockedKey = null;
  state.rmOtherSelected = false;
  state.rmConditionChecks = {};
  state.rmConditionValues = {};
  state.rmConditionSatisfied = false;
  state.evriScreeningOpen = false;
  state.evriAdditionalSelection = "";
  state.evriSelectedProhibitedKey = null;
  state.evriAdditionalBlocked = false;
  state.evriScreeningComplete = false;
  state.evriLossOnlySelected = false;
  state.evriNoCompSelected = false;
  state.rmAdvisoryKeys = new Set();
  state.restrictedKeys = new Set();
  state.coverLossOnlyKeys = new Set();
  state.coverNoCompKeys = new Set();
  state.manualWeightEditOpen = false;
  state.declaredValue = "";
  state.contentDescription = "";
  state.deliverySpeed = "";
  state.recipientPostcode = "";
  state.recipientAddress = "";
  state.senderPostcode = "";
  state.senderAddress = "";
  state.niCustomsConfirmed = false;
  state.niCustomsReference = "";
  state.niSpsCategory = "";
  state.niPrivateIndividual = "";
  state.rmNiPerishableRoute = "";
  state.rmNiPlantCertRef = "";
  state.proofOfDelivery = false;
  state.selectedServiceId = "";
  state.basketAdded = false;
  state.paymentMethod = "";
  state.paymentComplete = false;
  state.labelsPrinted = false;
  state.transactionRef = "";
  state.auditEvents = [];
  render();
}

/* ---------------------------
   Hook up chrome buttons
---------------------------- */
document.getElementById("backBtn").addEventListener("click", back);
document.getElementById("nextBtn").addEventListener("click", next);
document.getElementById("resetBtn").addEventListener("click", resetAll);
document.getElementById("cancelBtn").addEventListener("click", ()=> alert("Cancel – prototype action"));
document.getElementById("helpBtn").addEventListener("click", ()=> alert("Help – prototype action"));

render();
</script>
</body>
</html>
